(function(){"use strict";var t,e=function(t,e){return function(){return t.apply(e,arguments)}};window.ut=window.ut||{},window.ut.tools=window.ut.tools||{},window.ut.tools.conceptmapper=window.ut.tools.conceptmapper||{},t=function(t,e,o){return{restrict:"E",template:"",replace:!1,link:function(n,i,r){var a,l,s,c;return s=t,c=e,a=null,l=function(){var t;return a&&a.remove(),a=$("<div class='conceptMap'></div>"),i.append(a),t=new window.ut.tools.conceptmapper.ConceptMapper(s,c,o,a),t.modelLoadedIntoView()},n.$watch("conceptMapModel",function(){return s=n.conceptMapModel,l()})}}},window.ut.tools.conceptmapper.ConceptMapAngularApp.directive("conceptMap".toLowerCase(),["conceptMapModel","configurationModel","languageHandler",t]),window.ut.tools.conceptmapper.ConceptMapper=function(){function t(t,o,n,i){this.conceptMapModel=t,this.configurationModel=o,this.languageHandler=n,this.root=i,this.modelLoadedIntoView=e(this.modelLoadedIntoView,this),this.deleteAllFromView=e(this.deleteAllFromView,this),this.changeConceptColorInView=e(this.changeConceptColorInView,this),this.removeRelationFromView=e(this.removeRelationFromView,this),this.addRelationToView=e(this.addRelationToView,this),this.removeConceptFromView=e(this.removeConceptFromView,this),this.addConceptToView=e(this.addConceptToView,this),this.logAddRelation=e(this.logAddRelation,this),this.logRemoveRelation=e(this.logRemoveRelation,this),this.logRemoveConcept=e(this.logRemoveConcept,this),this.onBlurHandlerInjectParagraph=e(this.onBlurHandlerInjectParagraph,this),this.onBlurHandlerInjectRelation=e(this.onBlurHandlerInjectRelation,this),this.onClickHandlerInjectCombobox=e(this.onClickHandlerInjectCombobox,this),this.appendMenuButton=e(this.appendMenuButton,this),this.onClickHandlerInjectTextarea=e(this.onClickHandlerInjectTextarea,this),this.onClickHandlerConnectionLabel=e(this.onClickHandlerConnectionLabel,this),this.onClickEdgeHandler=e(this.onClickEdgeHandler,this),this.setConceptLinkMode=e(this.setConceptLinkMode,this),this.setConceptNodeMode=e(this.setConceptNodeMode,this),this._initJsPlumb=e(this._initJsPlumb,this),this._initDnD=e(this._initDnD,this),this._init=e(this._init,this),this.configure=e(this.configure,this),this.getModel=e(this.getModel,this),this.debug=!1,this.actionLogger=this.conceptMapModel.getActionLogger(),this.model=this.conceptMapModel,this.model.addListener("contentCleared",this.deleteAllFromView),this.model.addListener("addConcept",this.addConceptToView),this.model.addListener("removeConcept",this.removeConceptFromView),this.model.addListener("changeConceptContent",this.changeConceptContentInView),this.model.addListener("changeConceptColor",this.changeConceptColorInView),this.model.addListener("changeConceptPosition",this.changeConceptPositionInView),this.model.addListener("addRelation",this.addRelationToView),this.model.addListener("removeRelation",this.removeRelationFromView),this.model.addListener("changeRelationContent",this.changeRelationContentInView),this.model.addListener("modelLoaded",this.modelLoadedIntoView),this.model.addListener("contentLoaded",this.modelLoadedIntoView),this.configurationModel.addListener("modelChanged",this.configure),this.templateSource=$(".ut_tools_conceptmapper_template"),this.linkButton=$("#ut_tools_conceptmapper_linkButton"),this.toolbar=$("#ut_tools_conceptmapper_toolbar_container"),$("#ut_tools_conceptmapper_toolbar_title").text(this.languageHandler.getMsg("ut_tools_conceptmapper_toolbar_title")),$(".ut_tools_conceptmapper_hint").text(this.languageHandler.getMsg("ut_tools_conceptmapper_placeholder")),$("#ut_tools_conceptmapper_concept_template_text p").text(this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text")),$("#ut_tools_conceptmapper_concept_template_selector p").text(this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_selector")),$("#ut_tools_conceptmapper_concept_template_text").attr("title",this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_tooltip")),$("#ut_tools_conceptmapper_concept_template_selector").attr("title",this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_tooltip")),this.linkButton.attr("title",this.languageHandler.getMsg("ut_tools_conceptmapper_linkButton")),this.colorClasses=["ut_tools_conceptmapper_blue","ut_tools_conceptmapper_yellow","ut_tools_conceptmapper_green","ut_tools_conceptmapper_red","ut_tools_conceptmapper_orange"],this.LINK_MODE="link_mode",this.NODE_MODE="node_mode",this.mode=this.NODE_MODE,this.isCurrentlyLogging=!0,this.sourceNode=void 0,this.targetNode=void 0,this.editingLabel=void 0,this.configure(),this._init(),this.isCurrentlyLogging&&null!=this.actionLogger&&this.actionLogger.logApplicationStarted()}return t.prototype.getModel=function(){return this.model},t.prototype.configure=function(){return this._initJsPlumb()},t.prototype._init=function(){return this.linkButton.click(function(t){return function(){return t.mode===t.LINK_MODE?t.setMode(t.NODE_MODE):t.setMode(t.LINK_MODE)}}(this)),this.templateSource.click(function(t){return function(){return t.setMode(t.NODE_MODE)}}(this)),this._initDnD(),this._initJsPlumb()},t.prototype._initDnD=function(){return this.templateSource.draggable({helper:"clone",cursor:"move",cursorAt:{top:5,left:5},containment:"#ut_tools_coot",start:function(t){return function(){return t.setMode(t.NODE_MODE)}}(this)}),this.root.bind("dragover",function(t){return!1}),this.root.droppable(),this.root.bind("drop",function(t){return function(e,o){var n,i,r;return(!o||!$(o.draggable).hasClass("ut_tools_hypothesis_condition"))&&(o&&$(o.draggable).hasClass("ut_tools_conceptmapper_template")?(i=void 0,t.debug&&console.log("Concept template dropped. Clone and add to map."),$(o.draggable).hasClass("ut_tools_conceptmapper_conceptTextarea")?i={id:ut.commons.utils.generateUUID(),content:$(o.draggable).text(),x:o.position.left+19,y:o.position.top+36,type:"ut_tools_conceptmapper_conceptTextarea",colorClass:"ut_tools_conceptmapper_blue"}:$(o.draggable).hasClass("ut_tools_conceptmapper_conceptSelector")&&(i={id:ut.commons.utils.generateUUID(),content:$(o.draggable).text(),x:o.position.left+19,y:o.position.top+36,type:"ut_tools_conceptmapper_conceptSelector",colorClass:"ut_tools_conceptmapper_blue"})):e.originalEvent.dataTransfer?i={id:ut.commons.utils.generateUUID(),content:e.originalEvent.dataTransfer.getData("Text"),x:e.originalEvent.clientX-5,y:e.originalEvent.clientY-5,type:"ut_tools_conceptmapper_conceptTextarea",colorClass:"ut_tools_conceptmapper_blue"}:o&&$(o.draggable).hasClass("ut_tools_conceptmapper_concept")&&(t.model.changeConceptPosition($(o.draggable).attr("id"),o.position.left,o.position.top),r={objectType:"concept",id:$(o.draggable).attr("id"),x:o.position.left,y:o.position.top},t.isCurrentlyLogging&&null!=t.actionLogger&&t.actionLogger.logChange(r)),null!=i&&(t.model.addConcept(i),n=i,n.objectType="concept",t.isCurrentlyLogging&&null!=t.actionLogger&&t.actionLogger.logAdd(n)),!1)}}(this)),this.toolbar.droppable(),this.toolbar.bind("drop",function(t){return function(e,o){var n,i,r,a,l,s,c;if($(o.draggable).hasClass("ut_tools_conceptmapper_template"));else{if($(o.draggable).hasClass("ut_tools_conceptmapper_concept"))return n=$(o.draggable).attr("id"),t.model.removeConcept(n),t.logRemoveConcept(n);if($(o.draggable).hasClass("_jsPlumb_overlay")){for(l=jsPlumb.getConnections(),c=[],r=0,a=l.length;r<a;r++)i=l[r],$(o.draggable).attr("id")===i.getOverlay("label").canvas.id?(s=i.getOverlay("label").component.id,c.push(t.model.removeRelation(s))):c.push(void 0);return c}}}}(this))},t.prototype._initJsPlumb=function(){var t;return t={Connector:["Straight"],ConnectorZIndex:0,DragOptions:{cursor:"pointer",zIndex:2e3},PaintStyle:{strokeStyle:"#92D6E3",lineWidth:2},EndpointStyle:{},Anchor:["Perimeter",{shape:"Ellipse"}],ConnectionOverlays:[["Label",{label:"",location:.5,id:"label"}]],Detachable:!1,Reattach:!1},jsPlumb.importDefaults(t),jsPlumb.setRenderMode(jsPlumb.SVG),jsPlumb.unbind("jsPlumbConnection"),jsPlumb.bind("jsPlumbConnection",function(t){return function(e){return e.connection.getOverlay("label").bind("click",t.onClickHandlerConnectionLabel)}}(this))},t.prototype.setMode=function(t){if(t===this.mode);else switch(t){case this.NODE_MODE:return this.root.find(".ut_tools_conceptmapper_concept").each(function(t){return function(e,o){return t.setConceptNodeMode(o)}}(this)),this.templateSource.removeClass("ut_tools_conceptmapper_lowLight"),this.linkButton.removeClass("pressedButton"),this.linkButton.addClass("activeButton"),jsPlumb.unmakeEverySource(),jsPlumb.unmakeEveryTarget(),$(this.sourceNode).removeClass("highlight_concept"),$(this.targetNode).removeClass("highlight_concept"),this.sourceNode=void 0,this.targetNode=void 0,this.mode=t;case this.LINK_MODE:return this.root.find(".ut_tools_conceptmapper_concept").each(function(t){return function(e,o){return t.setConceptLinkMode(o)}}(this)),this.templateSource.addClass("ut_tools_conceptmapper_lowLight"),this.root.find(".ut_tools_conceptmapper_concept").css("opacity","1.0"),this.linkButton.addClass("pressedButton"),this.linkButton.removeClass("activeButton"),this.mode=t;default:return console.warn("ConceptMapper.setMode: unrecognized mode "+t+" doing nothing.")}},t.prototype.setConceptNodeMode=function(t){return $(t).draggable("enable")},t.prototype.setConceptLinkMode=function(t){return $(t).draggable("disable"),jsPlumb.makeSource(t,{}),jsPlumb.makeTarget(t,{dropOptions:{hoverClass:"jsPlumbHover"},beforeDrop:function(t){return function(e){var o,n,i,r,a;if(e.sourceId===e.targetId)return t.debug&&console.log("Creating edges between same source and target is disallowed."),!1;if(o=t.model.getRelationsBetween(e.sourceId,e.targetId),o.length){for(t.debug&&console.log("An edge between concepts already exists -> delete it (instead of create a new one)."),n=0,i=o.length;n<i;n++)a=o[n],t.model.removeRelation(a.id);return!1}return t.debug&&console.log("All conditions met, create a new edge."),r={id:ut.commons.utils.generateUUID(),source:e.sourceId,target:e.targetId,content:t.configurationModel.relations.getValue(0)},t.model.addRelation(r),t.logAddRelation(r),!1}}(this)})},t.prototype.onClickEdgeHandler=function(t){var e,o,n,i;if(void 0===this.sourceNode?(this.sourceNode=t.currentTarget,$(this.sourceNode).toggleClass("highlight_concept")):t.currentTarget===this.sourceNode?($(t.currentTarget).toggleClass("highlight_concept"),this.sourceNode=void 0):this.targetNode=t.currentTarget,void 0!==this.sourceNode&&void 0!==this.targetNode)return n=$(this.sourceNode).attr("id"),i=$(this.targetNode).attr("id"),e=this.model.getRelationsBetween(n,i),e.length?this.model.removeRelationsBetween(n,i):(this.debug&&console.log("Connection does not exist -> create."),o={id:ut.commons.utils.generateUUID(),source:n,target:i,content:this.configurationModel.relations.getValue(0)},this.model.addRelation(o),this.logAddRelation(o)),$(this.sourceNode).removeClass("highlight_concept"),$(this.targetNode).removeClass("highlight_concept"),this.sourceNode=void 0,this.targetNode=void 0,jsPlumb.repaintEverything()},t.prototype.onClickHandlerConnectionLabel=function(t){var e;if(!$(t.canvas).data("dragging"))return $("#"+t.canvas.id).find("input").length?$("#"+t.canvas.id).find("input").autocomplete("search",""):(this.editingLabel=t,e=$("<input/>").val(this.editingLabel.getLabel()),this.labelBeforeEdit=this.editingLabel.getLabel(),e.autocomplete({source:this.configurationModel.relations.getValues(),minLength:0}),$("#"+t.canvas.id).text(""),e.addClass("_jsPlumb_overlay"),e.css("text-align","left"),$("#"+t.canvas.id).css("padding","0px"),$("#"+t.canvas.id).append(e),e.blur(this.onBlurHandlerInjectRelation),e.autocomplete("search",""),e.focus(),jsPlumb.repaintEverything())},t.prototype.onClickHandlerInjectTextarea=function(t){var e,o;return this.mode===this.LINK_MODE?this.onClickEdgeHandler(t):$(t.target).is("p")?(this.selectedConcept=$(t.currentTarget).attr("id"),e=$(t.target),e.text()===this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text")?(o=$("<textarea/>").val(""),o.attr("placeholder",this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text"))):o=$("<textarea/>").val(e.text()),this.contentBeforeEdit=e.text(),o.autogrow(),e.replaceWith(o),o.on("blur",this.onBlurHandlerInjectParagraph),this.appendMenuButton(t.currentTarget),o.focus()):void 0},t.prototype.appendMenuButton=function(t){var e,o,n,i,r,a,l,s,c;for(s=$('<i class="fa fa-gear ut_tools_conceptmapper_menubutton"></i>'),l=[],c=this.colorClasses,r=i=0,a=c.length;i<a;r=++i)e=c[r],o={"&nbsp":{className:e,onclick:function(t){return function(o,n){var i,r,a,l;for(i=$(o).attr("class").split(" "),r=0,a=i.length;r<a;r++)if(e=i[r],$.inArray(e,t.colorClasses)>-1){t.model.changeConceptColor(t.selectedConcept,e),l={objectType:"concept",id:t.selectedConcept,colorClass:e},t.isCurrentlyLogging&&null!=t.actionLogger&&t.actionLogger.logChange(l);break}}}(this)}},l.push(o);return l.push($.contextMenu.separator),n={},n[this.languageHandler.getMsg("ut_tools_conceptmapper_delete")]=function(t){return function(e,o){var n;n=$("#"+t.selectedConcept).attr("id"),t.model.removeConcept(n),t.logRemoveConcept(n)}}(this),l.push(n),$(s).contextMenu(l,{leftClick:!0,rightClick:!0}),$(t).append(s),$(s).show()},t.prototype.onClickHandlerInjectCombobox=function(t){var e,o;return this.mode===this.LINK_MODE?this.onClickEdgeHandler(t):$(t.target).is("div")?void 0:(this.selectedConcept=$(t.currentTarget).attr("id"),e=$(t.target),e.text()===this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text")?(o=$("<input/>").val(""),o.attr("placeholder",this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text"))):o=$("<input/>").val(e.text()),this.contentBeforeEdit=e.text(),o.autocomplete({source:this.configurationModel.concepts.getValues(),minLength:0}),e.replaceWith(o),o.blur(this.onBlurHandlerInjectParagraph),o.autocomplete("search",""),this.appendMenuButton(t.currentTarget),o.focus())},t.prototype.onBlurHandlerInjectRelation=function(t){var e,o;return e=nl2br($(t.target).val()),$(t.target).parent().text(this.editingLabel.getLabel()),$(t.target).remove(),e!==this.labelBeforeEdit&&(this.model.changeRelationContent(this.editingLabel.component.id,e),o={objectType:"relation",id:this.editingLabel.component.id,content:e},this.isCurrentlyLogging&&null!=this.actionLogger&&this.actionLogger.logChange(o)),$("#"+this.editingLabel.canvas.id).css("padding","0.25em 0.5em 0.25em 0.5em"),this.labelBeforeEdit="",this.editingLabel=void 0},t.prototype.onBlurHandlerInjectParagraph=function(t){var e,o,n,i,r;return o=$(t.target),n=nl2br(o.val()),""===n&&(n=this.languageHandler.getMsg("ut_tools_conceptmapper_concept_template_text")),e=o.parent().attr("id"),r=$("<p/>").html(""),$(".ut_tools_conceptmapper_menubutton").remove(),n!==this.contentBeforeEdit?(o.replaceWith(r),this.model.changeConceptContent(e,n),i={objectType:"concept",id:e,content:n},this.isCurrentlyLogging&&null!=this.actionLogger&&this.actionLogger.logChange(i)):(r=$("<p/>").html(n),o.replaceWith(r)),this.contentBeforeEdit="",jsPlumb.repaintEverything()},t.prototype.logRemoveConcept=function(t){var e;if(e={objectType:"concept",id:t},this.isCurrentlyLogging&&null!=this.actionLogger)return this.actionLogger.logRemove(e)},t.prototype.logRemoveRelation=function(t){var e;if(e={objectType:"relation",id:t},this.isCurrentlyLogging&&null!=this.actionLogger)return this.actionLogger.logRemove(e)},t.prototype.logAddRelation=function(t){var e;if(e={objectType:"relation",id:t.id,content:t.content,source:t.source,target:t.target},this.isCurrentlyLogging&&null!=this.actionLogger)return this.actionLogger.logAdd(e)},t.prototype.addConceptToView=function(t){var e;return e=$("<div>"),e.attr("id",t.id),e.addClass("ut_tools_conceptmapper_concept"),e.append($("<p/>").html(nl2br(t.content))),jsPlumb.draggable(e,{cursor:"move",revert:"invalid",iframeFix:!0,delay:50,containment:"#ut_tools_conceptmapper_root"}),e.css("position","absolute"),e.css("top",t.y),e.css("left",t.x),e.addClass(t.type),"ut_tools_conceptmapper_conceptTextarea"===t.type?e.click(this.onClickHandlerInjectTextarea):e.click(this.onClickHandlerInjectCombobox),this.root.append(e),this.changeConceptColorInView(t.id,t.colorClass),this.mode===this.LINK_MODE?this.setConceptLinkMode(e):this.mode===this.LINK_MODE?this.setConceptNodeMode(e):void 0},t.prototype.removeConceptFromView=function(t){var e;if(e=$("#"+t),null!=e)return jsPlumb.detachAllConnections(e),$(e).fadeOut(300,function(t){return function(){return $(e).remove()}}(this))},t.prototype.addRelationToView=function(t){var e;return e=jsPlumb.connect({source:t.source,target:t.target,cssClass:"connection"}),e.idPrefix="",e.id=t.id,null==t.content&&(t.content=" "),e.getOverlay("label").setLabel(t.content),e.addOverlay(["PlainArrow",{location:.85,width:10,height:8,id:"arrow"}]),$(e.getOverlay("label").getElement()).draggable({cursor:"move",revert:"invalid",iframeFix:!0,delay:50,containment:"#ut_tools_conceptmapper_root",start:function(t){return function(t,e){return $(e.helper.context).data("dragging",!0)}}(this),stop:function(t){return function(t,e){return setTimeout(function(){return $(e.helper.context).data("dragging",!1)},300),jsPlumb.repaintEverything()}}(this)}),e.getOverlay("label").addClass("ut_tools_conceptmapper_label"),jsPlumb.repaintEverything()},t.prototype.removeRelationFromView=function(t){var e,o,n,i;for(this.logRemoveRelation(t),i=jsPlumb.getConnections(),o=0,n=i.length;o<n;o++)if(e=i[o],e.id===t){jsPlumb.detach(e);break}return jsPlumb.repaintEverything()},t.prototype.changeConceptContentInView=function(t,e){return $("#"+t+" p").html(e),jsPlumb.repaintEverything()},t.prototype.changeConceptPositionInView=function(t,e,o){return $("#"+t).css("left",e),$("#"+t).css("top",o),jsPlumb.repaintEverything()},t.prototype.changeConceptColorInView=function(t,e){var o,n,i,r,a;if(o=$("#"+t),null!=o){if(null!=e){for(a=this.colorClasses,n=0,i=a.length;n<i;n++)r=a[n],o.removeClass(r);return o.addClass(e)}return o.addClass("ut_tools_conceptmapper_blue")}},t.prototype.changeRelationContentInView=function(t,e){var o,n,i,r;for(r=jsPlumb.getConnections(),n=0,i=r.length;n<i;n++)if(o=r[n],o.id===t){o.getOverlay("label").setLabel(e);break}return jsPlumb.repaintEverything()},t.prototype.deleteAllFromView=function(){var t,e,o,n;for(n=jsPlumb.getConnections(),e=0,o=n.length;e<o;e++)t=n[e],jsPlumb.detach(t);return jsPlumb.repaintEverything(),this.root.find(".ut_tools_conceptmapper_concept").each(function(t){return function(t,e){return $(e).remove()}}(this))},t.prototype.modelLoadedIntoView=function(){var t,e,o,n,i,r,a,l;for(this.setMode(this.NODE_MODE),this.deleteAllFromView(),r=this.model.getResourceContent().concepts,e=0,n=r.length;e<n;e++)t=r[e],this.addConceptToView(t);for(a=this.model.getResourceContent().relations,o=0,i=a.length;o<i;o++)l=a[o],this.addRelationToView(l);return jsPlumb.repaintEverything()},t}()}).call(this);
//# sourceMappingURL=ConceptMapDirective.js.map
