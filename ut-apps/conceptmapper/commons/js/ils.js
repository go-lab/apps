(function(){var e;e={getCurrentUser:function(e){var t="",r={error:"Cannot get username"};return t=$.cookie("graasp_user"),e(void 0!=t&&null!=t&&""!=t?t:r)},getParent:function(e){var t={error:"Connot get parent space"};osapi.context.get().execute(function(r){return void 0==r||null==r||r.error?e(t):void osapi.spaces.get({contextId:r.contextId}).execute(function(r){return e(r.error?t:r)})})},readResource:function(t,r){var n={};return t>0?void osapi.documents.get({contextId:t,size:"-1"}).execute(function(o){return o.error?(n={error:"Cannot get resource"},r(n)):(o.content=JSON.parse(window.atob(o.data)),void e.getIls(function(n){e.getVault(function(a){e.getAction(a.id,t,function(e){var t={};return t.actor=e.actor,t.target={objectType:e.object.objectType,id:e.object.id,displayName:e.object.displayName},t.generator={objectType:e.generator.objectType,url:e.generator.url,id:e.generator.id,displayName:e.generator.displayName},t.provider={url:n.profileUrl,id:n.id,displayName:n.displayName},o.metadata=t,r(o)})})}))}):(n={error:"resourceId cannot be 0 or negative"},r(n))},createResource:function(t,r,n){var o={};return null==t||void 0==t?(o={error:"resourceName cannot be null. Cannot create resource."},n(o)):void e.getVault(function(a){e.getCurrentUser(function(i){var c={document:{parentType:"@space",parentId:a.id,displayName:t,mimeType:"txt",fileName:t,content:JSON.stringify(r)}};osapi.documents.create(c).execute(function(t){return!t.error&&null!=t&void 0!=t?void e.getApp(function(r){e.logAction(i,a,t.entry.id,r,function(e){return n(e.error?e.error:t.entry)})}):(o={error:"Couldn't create resource"},n(o))})})})},listVault:function(t){var r={error:"Cannot get the resources in the Vault"};e.getVault(function(e){osapi.documents.get({contextId:e.id,contextType:"@space"}).execute(function(e){return t(e.list.length>0?e.list:r)})})},getIls:function(e){var t={error:"Cannot get ILS"};osapi.context.get().execute(function(r){return r.error?e(t):(console.log("print context"),console.log(r),osapi.spaces.get({contextId:r.contextId}).execute(function(r){return r.error?e(t):(console.log("print parent space"),console.log(r),"ils"===r.spacetype?e(r,r):void osapi.spaces.get({contextId:r.parentId}).execute(function(n){return n.error||"ils"!==n.spacetype?e(t):(console.log("print ils space"),console.log(n),e(n,r))}))}),void 0)})},getVault:function(t){var r={};e.getIls(function(e){return e.error?(r={error:"Cannot get the vault"},t(r)):(console.log(e.id),void osapi.spaces.get({contextId:e.id,contextType:"@space"}).execute(function(e){if(0!=e.totalResults){var n,o;return o=function(){var t,r,o,a;for(o=e.list,a=[],t=0,r=o.length;t<r;t++)n=o[t],null!=JSON.parse(n.metadata)&&void 0!=JSON.parse(n.metadata)&&"Vault"===JSON.parse(n.metadata).type&&a.push(n);return a}(),t(o[0])}return r={error:"No subspaces in current ILS"},t(r)}))})},getApp:function(e){osapi.apps.get({contextId:"@self"}).execute(function(t){if(t.error){var r={error:"Cannot get app"};return e(r)}return e(t)})},logAction:function(e,t,r,n,o){var a={userId:"@viewer",groupId:"@self",activity:{verb:"add"}};a.activity.actor={id:e+"@"+t.parentId.toString(),objectType:"person",name:e},a.activity.object={id:r.toString(),objectType:"Asset",graasp_object:"true"},a.activity.target={id:t.id.toString(),objectType:"Space",graasp_object:"true"},a.activity.generator={id:n.id.toString(),objectType:"Widget",ur:n.appUrl,graasp_object:"true"},osapi.activitystreams.create(a).execute(function(e){if(e.error){var t={error:"Cannot create activity"};return o(t)}return o(e)})},getAction:function(e,t,r){var n={contextId:e,contextType:"@space",count:1,fields:"id,actor,verb,object,target,published,updated,generator",filterBy:"object.id",filterOp:"contains",filterValue:"assets/"+t.toString(),ext:!0};osapi.activitystreams.get(n).execute(function(e){if(!e.error&&e.totalResults>0)return r(e.entry[0]);var t={error:"Cannot get activity"};return r(t)})},getParentInquiryPhase:function(e){var t={error:"Cannot get parent inquiry phase"};this.getParent(function(r){return e(r.error||null==r.metadata||void 0==r.metadata?t:JSON.parse(r.metadata).type)})}},window.ils=e}).call(this);