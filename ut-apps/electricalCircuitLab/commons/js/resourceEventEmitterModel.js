(function(){"use strict";var t,e,r=function(t,e){function r(){this.constructor=t}for(var a in e)o.call(e,a)&&(t[a]=e[a]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},o={}.hasOwnProperty;this.ut=this.ut||{},this.ut.commons=this.ut.commons||{},e=this.JSONR,t=this.EventEmitter,this.ut.commons.EventArray=function(){function t(t,e){this.resourceEventEmitterModel=t,this.eventLabel=e,this._array=[],Object.defineProperties(this,{length:{get:function(){return this._array.length}}})}return t.prototype.push=function(t){return this._array.push(t),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"Pushed",[this.getEventValue(t)]),this.resourceEventEmitterModel.emitModelChanged()},t.prototype.getEventValue=function(t){return t},t.prototype.remove=function(t){return this._array.splice(t,1),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"Removed",[t]),this.resourceEventEmitterModel.emitModelChanged()},t.prototype.clear=function(){return this._array.splice(0,this._array.length),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"Cleared",[]),this.resourceEventEmitterModel.emitModelChanged()},t.prototype.isEmpty=function(){return 0===this._array.length},t.prototype.getValue=function(t){return this._array[t]},t.prototype.setValue=function(t,e){if(this._array[t]!==e)return this._array[t]=e,this.resourceEventEmitterModel.emitEvent(this.eventLabel+"ValueChanged",[t,this.getEventValue(e)]),this.resourceEventEmitterModel.emitModelChanged()},t.prototype.swapValues=function(t,e){var r;return r=this._array[t],this._array[t]=this._array[e],this._array[e]=r,this.resourceEventEmitterModel.emitEvent(this.eventLabel+"ValuesSwapped",[t,e]),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"ValueChanged",[t,this.getEventValue(this._array[t])]),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"ValueChanged",[e,this.getEventValue(this._array[e])]),this.resourceEventEmitterModel.emitModelChanged()},t.prototype.getValues=function(t){var e,r;return null==t&&(t=!0),r=function(){var r,o,a,n;if(t){for(a=this._array,n=[],r=0,o=a.length;r<o;r++)e=a[r],e.length>0&&n.push(e);return n}return this._array.slice()}.call(this)},t.prototype.setValues=function(t){var e;if(JSON.stringify(this._array)!==JSON.stringify(t))return this._array=t,e=t.map(function(t){return function(e){return t.getEventValue(e)}}(this)),this.resourceEventEmitterModel.emitEvent(this.eventLabel+"ValuesChanged",e),this.resourceEventEmitterModel.emitModelChanged()},t}(),this.ut.commons.NamedEventArray=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return r(e,t),e.prototype.addNewName=function(){return this.push("")},e.prototype.getNameValue=function(t){return this.getValue(t)},e.prototype.setNameValue=function(t,e){return this.setValue(t,e)},e.prototype.getNameValues=function(t){return null==t&&(t=!0),this.getValues(t)},e.prototype.getValues=function(t){var r,o,a,n,i,s;if(null==t&&(t=!0),s=e.__super__.getValues.call(this,!1),t){for(n=[],r=o=0,i=s.length;0<=i?o<i:o>i;r=0<=i?++o:--o)a=this.getNameValue(r),a.length>0&&n.push(s[r]);return n}return s},e}(this.ut.commons.EventArray),this.ut.commons.ResourceEventEmitterModel=function(t){function o(t,e){if("object"!=typeof t)throw"environmentHandlers must be the result of the createEnvironmentHandlers call";if("string"!=typeof e)throw"resourceType must be a non empty string";if(0===e.length)throw"resourceType must be a non empty string";if(!t[e])throw"resourceType ("+e+") must be defined in the environmentHandlers";this.storageHandler=t[e].storageHandler,this.actionLogger=t[e].actionLogger,this.languageHandler=t.languageHandler,this.storageHandler||console.error("storageHandler not defined!"),this.actionLogger||console.error("actionLogger not defined!"),this.languageHandler||console.error("languageHandler not defined!"),this._id=null,this._metadata=null,this._resource=null,this._updateFromExternalStateInProgress=!1,this._emitEvents=!0,this._debug=!1,this._isSaved=!1,this._checkResourceTypes=!0,this._isChanged=!1,this._firstChangeMillis=0,this._lastChangeMillis=0,this.addListener("modelChanged",this._changed),this._configUISettings={},Object.defineProperties(this,{startupFinished:{writable:!0,value:!0},mainModelClass:{writable:!0,value:!0},configUISettings:{get:this.getConfigUISetting},id:{get:this.getId},updateFromExternalStateInProgress:{get:function(){return this._updateFromExternalStateInProgress}},environmentHandlers:{get:function(){return t}}})}return r(o,t),o.prototype.createNewModel=function(){return new window.ut.commons.ResourceEventEmitterModel(this.environmentHandlers,this.getResourceType())},o.prototype.initialLoadingFinished=function(){},o.prototype.getConfigUISetting=function(){return this._configUISettings},o.prototype.getId=function(){return this._id},o.prototype.getPublished=function(){return this._metadata?this._metadata.published:""},o.prototype.isSaved=function(){return this._isSaved},o.prototype.setSaved=function(t){return this._debug&&console.log(this.getDebugLabel()+".setSaved("+t+")"),this._isSaved=t},o.prototype.findIfSaved=function(){return this._metadata&&this._metadata.id?this.storageHandler.resourceExists(this._metadata.id,function(t){return function(e,r){return e?(console.error(t.getDebugLabel()+": storageHandler.resourceExists failed: "+e),t.setSaved(!1)):t.setSaved(r)}}(this)):this.setSaved(!1)},o.prototype.isReadOnly=function(){return this.getMetadataFlag("readOnly")},o.prototype.setMetadataFlag=function(t,e){if(this.storageHandler.getMetadataHandler().setMetadataFlag(t,e),this._metadata)return this._metadata.flags=this._metadata.flags||{},this._metadata.flags[t]=e},o.prototype.getMetadataFlag=function(t){return this._metadata?(this._metadata.flags=this._metadata.flags||{},this._metadata.flags[t]):this.storageHandler.getMetadataHandler().getMetadataFlag(t)},o.prototype.isContentCopy=function(){return!1},o.prototype.isChangeTrackingFullyImplemented=function(){return!1},o.prototype.isChanged=function(){return this._isChanged},o.prototype.clearChanged=function(){return this._isChanged=!1,this._firstChangeMillis=0,this._lastChangeMillis=0},o.prototype._changed=function(){if(this._isChanged=!0,this._lastChangeMillis=Date.now(),0===this._firstChangeMillis)return this._firstChangeMillis=this._lastChangeMillis},o.prototype.isEmpty=function(){return!1},o.prototype.getMetadata=function(){return this._metadata},o.prototype.getResource=function(){return{metadata:this.getMetadata(),content:this.getResourceContent()}},o.prototype.getResourceType=function(){return this.storageHandler&&this.storageHandler.getMetadataHandler&&this.storageHandler.getMetadataHandler().getTarget?this.storageHandler.getMetadataHandler().getTarget().objectType:"?? resource type ??"},o.prototype.getResourceTarget=function(){return this.storageHandler.getMetadataHandler().getTarget()},o.prototype.getPublished=function(){return this._metadata?this._metadata.published:this.storageHandler.getMetadataHandler().published},o.prototype.getNickName=function(){return this._metadata?this._metadata.actor.displayName:this.storageHandler.getMetadataHandler().actor.displayName},o.prototype.getApplication=function(){return this.storageHandler.getMetadataHandler().getGenerator().displayName},o.prototype.getAppId=function(){return this._metadata?this._metadata.generator.id:this.storageHandler.getMetadataHandler().getGenerator().id},o.prototype.getStorageHandler=function(){return this.storageHandler},o.prototype.getMetadataHandler=function(){return this.storageHandler.getMetadataHandler()},o.prototype.getActionLogger=function(){return this.actionLogger},o.prototype.getLanguageHandler=function(){return this.languageHandler},o.prototype.getDebugLabel=function(){return this.getResourceType()+":"+this.getDisplayName()},o.prototype.loadFromResourceId=function(t,e){return this.storageHandler.readResource(t,function(t){return function(r,o){return r?e(r):(t.loadFromResource(o),e(null))}}(this))},o.prototype.loadFromResource=function(t,e){return null==e&&(e=!1),this._debug&&(console.log(this.getDebugLabel()+".loadFromResource:"),console.log(t)),t.metadata&&t.metadata.target&&this._checkResourceTypes&&this.getResourceType()!==t.metadata.target.objectType&&console.error("trying to load a resource of type '"+t.metadata.target.objectType+"', but it should be '"+this.getResourceType()+"'"),this._emitEvents=!1,this._id=t.metadata?t.metadata.id:null,this._metadata=t.metadata,this.loadContentFromResource(t.content),this._resource=t,t.metadata&&t.metadata.target&&this.storageHandler.getMetadataHandler().setTarget(t.metadata.target),e&&this.updateIdsAfterImportingResource(),this.setSaved(!0),this.findIfSaved(),this._emitEvents=!0,this.emitModelLoaded(),this.clearChanged()},o.prototype.updateIdsAfterImportingResource=function(){return this.updateIdsInMetadataAfterImportingResource(),this.updateIdsInContentAfterImportingResource()},o.prototype.updateIdsInMetadataAfterImportingResource=function(){if(this._id&&(this.storageHandler.getMetadataHandler().updateIdsAfterImporting(),this._id=this.storageHandler.getMetadataHandler().getId(),this._metadata&&(this._metadata.id=this._id,this._metadata.target)))return this._metadata.target.id=this.storageHandler.getMetadataHandler().getTargetId()},o.prototype.updateIdsInContentAfterImportingResource=function(){},o.prototype.importFromResource=function(t){var e;return e=JSON.parse(JSON.stringify(t)),this.loadFromResource(e,!0)},o.prototype.importFromFile=function(t,e){var r;return console.log("importFromFile("+JSON.stringify(t)+"):"),console.log("file: name: "+t.name+", type: "+t.type+", size: "+t.size),r=JSON.parse(e),this.importFromResource(r)},o.prototype.clear=function(){return this._debug&&console.log(this.getDebugLabel()+".clear()"),this._id=null,this._metadata=null,this._resource=null,this.setSaved(!1),this.clearContent(),this.emitEvent("modelCleared"),this.emitModelChanged(),this.clearChanged()},o.prototype.deleteResource=function(t){return this.storageHandler.deleteResource(this.getId(),t)},o.prototype.hasResource=function(){return null!==this.getId()},o.prototype.reload=function(){return this.loadFromResource(this.getResource())},o.prototype.equals=function(t){var e,r;return e=JSON.stringify(this.getResource()),r=JSON.stringify(t.getResource()),e===r},o.prototype.getResourceContent=function(){return{configUISettings:this._configUISettings}},o.prototype.loadContentFromExternalState=function(t){this._updateFromExternalStateInProgress=!0;try{return this.loadContentFromResource(t)}finally{this._updateFromExternalStateInProgress=!1}},o.prototype.loadContentFromResource=function(t){return this.loadFromResourceContent(t),this.emitContentLoaded(),this.clearChanged()},o.prototype.loadFromResourceContent=function(t){if(t.configUISettings)return this._configUISettings=t.configUISettings},o.prototype.clearContent=function(){return this.emitEvent("contentCleared"),this.emitModelChanged()},o.prototype.applyLogAction=function(t,e){var r;switch(r=function(){var e,r;return r=t.object.objectType,"resource"===r&&(e=t.object.content,r=e.metadata&&e.metadata.target&&e.metadata.target.objectType?e.metadata.target.objectType:t.target.objectType),r},t.verb){case"open":return this.applyLogLoad(t,r(),e);case"create":return this.applyLogSaveAs(t,r(),e);case"update":return this.applyLogSave(t,r(),e);case"delete":return this.applyLogDelete(t,r(),e);case"clear":return this.applyLogClear(t,r(),e);case"add":return this.applyLogAdd(t,e);case"change":return this.applyLogChange(t,e);case"remove":return this.applyLogRemove(t,e);default:return console.log("no code yet for action logging verb: "+t.verb)}},o.prototype.applyLogLoad=function(t,e,r){if(e===this.getResourceType()?this.loadFromResource(t.object.content):"configuration"===e?console.log("not syncing loading of the configuration model"):console.warn("Wrong resource type: "+e+", expected: "+this.getResourceType()),null!=r)return r(null)},o.prototype.applyLogSaveAs=function(t,e,r){return this.applyLogLoad(t,e,r)},o.prototype.applyLogSave=function(t,e,r){return this.applyLogLoad(t,e,r)},o.prototype.applyLogDelete=function(t,e,r){return this.applyLogClear(t,e,r)},o.prototype.applyLogClear=function(t,e,r){if(e===this.getResourceType()?(this.clearContent(),t.object.content.initialContent&&this.loadContentFromResource(t.object.content.initialContent)):console.warn("Wrong resource type: "+e+", expected: "+this.getResourceType()),null!=r)return r(null)},o.prototype.applyLogAdd=function(t,e){if(console.warn("please override the applyLogAdd method!"),null!=e)return e(null)},o.prototype.applyLogChange=function(t,e){var r,o,a,n,i;switch(r=!1,t.object.objectType){case"golabSection":o=t.object.id,i=t.object.content,this.configUISettings.showHideSections=this.configUISettings.showHideSections||{},this.configUISettings.showHideSections[o]=i;break;case"undo":case"redo":n="????",a=t.object.content,a.metadata&&a.metadata.target&&a.metadata.target.objectType&&(n=a.metadata.target.objectType),this.applyLogLoad(t,n,e),r=!0;break;default:console.warn("Unknown object type: "+t.object.objectType)}if(!r)return"function"==typeof e?e(null):void 0},o.prototype.applyLogRemove=function(t,e){if(console.warn("please override the applyLogRemove method!"),null!=e)return e(null)},o.prototype.emitEvents=function(){return this._emitEvents},o.prototype.emitEvent=function(t,r){if(this.emitEvents())return this._debug&&console.log(this.getDebugLabel()+".emitEvent("+e.stringify(arguments)+")"),o.__super__.emitEvent.call(this,t,r)},o.prototype.emitModelChanged=function(t){return null==t&&(t=!0),this._changed(),this.emitEvent("modelChanged",[{bigChange:t}])},o.prototype.emitModelLoaded=function(){return this.emitEvent("modelLoaded"),this.emitModelChanged()},o.prototype.emitContentLoaded=function(){return this.emitEvent("contentLoaded"),this.emitModelChanged()},o.prototype.emitModelResourceCreated=function(){return this.emitEvent("modelResourceCreated")},o.prototype.emitModelResourceUpdated=function(){return this.emitEvent("modelResourceUpdated")},o.prototype.addListener=function(t,e){return this._debug&&console.log(this.getDebugLabel()+".addListener("+t+")"),o.__super__.addListener.apply(this,arguments)},o.prototype.addListeners=function(t,e){var r,o,a,n;for(n=[],o=0,a=t.length;o<a;o++)r=t[o],n.push(this.addListener(r,e));return n},o.prototype.createResource=function(t){var e;return e=this.getResourceContent(),this.storageHandler.createResource(e,function(e){return function(r,o){if(r||(e._resource=o,e._id=o.metadata.id,e._metadata=o.metadata,e.setSaved(!0),e.emitModelResourceCreated(),e.clearChanged(),e._debug&&(console.log(e.getDebugLabel()+".createdResource:"),console.log(o))),t)return t(r,o)}}(this))},o.prototype.getResourceBundle=function(){var t,e,r;return e=this.getId(),t=this.getResourceContent(),r=e?this.storageHandler.getResourceBundle(t,e):this.storageHandler.getResourceBundle(t),this._resource=r,this._id=r.metadata.id,this._metadata=r.metadata,this._debug&&(console.log(this.getDebugLabel()+".getResourceBundle:"),console.log(r)),r},o.prototype.updateResource=function(t,e){var r;return null==e&&(e=!0),r=this.getResourceContent(),this.storageHandler.updateResource(this.getId(),r,function(e){return function(r,o){if(r||(e._resource=o,e._id=o.metadata.id,e._metadata=o.metadata,e.setSaved(!0),e.emitModelResourceUpdated(),e.clearChanged(),e._debug&&(console.log(e.getDebugLabel()+".updateResource:"),console.log(o))),t)return t(r,o)}}(this),e)},o.prototype.getDisplayName=function(){return this._metadata&&this._metadata.target?this._metadata.target.displayName:this.storageHandler&&this.storageHandler.getMetadataHandler&&this.storageHandler.getMetadataHandler().getTargetDisplayName?this.storageHandler.getMetadataHandler().getTargetDisplayName():"?? display name ??"},o.prototype.setDisplayName=function(t){if(t!==this.getDisplayName)return this.storageHandler.getMetadataHandler().setTargetDisplayName(t),this._metadata&&this._metadata.target&&(this._metadata.target.displayName=t),this.emitEvent("displayNameChanged",[t]),this.emitModelChanged()},o.prototype.getResourceDescription=function(){return this._resource?this.storageHandler.getResourceDescription(this._resource):{id:this.getId(),title:this.storageHandler.getMetadataHandler().getTarget().displayName,type:this.storageHandler.getMetadataHandler().getTarget().objectType,tool:this.storageHandler.getMetadataHandler().getGenerator().displayName,author:this.storageHandler.getMetadataHandler().getActor().displayName,modified:new Date(0)}},o.prototype.loadLatestResource=function(t){return this._debug&&console.log(this.getDebugLabel()+".loadLatestResource for type "+this.getResourceType()),this.storageHandler.readLatestResource(this.getResourceType(),function(e){return function(r,o){var a;if(!o)return r?(console.error("failed to read latest resource: "+r),"function"==typeof t?t(r,o):void 0):(e._debug&&console.log("did not find a latest resource of type "+e.getResourceType()),"function"==typeof t?t(r,o):void 0);try{return e._debug&&console.log("found a latest resource of type "+e.getResourceType()),e.loadFromResource(o),e.setSaved(!0),e.clearChanged(),"function"==typeof t?t(r,o):void 0}catch(e){return a=e,"function"==typeof t?t(a,null):void 0}}}(this))},o.prototype.canReloadFromStorage=function(){return this.isSaved()&&null!==this.getId()&&this.getId().length>0},o.prototype.reloadFromStorage=function(t){return this.canReloadFromStorage()?this.loadFromResourceId(this.getId(),t):setTimeout(t)},o.prototype.equalValues=function(t,e){return t===e||typeof t==typeof e&&("object"!=typeof t?t===e:JSON.stringify(t)===JSON.stringify(e))},o}(t)}).call(this);
//# sourceMappingURL=resourceEventEmitterModel.js.map
