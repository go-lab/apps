(function(){"use strict";var e,t;window.ut=window.ut||{},ut.simulations=ut.simulations||{},ut.simulations.electricity=ut.simulations.electricity||{},ut.simulations.electricity.circuitboard=ut.simulations.electricity.circuitboard||{},ut.simulations.electricity.circuitboard.findComponentPosition=function(e,t){var o,n,i,r,c,s;return r=function(e){return Math.round(e/t)},c=r(e.left),s=r(e.top),n=e.left-c*t,i=e.top-s*t,o=Math.sqrt(n*n+i*i),{left:c,top:s,delta:o}},ut.simulations.electricity.circuitboard.findSensorPosition=function(e,t){var o,n,i,r,c;return c=1+t/2,i=ut.simulations.electricity.circuitboard.findComponentPosition({left:e.left-c,top:e.top},t),r=ut.simulations.electricity.circuitboard.findComponentPosition({left:e.left,top:e.top-c},t),i.delta<r.delta?(o=i.left+"_"+(i.top-1),n=i.left+"_"+i.top):(o=r.left-1+"_"+r.top,n=r.left+"_"+r.top),{cmpId1:o,cmpId2:n}},t={dropObjectType:"",dropObjectId:"",objectDropLocation:null,askQuestion:{},updateFromExternalStateInProgress:!1},e=function(e,t,o,n,i,r,c,s,a,u,l,d){var p,g,m,C,f,b,h,y,w,v,S,j,O,L,P,D,M,R,I,k;return g=c.getCircuitSimulatorActionLogger(),e.labConfigurations=a,ut.simulations.electricity.fixLayout&&setTimeout(function(){return ut.simulations.electricity.fixLayout()},0),c.addListeners(["modelLoaded","contentLoaded"],function(){return c.updateFromExternalStateInProgress?e.selectedComponent&&(e.selectedComponent=c.getComponent(e.selectedComponent.getId()),e.selectedComponent.isResistor())?e.resistorColorModel.setResistance(e.selectedComponent.getResistance()):void 0:e.selectedComponent=null}),c.addListeners(["contentCleared"],function(){if(!c.updateFromExternalStateInProgress)return e.selectedComponent=null}),f=function(t){return ut.simulations.electricity.circuitboard.findComponentPosition(t,e.size)},b=function(t){return ut.simulations.electricity.circuitboard.findSensorPosition(t,e.size)},v=function(e,t){var o,i;if(i=f(t),c.isComponentPositionFree(i))return o=n.getNewComponent(e),o.setLocation(i),c.addComponent(o),c.rotateComponentOptimal(o),L(o.getId()),g.logComponentAdd(o),p()},m=function(e,t){var o,n;return o=c.getComponent(e),n=f(t),c.isComponentPositionFree(n)?(o.setLocation(n),g.logComponentChange(o),p()):o.updateLocation()},j=function(e){var t;return t=c.getComponent(e),c.removeComponent(e),g.logComponentRemove(t),L(),p()},L=function(t){var o,n;return null!=(o=e.selectedComponent)&&(o.selected=!1),t?(e.selectedComponent=c.getComponent(t),null!=(n=e.selectedComponent)?n.selected=!0:void 0):e.selectedComponent=null},P=function(e,t){var o,n;return n=b(t),o=c.getPlacedSensor(e),c.isSensorPositionFree(n)?(o?(o.place(n),g.logSensorChange(o)):(o=i.getSensor(e),c.addSensor(o),o.place(n),g.logSensorAdd(o)),D()):o?(o.updateLocation(),D()):void 0},k=function(){var e,t,o,n,i,s;if(o=r.getPowerSupplies(),o.length>0){for(i=r.getPowerSupplies(),s=[],e=0,t=i.length;e<t;e++)switch(n=i[e],n.getType()){case"dcVoltageSource":s.push(c.setPowerSource(n));break;default:console.log("unknown type of power supply: "+n.getType()),s.push(c.setPowerSource(null))}return s}return c.setPowerSource(null)},k(),e.unsavedChanges=!1,I=function(){var t,o,n;if(window.ut.simulations.electricity.circuitJsonShown)return t=c.getStorageHandler().getResourceBundle(h()),o={acMode:d.acMode,powerSupplies:t.content.powerSupplies,components:t.content.components},n=o.components,n.forEach(function(e){return e.id=e.x+"_"+e.y+"_"+e.type}),e.circuitJson=JSON.stringify(o)},p=function(){return s.circuitChanged(),I(),e.unsavedChanges=!0},C=function(){return s.componentValueChanged(),I(),e.unsavedChanges=!0},S=function(){return s.powerChanged(),I()},D=function(){return s.sensorsChanged(),I()},c.addListeners(["modelCleared","modelLoaded","contentCleared"],function(){return p()}),e.$watch("circuitModel.modelCounter",function(){return p()}),e.$watch("circuitModel.powerSource.voltage.getValue().value",function(){return S()}),e.$watch("circuitModel.powerSource.frequency.getValue().value",function(){return S()}),e.circuitModel=c,e.circuitJson="",e.postionComponents=!0,e.postionSensors=!0,e.resistorColorModel=new ut.simulations.electricity.ResistorValueColorModel(0),e.userChangedResistanceValue=function(){return C()},e.componentBeingDragged=!1,e.selectedComponent=null,e.objectDraggingStarted=function(t){return L(t.dropObjectId),e.componentBeingDragged=!0,e.existingComponentBeingDragged="component"===t.dropObjectType},e.objectDroppedOutside=function(t){switch(t.dropObjectType){case"component":j(t.dropObjectId);break;default:console.log("unknown object dropped outside: type="+t.dropObjectType+", id="+t.dropObjectId)}return e.componentBeingDragged=!1},e.acceptObjectDrop=function(e){switch(e.dropObjectType){case"newComponent":case"component":case"sensor":return!0;default:return!1}},e.objectDroppedInside=function(t){switch(t.dropObjectType){case"newComponent":v(t.dropObjectId,t.objectDropLocation);break;case"component":m(t.dropObjectId,t.objectDropLocation);break;case"sensor":P(t.dropObjectId,t.objectDropLocation);break;default:console.log("unknown object dropped: type="+t.dropObjectType+", id="+t.dropObjectId)}return e.componentBeingDragged=!1},e.beforeCloseDialogBox=function(t){switch(t){case"editResistorValue":return g.logComponentChange(e.selectedComponent)}},e.componentClicked=function(t,o){var n;return e.existingComponentBeingDragged||((null!=(n=e.selectedComponent)?n.getId():void 0)===o?e.selectedComponent.isResistor()?(e.resistorColorModel.setResistance(e.selectedComponent.getResistance()),e.dialogBoxes.editResistorValue.show()):e.selectedComponent.isCapacitor()||e.selectedComponent.isCoil()?e.dialogBoxes.editResistanceValue.show():e.selectedComponent.getCanSwitch()&&(e.selectedComponent.switchTo(),g.logComponentChange(e.selectedComponent),p()):L(o)),e.existingComponentBeingDragged=!1,t.stopPropagation()},e.$watch("selectedComponent.getResistance()",function(t,o){if(e.selectedComponent&&e.selectedComponent.isResistor())return e.resistorColorModel.setResistance(e.selectedComponent.getResistance())}),e.circuitBoardClicked=function(){return L()},e.rotate90=function(t){return e.selectedComponent&&(e.selectedComponent.rotate90(),g.logComponentChange(e.selectedComponent),p()),t.stopPropagation()},e.rotate_90=function(t){return e.selectedComponent&&(e.selectedComponent.rotate_90(),g.logComponentChange(e.selectedComponent),p()),t.stopPropagation()},e.componentChanged=function(){return p()},h=function(){return c.getResourceContent()},O="",M=function(){return O=JSON.stringify(h()),e.unsavedChanges=!1},M(),y=function(){var t;return e.unsavedChanges&&(t=JSON.stringify(h()),t===O&&(e.unsavedChanges=!1)),e.unsavedChanges},R=function(t){return y()?(e.askQuestion.questionParams={question:l.getMessage("availableCircuits.discardUnsavedChanges.question"),okLabel:l.getMessage("availableCircuits.discardUnsavedChanges.discard"),cancelLabel:l.getMessage("availableCircuits.discardUnsavedChanges.cancel"),dialogBoxId:"askNotToSave",questionOkAnswer:function(){return t()}},e.dialogBoxes.askNotToSave.show()):t()},d.addListener("modelChanged",function(){return o(function(){return"function"==typeof fixCircuitSimulatorLayout&&fixCircuitSimulatorLayout(),k()},0)}),w=function(e){var t;return"circuit"===e.metadata.target.objectType?(t=e.metadata.target.displayName,c.getStorageHandler().getMetadataHandler().setTarget(e.metadata.target),c.loadFromResourceContent(e.content),p(),L(),M()):(console.log("Can only load resource of type circuit, the resource is:"),console.log(e))}},ut.simulations.electricity.circuitsimulator.controller("circuitBoardCtrl",["$scope","$rootScope","$timeout","componentDAO","meterDAO","powerDAO","circuitModel","circuitSimulatorEngine","labConfigurations","fileStorage","languageHandler","configurationModel",e])}).call(this);
//# sourceMappingURL=circuitBoardCtrl.js.map
