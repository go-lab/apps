var __extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},ut;!function(t){var e;!function(e){var o;!function(e){"use strict";var o=t.commons.ResourceEventEmitterModel,r=t.commons.tsutils.IdSet,n=function(){function t(){this.list=[],this.map={}}return t.prototype.clear=function(){this.list=[],this.map={}},t.prototype.getList=function(){return this.list},t.prototype.getObject=function(t){return this.map[t]},t.prototype.addObject=function(t){this.list.push(t),this.map[t.getId()]=t},t.prototype.replaceObjects=function(t){var e=this;this.clear(),t.forEach(function(t){e.map[t.getId()]?console.warn("duplicate object: "+t):e.addObject(t)})},t}();e.ListForObjectsWithId=n;var a=function(t){function e(){t.apply(this,arguments),this.sensorsMap={}}return __extends(e,t),e.prototype.clear=function(){return t.prototype.clear.call(this),this.sensorsMap={}},e.prototype.getMeters=function(){return this.getList()},e.prototype.getMeter=function(t){return this.getObject(t)},e.prototype.getSensor=function(t){return this.sensorsMap[t]},e.prototype.addObject=function(e){var o=this;t.prototype.addObject.call(this,e),e.getSensors().forEach(function(t){return o.sensorsMap[t.getId()]=t})},e.prototype.replaceMeters=function(t){this.replaceObjects(t)},e}(n);e.AvailableMeters=a;var i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.getPowerSupplies=function(){return this.getList()},e.prototype.getPowerSupply=function(t){var e=this.getObject(t);return e||console.warn("failed to find power supply with id "+t),e},e.prototype.replacePowerSupplies=function(t){this.replaceObjects(t)},e}(n);e.AvailablePowerSupplies=i;var s=function(o){function n(t,n,s){o.call(this,t,"circuit"),this._dataGraphModel=n,this.configurationModel=s,this.components=new r,this.placedSensors=new r,this.availableMeters=new a,this.availablePowerSupplies=new i,this._powerSource=null,this.modelCounter=0,this.errorMessage="",this._circuitSimulatorEngine=null,this.actionLogger=new e.CircuitSimulatorActionLogger(this.actionLogger)}return __extends(n,o),n.prototype.createNewModel=function(){var t=this.dataGraphModel?this.dataGraphModel.createNewModel():null,e=new n(this.environmentHandlers,t,this.configurationModel);return this.configurationModel.addCircuitBoardModel(e),e},n.prototype.getCircuitSimulatorActionLogger=function(){return this.actionLogger},n.prototype.setCircuitSimulatorEngine=function(t){this._circuitSimulatorEngine=t},Object.defineProperty(n.prototype,"powerSource",{get:function(){return this._powerSource},enumerable:!0,configurable:!0}),n.prototype.initialLoadingFinished=function(){return this.emitModelLoaded(),this.clearChanged()},n.prototype.isEmpty=function(){return 0===Object.keys(this.components).length&&0===Object.keys(this.placedSensors).length},n.prototype.getAvailableMeters=function(){return this.availableMeters},n.prototype.getAvailablePowerSupplies=function(){return this.availablePowerSupplies},n.prototype.getDataGraphModel=function(){return this._dataGraphModel},Object.defineProperty(n.prototype,"dataGraphModel",{get:function(){return this._dataGraphModel},enumerable:!0,configurable:!0}),n.prototype.equals=function(t){var e=function(t){var e=t.getResource();return delete e.content.dataGraphModel,JSON.stringify(e)};if(this.dataGraphModel){if(!t.dataGraphModel)return!1;if(!this.dataGraphModel.equals(t.dataGraphModel))return!1}var o=e(this),r=e(t);return o===r},n.prototype.applyLogLoad=function(t,e,r){switch(e){case"dataSet":case"data":this.dataGraphModel&&this.dataGraphModel.applyLogLoad(t,e,r);break;default:o.prototype.applyLogLoad.call(this,t,e,r)}},n.prototype.applyLogSave=function(t,e,r){switch(e){case"dataSet":case"data":this.dataGraphModel&&this.dataGraphModel.applyLogSave(t,e,r);break;default:o.prototype.applyLogSave.call(this,t,e,r)}},n.prototype.applyLogSaveAs=function(t,e,r){switch(e){case"dataSet":case"data":this.dataGraphModel&&this.dataGraphModel.applyLogSaveAs(t,e,r);break;default:o.prototype.applyLogSaveAs.call(this,t,e,r)}},n.prototype.applyLogClear=function(t,e,r){switch(e){case"dataSet":case"data":this.dataGraphModel&&this.dataGraphModel.applyLogClear(t,e,r);break;default:o.prototype.applyLogClear.call(this,t,e,r)}},n.prototype.applyLogAdd=function(t,o){var r=!1;switch(t.object.objectType){case"component":var n=new e.ComponentModel(t.object.content);this.addComponent(n);break;case"sensor":var a=this.getAvailableMeters().getSensor(t.object.id);a&&(a.place(t.object.content),this.addSensor(a));break;case"dataSource":case"data":this.dataGraphModel&&(this.dataGraphModel.applyLogAdd(t,o),r=!0);break;default:console.warn("Unknown object type: "+t.object.objectType)}null!==this._circuitSimulatorEngine&&this._circuitSimulatorEngine.circuitChanged(),r||o(null)},n.prototype.applyLogChange=function(t,e){switch(t.object.objectType){case"component":var o=this.getComponent(t.object.id);if(o){var r=t.object.content;r.x===o.getXPos()&&r.y===o.getYPos()||o.setLocation({left:r.x,top:r.y}),r.rotate!==o.getRotate()&&o.setRotate(r.rotate),r.resistance&&r.resistance!==o.getResistance()&&o.setResistance(r.resistance),r.type!==o.getComponentType()&&o.switchTo(r.type)}break;case"sensor":var n=this.getAvailableMeters().getSensor(t.object.id);if(n){var a=t.object.content,i=n.getPlace();a.cmpId1===i.cmpId1&&a.cmpId2===i.cmpId2||n.place(a)}break;case"powerSupply":var s=t.object.content,p=this._powerSource&&this._powerSource.getId()===s.id?this._powerSource:null;p?(p.getShortCircuit()!==s.shortCircuit&&p.setShortCircuit(s.shortCircuit),p.voltage.getValue().value!==s.voltage.value&&p.voltage.setFormattedValue(s.voltage.value),p.frequency.getValue().value!==s.frequency.value&&p.frequency.setFormattedValue(s.frequency.value)):console.warn("Could not find _powerSource with id "+s.id);break;default:console.warn("Unknown object type: "+t.object.objectType)}return null!==this._circuitSimulatorEngine&&this._circuitSimulatorEngine.circuitChanged(),e(null)},n.prototype.applyLogRemove=function(t,e){var o=!1;switch(t.object.objectType){case"component":this.removeComponent(t.object.id);break;case"sensor":this.removeSensor(t.object.id);break;case"dataSource":this.dataGraphModel&&(this.dataGraphModel.applyLogRemove(t,e),o=!0);break;default:console.warn("Unknown object type: "+t.object.objectType)}if(null!==this._circuitSimulatorEngine&&this._circuitSimulatorEngine.circuitChanged(),!o)return e(null)},n.prototype.getResourceContent=function(){var t={components:this.getComponentsJson(),sensors:this.getSensorsJson(),powerSupplies:this.getPowerSuppliesJson()};return this.dataGraphModel&&(t.dataGraphModel=this.dataGraphModel.getResource()),t},n.prototype.loadFromResourceContent=function(t){this.clearContent(),t&&(t.components&&this.loadComponents(t.components),t.sensors&&this.loadSensors(t.sensors),t.powerSupplies&&this.loadPowerSupplies(t.powerSupplies),t.dataGraphModel&&this.dataGraphModel&&this.dataGraphModel.loadFromResource(t.dataGraphModel))},n.prototype.clearContent=function(){return this.components.clear(),this.placedSensors.toArray().forEach(function(t){return t.remove()}),this.placedSensors.clear(),this.availableMeters.getMeters().forEach(function(t){return t.clear()}),this.availablePowerSupplies.getPowerSupplies().forEach(function(t){return t.clear()}),this.dataGraphModel&&this.dataGraphModel.clear(),++this.modelCounter,o.prototype.clearContent.call(this)},n.prototype.getComponentsJson=function(){return this.components.toArray().map(function(t){return t.getJson()})},n.prototype.loadComponents=function(t){var o=this;t.forEach(function(t){o.addComponent(new e.ComponentModel(t))})},n.prototype.loadSensors=function(t){var e=this;t.forEach(function(t){var o=e.availableMeters.getSensor(t.id);o?(o.place(t),e.addSensor(o)):console.warn("can't find sensor: "+JSON.stringify(t))})},n.prototype.getSensorsJson=function(){return this.placedSensors.toArray().filter(function(t){return"light"!==t.getType()}).map(function(t){return t.getJson()})},n.prototype.getPowerSuppliesJson=function(){return this._powerSource?[this._powerSource.getJson()]:[]},n.prototype.loadPowerSupplies=function(t){var e=this;t.forEach(function(t){e._powerSource&&e._powerSource.getId()===t.id&&(e._powerSource.loadFromJson(t),e._powerSource.acMode=e.configurationModel.acMode)})},n.prototype.getComponents=function(){return this.components.toArray()},n.prototype.isComponentPositionFree=function(t){return this.components.toArray().every(function(e){return e.getXPos()!==t.left||e.getYPos()!==t.top})},n.prototype.getComponentAt=function(t,e){for(var o=0,r=this.components.toArray();o<r.length;o++){var n=r[o];if(n.getXPos()===t&&n.getYPos()===e)return n}return null},n.prototype.addComponent=function(t){this.components.add(t),t.getSensor()&&this.addSensor(t.getSensor()),this.emitModelChanged()},n.prototype.removeComponent=function(t){t instanceof e.ComponentModel?(this.components.remove(t),t.getSensor()&&this.removeSensor(t.getSensor())):this.components.removeById(t),this.emitModelChanged()},n.prototype.getComponent=function(t){return this.components.getById(t)},n.prototype.getPlacedSensors=function(){return this.placedSensors.toArray()},n.prototype.getPlacedSensor=function(t){return this.placedSensors.getById(t)},n.prototype.isSensorPositionFree=function(t){return this.placedSensors.toArray().filter(function(t){return!t.isHidden()}).every(function(e){return e.getPlace().cmpId1!==t.cmpId1||e.getPlace().cmpId2!==t.cmpId2})},n.prototype.addSensor=function(t){this.placedSensors.add(t),this.emitModelChanged()},n.prototype.removeSensor=function(e){if(e instanceof t.simulations.electricity.SensorModel)this.placedSensors.remove(e),e.remove();else{var o=this.placedSensors.getById(e);this.placedSensors.removeById(e),o.remove()}this.emitModelChanged()},n.prototype.removeAllSensors=function(){return this.placedSensors.clear()},n.prototype.setPowerSource=function(t){if(this._powerSource!==t)return this._powerSource=t,this.emitEvent("powerSourceChanged",[t]),this.emitModelChanged()},n.prototype.getMaxComponentXPos=function(){return this.components.toArray().reduce(function(t,e){return Math.max(t,e.getXPos())},0)+1},n.prototype.getMaxComponentYPos=function(){return this.components.toArray().reduce(function(t,e){return Math.max(t,e.getYPos())},0)+1},n.prototype.getNrOfConnections=function(t){var e=this,o=0,r=function(t,o,r){var n=e.getComponentAt(t,o);return!!n&&n.hasConnection(r)};return t.hasConnection("north")&&r(t.getXPos(),t.getYPos()-1,"south")&&++o,t.hasConnection("west")&&r(t.getXPos()-1,t.getYPos(),"east")&&++o,t.hasConnection("south")&&r(t.getXPos(),t.getYPos()+1,"north")&&++o,t.hasConnection("east")&&r(t.getXPos()+1,t.getYPos(),"west")&&++o,o},n.prototype.rotateComponentOptimal=function(t){var e=this,o=0,r=[90,180,270],n=this.getNrOfConnections(t);r.forEach(function(r){t.setRotate(r);var a=e.getNrOfConnections(t);a>n&&(n=a,o=r)}),t.setRotate(o)},n.prototype.getErrorMessage=function(){return this.errorMessage},n.prototype.setErrorMessage=function(t){this.errorMessage=t},n}(o);e.CircuitBoardModel=s}(o=e.electricity||(e.electricity={}))}(e=t.simulations||(t.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=circuitBoardModel.js.map
