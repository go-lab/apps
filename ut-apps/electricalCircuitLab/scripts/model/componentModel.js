var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ut;!function(t){var e;!function(e){var i;!function(e){"use strict";var i=t.commons.tsutils.IdMap,o=["north","east","south","west"],n=[{image:"wire",connections:["north","south"],deltaVolt:!1,resistance:!1,wire:!0,dcCompatible:!0,acCompatible:!0},{image:"corner",connections:["east","south"],deltaVolt:!1,resistance:!1,wire:!0,dcCompatible:!0,acCompatible:!0},{image:"split",connections:["north","east","south"],deltaVolt:!1,resistance:!1,wire:!0,dcCompatible:!0,acCompatible:!0},{image:"cross",connections:["north","east","south","west"],deltaVolt:!1,resistance:!1,wire:!0,dcCompatible:!0,acCompatible:!0},{image:"resistor",connections:["east","west"],deltaVolt:!1,resistance:!0,wire:!1,dcCompatible:!0,acCompatible:!0},{image:"capacitor",connections:["east","west"],deltaVolt:!1,resistance:!0,wire:!1,dcCompatible:!1,acCompatible:!0},{image:"coil",connections:["east","west"],deltaVolt:!1,resistance:!0,wire:!1,dcCompatible:!1,acCompatible:!0},{image:"dcVoltageSource",connections:["west","east"],deltaVolt:!0,resistance:!1,wire:!1,dcCompatible:!0,acCompatible:!0},{image:"dcCurrentSource",connections:["west","east"],deltaVolt:!0,resistance:!1,wire:!1,dcCompatible:!0,acCompatible:!1},{image:"battery1_5V",connections:["north","south"],deltaVolt:!0,resistance:!1,wire:!1,fixedVoltage:1.5,dcCompatible:!0,acCompatible:!1},{image:"battery6V",connections:["north","south"],deltaVolt:!0,resistance:!1,wire:!1,fixedVoltage:6,dcCompatible:!0,acCompatible:!1},{image:"battery9V",connections:["north","south"],deltaVolt:!0,resistance:!1,wire:!1,fixedVoltage:9,dcCompatible:!0,acCompatible:!1},{image:"battery12V",connections:["north","south"],deltaVolt:!0,resistance:!1,wire:!1,fixedVoltage:12,dcCompatible:!0,acCompatible:!1},{image:"ohmMeterSource",connections:["west","east"],deltaVolt:!0,resistance:!1,wire:!1,fixedVoltage:1,dcCompatible:!0,acCompatible:!1},{image:"switch2On",connections:["north","south"],deltaVolt:!1,resistance:!1,switchesTo:"switch2Off",wire:!0,canSwitch:!0,dcCompatible:!0,acCompatible:!0},{image:"switch2Off",connections:[],deltaVolt:!1,resistance:!1,switchesTo:"switch2On",wire:!1,canSwitch:!0,dcCompatible:!0,acCompatible:!0},{image:"switch2Left",connections:["west","south"],deltaVolt:!1,resistance:!1,switchesTo:"switch2Right",wire:!0,canSwitch:!0,dcCompatible:!0,acCompatible:!0},{image:"switch2Right",connections:["east","south"],deltaVolt:!1,resistance:!1,switchesTo:"switch2Left",wire:!0,canSwitch:!0,dcCompatible:!0,acCompatible:!0},{image:"light",connections:["east","west"],deltaVolt:!1,resistance:!0,wire:!1,dcCompatible:!0,acCompatible:!0},{image:"lightBroken",connections:[],deltaVolt:!1,resistance:!1,wire:!1,dcCompatible:!0,acCompatible:!0},{image:"transformer",connections:["west","east"],deltaVolt:!1,resistance:!1,wire:!1,dcCompatible:!0,acCompatible:!0}],s=new i;n.forEach(function(t){return s.put(t.image,t)});var r=function(){function t(t){this.json=t,this._defined=!1,this._initialValue=0,this._adjustable=!1,this._minimumValue=0,this._maximumValue=0,this._valueStep=0,this.init()}return t.prototype.init=function(){"number"==typeof this.json?(this._adjustable=!1,this._initialValue=this.json,this._defined=!0):"object"==typeof this.json&&(this._adjustable=!0,this._initialValue=this.json.value,this._minimumValue=this.json.minimum,this._maximumValue=this.json.maximum,this._valueStep=this.json.step,this._defined=!0)},t.prototype.isDefined=function(){return this._defined},t.prototype.isAdjustable=function(){return this._adjustable},t.prototype.getValue=function(){return"number"==typeof this._initialValue?this._initialValue:this._initialValue.value},t.prototype.setValue=function(t){this._initialValue=t},t.prototype.getMinimumValue=function(){return this._minimumValue},t.prototype.getMaximumValue=function(){return this._maximumValue},t.prototype.getValueStep=function(){return this._valueStep},t.prototype.getJson=function(){return this._adjustable?{value:this._initialValue,minimum:this._minimumValue,maximum:this._maximumValue,step:this._valueStep}:this._initialValue},t}(),a=function(){function t(t){this.resistor=t}return t.prototype.getImageInformation=function(){return{type:"commonImage",value:this.resistor.getDefinition().image+".png"}},t.prototype.getType=function(){return"number"},t.prototype.getId=function(){return this.resistor.getId()},t.prototype.getLabel=function(){return"R "+this.resistor.getPositionLabel()},t.prototype.getUnit=function(){return"Î©"},t.prototype.getValue=function(){return this.resistor.getResistance()},t}();e.ResistorDataSourceColumn=a;var h=function(t){function e(e){t.call(this,e.getId(),0,0,"light",!0),this.lightComponent=e,this.lightIntensity=0,this.overload=0,this.startOverloadTime=0,this.maxOverload=2e3,this.overloadTimeStep=50,this.overloadTimer=null,this.broken=!1,this.updatePosition()}return __extends(e,t),e.prototype.updatePosition=function(){var t=this.lightComponent.getLocation(),e=t.left+"_"+t.top,i=t.left,o=t.top;switch(this.lightComponent.getRotate()){case 0:++i;break;case 90:++o;break;case 180:--i;break;case 270:--o;break;default:console.error("unexpected rotate value from lightComponent: "+this.lightComponent.getRotate())}var n=i+"_"+o,s={cmpId1:e,cmpId2:n};this.place(s)},e.prototype.sensorStateChanged=function(){if(!this.broken){var t=this.getCurrentValue(),e=this.lightComponent.getResistance(),i=this.lightComponent.getTheVoltage(),o=i*i/e,n=t*t*e;this.lightIntensity=n/o*100,this.checkForOverloadAction()}},e.prototype.checkForOverloadAction=function(){!this.broken&&this.lightIntensity>100&&null===this.overloadTimer&&this.lightComponent.allowBurnThroughLight()&&this.overloadAction()},e.prototype.overloadAction=function(){var t=this,e=this.lightIntensity-100;if(!(e>0&&this.lightComponent.allowBurnThroughLight()))return this.overloadTimer=null,this.startOverloadTime=0;if(this.startOverloadTime){var i=e*e*(Date.now()-this.startOverloadTime)/1e3;this.overload+=i}return this.overload>this.maxOverload?(this.broken=!0,this.lightIntensity=300,null!==this.lightComponent&&this.lightComponent.getComponentChangedReporter(),setTimeout(function(){t.lightIntensity=0,t.lightComponent.switchTo("lightBroken"),t.lightComponent&&t.lightComponent.getComponentChangedReporter()},this.overloadTimeStep),void 0):(this.startOverloadTime=Date.now(),this.overloadTimer=setTimeout(this.overloadAction,this.overloadTimeStep))},e}(e.SensorModel);e.LightDisplayModel=h;var c=0,u=function(){function i(t,e){if(void 0===e&&(e=!1),this.componentConfiguration=t,this.definitionType="",this.definition=null,this.xPos=0,this.yPos=0,this.rotation=0,this.color="",this.voltageDefinition=null,this.resistanceDefinition=null,this.id="",this.sensor=null,this.dataSourceColumn=null,this.placeCounter=0,this.selected=!1,this.componentChangedReporter=null,this.allowBurnThroughLightFunction=null,this.definitionType=this.componentConfiguration.type,this.definition=s.get(this.definitionType),"undefined"==typeof this.definition)throw new Error("trying to use unknown component definitionType: "+JSON.stringify(t));if(this.xPos=t.x,this.yPos=t.y,this.rotation=t.rotate,this.color=t.color,!e&&this.componentConfiguration.id){var i=this.componentConfiguration.id.split("_");if(i.length>0){var o=parseInt(i[1]);c<o&&(c=o)}this.id=this.componentConfiguration.id}else this.id="cmp_"+ ++c;this.init()}return i.prototype.toString=function(){return"ComponentModel{id="+this.id+",type="+this.definitionType+",voltage="+this.getTheVoltage()+",resistance="+this.getResistance+"}"},i.prototype.getDefaultValueJson=function(t,e){return"number"==typeof t?t:e},i.prototype.init=function(){if(this.isPowerSupply()||this.isLight()){var e=0;e=this.isBattery()?this.definition.fixedVoltage:this.getDefaultValueJson(this.componentConfiguration.voltage,10),this.voltageDefinition=new r(e),this.setVoltage(this.voltageDefinition.getValue())}switch((this.hasImpedance()||this.isLight())&&(this.resistanceDefinition=new r(this.getDefaultValueJson(this.componentConfiguration.resistance,100)),this.setResistance(this.resistanceDefinition.getValue())),"light"===this.definitionType&&(this.sensor=new t.simulations.electricity.LightDisplayModel(this)),this.definitionType){case"resistor":this.dataSourceColumn=new t.simulations.electricity.ResistorDataSourceColumn(this)}},i.prototype.getDataSourceColumn=function(){return null},i.prototype.getSensor=function(){return this.sensor},i.prototype.getCanSwitch=function(){return!!this.definition.switchesTo},i.prototype.switchTo=function(t){this.definitionType=t?t:this.definition.switchesTo,this.definition=s.get(this.definitionType)},i.prototype.getComponentChangedReporter=function(){return this.componentChangedReporter},i.prototype.setComponentChangedReporter=function(t){this.componentChangedReporter=t},i.prototype.setAllowBurnThroughLightFunction=function(t){this.allowBurnThroughLightFunction=t},i.prototype.allowBurnThroughLight=function(){return!this.allowBurnThroughLightFunction||this.allowBurnThroughLightFunction(this)},i.prototype.getJson=function(){var t={type:this.definitionType,x:this.xPos,y:this.yPos,rotate:this.rotation,id:this.id};return(this.isResistor()||this.isLight()||this.isCapacitor()||this.isCoil())&&(t.resistance=this.resistanceDefinition.getJson()),(this.isPowerSupply()||this.isLight()||this.isOmhMeterSource())&&(t.voltage=this.isBattery()||this.isLight()||this.isOmhMeterSource()?this.voltageDefinition.getJson():0),this.color&&(t.color=this.color),t},i.prototype.getId=function(){return this.id},i.prototype.getPositionId=function(){return this.xPos+"_"+this.yPos},i.prototype.getPositionLabel=function(){return this.xPos+"-"+this.yPos},i.prototype.getDisplayId=function(){return this.xPos+"_"+this.yPos+"_"+this.definitionType},i.prototype.getComponentType=function(){return this.definitionType},i.prototype.getDefinition=function(){return this.definition},i.prototype.isNone=function(){return!1},i.prototype.isWire=function(){return this.definition.wire},i.prototype.isSwitch=function(){return this.definition.canSwitch===!0},i.prototype.isPowerSupply=function(){return this.isDcVoltageSource()||this.isBattery()||this.isOmhMeterSource()},i.prototype.isDcVoltageSource=function(){return"dcVoltageSource"===this.definitionType},i.prototype.isBattery=function(){return!(!this.definition.fixedVoltage||this.isOmhMeterSource())},i.prototype.isOmhMeterSource=function(){return"ohmMeterSource"===this.definitionType},i.prototype.isNonPowerSupplyComponent=function(){return this.isResistor()||this.isLight()||this.isCapacitor()||this.isCoil()},i.prototype.isResistor=function(){return"resistor"===this.definitionType},i.prototype.isCapacitor=function(){return"capacitor"===this.definitionType},i.prototype.isCoil=function(){return"coil"===this.definitionType},i.prototype.isLight=function(){return"light"===this.definitionType||"lightBroken"===this.definitionType},i.prototype.hasImpedance=function(){switch(this.definitionType){case"resistor":case"light":case"capacitor":case"coil":return!0;default:return!1}},i.prototype.isPowerSupplyMinus=function(t){var e=this.getRotatedDirection(t,!1);return this.isDcVoltageSource()||this.isOmhMeterSource()?"west"===e:this.isBattery()?"south"===e:(console.log("unexpected isPowerSupplyMinus call type "+this.definitionType),!1)},i.prototype.getColor=function(){return this.color},i.prototype.getVoltage=function(t,e){if(void 0===e&&(e=null),!this.isPowerSupply())return 0;var i=this.getRotatedDirection(t,!1);if(this.isDcVoltageSource()||this.isOmhMeterSource())switch(i){case"west":return this.getTheVoltage(e);case"east":return-this.getTheVoltage(e);default:return 0}else{if(!this.isBattery())return console.log("unexpected getVoltage call type "+this.definitionType),0;switch(i){case"north":return-this.getTheVoltage(e);case"south":return+this.getTheVoltage(e);default:return 0}}},i.prototype.getTheVoltage=function(t){return void 0===t&&(t=null),t&&this.isDcVoltageSource()?t.voltage.getValue().value:this.voltageDefinition?this.voltageDefinition.getValue():0},i.prototype.setVoltage=function(t){if(this.voltageDefinition)return this.voltageDefinition.setValue(t)},i.prototype.getResistance=function(){return this.resistanceDefinition?this.resistanceDefinition.getValue():0},i.prototype.setResistance=function(t){if(this.resistanceDefinition)return this.resistanceDefinition.setValue(t)},i.prototype.getImpedance=function(t){switch(this.getComponentType()){case"resistor":case"light":return e.Complex.create(this.getResistance(),0);case"coil":return e.Complex.create(0,t*this.getResistance());case"capacitor":return e.Complex.create(0,-1/Math.max(t*this.getResistance(),1e-17));default:return e.Complex.zero}},i.prototype.setLocation=function(t){this.xPos=t.left,this.yPos=t.top,this.updateLocation(),this.updateSensor()},i.prototype.updateLocation=function(){++this.placeCounter},i.prototype.updateSensor=function(){this.sensor&&this.sensor.updatePosition()},i.prototype.getLocation=function(){return{left:this.xPos,top:this.yPos}},i.prototype.getXPos=function(){return this.xPos},i.prototype.getYPos=function(){return this.yPos},i.prototype.rotate90=function(){this.rotation+=90,this.rotation>270&&(this.rotation=0),this.updateSensor()},i.prototype.rotate_90=function(){this.rotation-=90,this.rotation<0&&(this.rotation=270),this.updateSensor()},i.prototype.setRotate=function(t){switch(t){case 0:case 90:case 180:case 270:return this.rotation=t,this.updateSensor();default:return console.log("illegal angle: "+t)}},i.prototype.getRotate=function(){return this.rotation},i.prototype.hasConnection=function(t){var e=this.getRotatedDirection(t,!1);return this.definition.connections.some(function(t){return t===e})},i.prototype.getConnections=function(t){var e=this,i=this.getRotatedDirection(t,!1);return this.definition.connections.indexOf(i)>=0?this.definition.connections.filter(function(t){return t!==i}).map(function(i){return new l(e,t,e.getRotatedDirection(i,!0))}):[]},i.prototype.getDefinedNrOfConnections=function(){return this.definition.connections.length},i.prototype.getRotatedDirection=function(t,e){var i=o.indexOf(t);i<0&&console.log("unknown direction: "+t);var n=0;switch(this.rotation){case 0:n=0;break;case 90:n=1;break;case 180:n=2;break;case 270:n=3;break;default:console.log("illegal rotation: "+this.rotation)}e?i+=n:i-=n;var s=4;return i+=s,o[i%s]},i}();e.ComponentModel=u;var l=function(){function t(t,e,i){this.component=t,this.from=e,this.to=i}return t.prototype.getComponentId=function(){return this.component.getId()},t.prototype.getComponent=function(){return this.component},t.prototype.getFrom=function(){return this.from},t.prototype.getTo=function(){return this.to},t.prototype.getVoltage=function(){throw Error("should not be used")},t.prototype.getResistance=function(){throw Error("should not be used")},t.prototype.toString=function(){return"Connection, component: "+this.component.getId()+", from "+this.from+" to "+this.to},t.prototype.same=function(t){return this.getComponentId()===t.getComponentId()&&(this.getFrom()===t.getFrom()&&this.getTo()===t.getTo()||this.getFrom()===t.getTo()&&this.getTo()===t.getFrom())},t}();e.Connection=l}(i=e.electricity||(e.electricity={}))}(e=t.simulations||(t.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=componentModel.js.map
