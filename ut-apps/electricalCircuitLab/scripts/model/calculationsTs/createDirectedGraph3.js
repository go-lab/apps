var ut;!function(n){var e;!function(e){var t;!function(e){"use strict";var t=n.commons.tsutils.IdMap,o=n.commons.tsutils.IdSet,i=n.commons.tsutils.appendToArray,r=function(){function n(n){this._component=n,this._id="",this._leaves=[],this._leavesMap=new t,this._id=n.getId()}return n.prototype.getId=function(){return this._id},Object.defineProperty(n.prototype,"component",{get:function(){return this._component},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"leaves",{get:function(){return this._leaves.slice()},enumerable:!0,configurable:!0}),n.prototype.addLeave=function(n){this._leavesMap.containsKey(n._component)||(this._leaves.push(n),this._leavesMap.put(n._component,n))},n.prototype.toString=function(){var n=this._leaves.map(function(n){return n._id}).join(", ");return"ComponentTreeNode("+this._id+", ["+n+"])"},n}();e.ComponentTreeNode=r;var c=20,s=20,p=function(){function n(n,e){this._id=n,this._componentType=e}return n.prototype.getId=function(){return this._id},n.prototype.getComponentType=function(){return this._componentType},n.prototype.getDisplayId=function(){return this._id},n.prototype.isNone=function(){return!1},n}(),a=function(){function n(n,e,o){this._components=n,this._connectionPoints=e,this._connectionLinks=o,this._componentSideConnectionPointsMap=new t,this._componentConnectionPointMap=new t}return Object.defineProperty(n.prototype,"components",{get:function(){return this._components},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connectionPoints",{get:function(){return this._connectionPoints},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connectionLinks",{get:function(){return this._connectionLinks},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"componentSideConnectionPointsMap",{get:function(){return this._componentSideConnectionPointsMap},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"componentConnectionPointMap",{get:function(){return this._componentConnectionPointMap},enumerable:!0,configurable:!0}),n.prototype.findNextConnectionLinks=function(n){var e=this._connectionLinks.getFromLinks(n.toNode),t=e.filter(function(e){return e.toNode!==n.fromNode});return t},n.prototype.findNextConnectionLink=function(n){var e=this.findNextConnectionLinks(n);if(0===e.length)return null;if(1===e.length)return e[0];throw new Error("expected to find 1 next connection link, but found "+e.length)},n.prototype.createComponentConnectionPoint=function(n,e){return{in:n.connectionPoint,out:e.connectionPoint,allIn:n.connectedConnectionPoints,allOut:e.connectedConnectionPoints,inConnectionLink:this.findNextConnectionLink(n.connectionLink),outConnectionLink:this.findNextConnectionLink(e.connectionLink)}},n.prototype.addComponentConnectionPoint=function(n,e){this._componentConnectionPointMap.put(n,e)},n.prototype.printComponentConnectionPointsMaps=function(n){var e=this,t=function(n){var e=n.map(function(n){return n.toString()}).join(", ");return n.length+"* ["+e+"]"};console.log(n+":"),this._componentConnectionPointMap.keys().forEach(function(n){var o=e._componentConnectionPointMap.get(n);console.log("  "+n.getId()+": in: "+o.in.getId()+", out: "+o.out.getId()),console.log("    allIn: "+t(o.allIn)),console.log("    allOut: "+t(o.allOut)),console.log("    inConnectionLink: "+o.inConnectionLink),console.log("    outConnectionLink: "+o.outConnectionLink)})},n.prototype.printComponentSideConnectionPoints=function(n){var e=this._componentSideConnectionPointsMap.values();console.log(n+": "+e.length),e.forEach(function(n,e){console.log("  "+e+": "+n.toNiceString("      "))})},n.prototype.createComponentSequenceWithComponentConnections=function(n){for(var t=this,o=function(n,t){var r=[];if(n instanceof e.ParallelComponent){var c=n;c.parallelComponentSequences.forEach(function(n){var e=0;if(t&&(e=n.components.length-1),e>=0&&e<n.components.length){var c=o(n.components[e],t);i(r,c)}else console.warn("unexpected empty parallelComponentSequence")})}else r.push(n);return r.filter(function(n){return!n.isNone()})},r=function(n,i){var r=new e.ComponentConnectionInformationFinder(t,o(n,!0),o(i,!1));return r.componentConnection},c=[],s=n.components,p=1;p<s.length;p++){var a=r(s[p-1],s[p]);null!==a?c.push(a):console.warn("unexpected null value of componentConnection")}var u=s.map(function(n){if(n instanceof e.ParallelBatteries){var o=n,i=o.parallelComponentSequences.map(function(n){return t.createComponentSequenceWithComponentConnections(n)});return new e.ParallelBatteries(i,o.batteryVoltage)}if(n instanceof e.ParallelComponent){var r=n,i=r.parallelComponentSequences.map(function(n){return t.createComponentSequenceWithComponentConnections(n)});return new e.ParallelComponent(i)}return n});return new e.ComponentSequence(u,c)},n}();e.DirectedGraphInformation=a;var u=new p("root","dcVoltageSource"),l=function(){function n(n,o,i,r){return this._components=n,this._connectionPoints=o,this._connectionLinks=i,this._startConnectionLink=r,this._debug=e.debugModelCalculations,this._directedGraphInformation=null,this._treeNodeMap=new t,this._componentTreeRoot=null,this._createTreeNesting=0,this._rawComponentSequences=[],this._simplifiedComponentSequences=[],this._flatComponentSequences=[],this._finalComponentSequences=[],this._completeComponentSequences=[],this._startComponent=null,this._startConnectionPoint=null,this._endConnectionPoint=null,this._startOneComponentSideConnectionPoints=null,this._result={state:"not started",error:!0,componentSequence:null,componentConnectionPointMap:null},this.simplifyComponentSequenceNesting=0,e.resetComponentConnectionInformationFinderNesting(),this._directedGraphInformation=new a(n,o,i),this._startComponent=this._startConnectionLink.component,this._startConnectionPoint=this._startConnectionLink.toNode,this._endConnectionPoint=this._startConnectionLink.fromNode,this._debug&&(console.log("CreateDirectedGraph3()"),console.log("  this._startConnectionLink: "+this._startConnectionLink.getId()),console.log("  this._startComponent: "+this._startComponent.getId()),console.log("  this._startConnectionPoint: "+this._startConnectionPoint.getId()),console.log("  this._endConnectionPoint: "+this._endConnectionPoint.getId())),e.createComponentSideConnectionPointsMap(this._directedGraphInformation),this._debug&&this._directedGraphInformation.printComponentSideConnectionPoints("Component side connection points"),this.containsShortCircuit()?(this._result.state="shortCircuit",void(this._result.error=!0)):(this._startOneComponentSideConnectionPoints=this._directedGraphInformation.componentSideConnectionPointsMap.get(this._startComponent).getSideByConnectionLink(this._startConnectionLink),this._componentTreeRoot=this.createTreeNode(u,this._startComponent,this._startOneComponentSideConnectionPoints.connectedComponents),this._debug&&this.printComponentTree(),this.findRawComponentSequences(),this._debug&&this.printComponentSequences("raw component sequences",this._rawComponentSequences),void(0===this._rawComponentSequences.length?this._result.state="brokenCircuitFound":this._result.state="circuitFound"))}return n.prototype.createCircuit=function(){if(this._debug&&console.log("Creating circuit for power supply "+this._startComponent.getId()),this.findComponentConnectionPointsForComponentSequences(this._rawComponentSequences),this._debug&&this._directedGraphInformation.printComponentConnectionPointsMaps("Component connection points map"),this._simplifiedComponentSequences=this.simplifyComponentSequences(this._rawComponentSequences),this._debug&&this.printComponentSequences("Simplified component sequences",this._simplifiedComponentSequences),this._flatComponentSequences=this.flattenNestedParallelComponents(this._simplifiedComponentSequences),this._debug&&this.printComponentSequences("Flat component sequences",this._flatComponentSequences),this._finalComponentSequences=this.replaceParallelBatteries(this._flatComponentSequences),this._debug&&this.printComponentSequences("Final component sequences",this._finalComponentSequences),this._completeComponentSequences=this.createComponentSequencesWithComponentConnections(this._finalComponentSequences),this._debug&&this.printComponentSequences("Complete component sequences",this._completeComponentSequences),this._debug&&this._directedGraphInformation.printComponentConnectionPointsMaps("Complete component connection points map"),1!==this._completeComponentSequences.length)throw new Error("Only one complete component sequences (per circuit) supported, but found "+this._completeComponentSequences.length);this._result.state="circuitFound",this._result.error=!1,this._result.componentSequence=this._completeComponentSequences[0],this._result.componentConnectionPointMap=this._directedGraphInformation.componentConnectionPointMap},n.prototype.createBrokenCircuit=function(){var n=this;this._debug&&console.log("Creating broken circuit for power supply "+this._startComponent.getId());var t=function(){var e=n._directedGraphInformation.componentSideConnectionPointsMap.get(n._startComponent);return n._startComponent.isPowerSupplyMinus(e.side2.connectionPoint.getDirection(n._startComponent))?[e.side1,e.side2]:[e.side2,e.side1]},o=t(),i=o[0],r=o[1];this._directedGraphInformation.addComponentConnectionPoint(this._startComponent,this._directedGraphInformation.createComponentConnectionPoint(r,i));var c=new e.ComponentConnectionInformationFinder(this._directedGraphInformation,[this._startComponent],[]).componentConnection,s=new e.ComponentConnectionInformationFinder(this._directedGraphInformation,[],[this._startComponent]).componentConnection,p=[new e.NonComponent(0,0),this._startComponent,new e.NonComponent(0,0)],a=[s,c],u=new e.ComponentSequence(p,a.filter(function(n){return null!==n}));this._debug&&(this.printComponentSequences("Final broken component sequence",[u]),this._directedGraphInformation.printComponentConnectionPointsMaps("Component connection points map")),this._result.state="brokenCircuitFound",this._result.error=!1,this._result.componentSequence=u,this._result.componentConnectionPointMap=this._directedGraphInformation.componentConnectionPointMap},Object.defineProperty(n.prototype,"result3",{get:function(){return this._result},enumerable:!0,configurable:!0}),n.prototype.printComponentTree=function(){this._treeNodeMap.values().forEach(function(n){console.log(n.toString())})},n.prototype.printComponentSequences=function(n,e){console.log(n+":"),e.forEach(function(n,e){console.log(" "+e+": "+n.toNiceString("  "))})},n.prototype.containsShortCircuit=function(){var n=this;return this._directedGraphInformation.componentSideConnectionPointsMap.keys().some(function(e){var t=n._directedGraphInformation.componentSideConnectionPointsMap.get(e);return t.component.isPowerSupply()&&t.shortCircuit})},n.prototype.createTreeNode=function(n,e,t){var i=this;if(this._createTreeNesting++,this._createTreeNesting>c)return console.warn("createTreeNode() is going to deep, probably something is wrong"),null;var s=function(n,e){var t=function(n){return n===i._startComponent&&e.connectedConnectionPoints.indexOf(i._startConnectionPoint)>=0};e.connectedComponents.filter(function(n){return!t(n)}).forEach(function(e){return n.add(e)})},p=new r(n);if(this._treeNodeMap.put(n,p),n!==this._startComponent){var a=t.map(function(n){if(i._treeNodeMap.containsKey(n))return i._treeNodeMap.get(n);var e=i._directedGraphInformation.componentSideConnectionPointsMap.get(n),t=new o;return s(t,e.side1),s(t,e.side2),i.createTreeNode(n,n,t.toArray())});a.forEach(function(n){p.addLeave(n)})}return this._createTreeNesting--,p},n.prototype.findRawComponentSequences=function(){var n=new o;this.walkTreeForComponentSequences(this._componentTreeRoot,[this._startComponent],n)},n.prototype.walkTreeForComponentSequences=function(n,t,o){var i=this;if(n.leaves.some(function(n){return n.component===i._startComponent})){var r=new e.ComponentSequence(t.concat(this._startComponent));this._rawComponentSequences.push(r)}else{var c=n.leaves.filter(function(n){return!o.contains(n)}),s=o.clone();c.forEach(function(n){s.add(n)}),c.forEach(function(n){i.walkTreeForComponentSequences(n,t.concat(n.component),s)})}},n.prototype.findParallelComponentSequence=function(n,t,o){for(var r=n.components,c=t.components,s=null,p=null,a=0,u=0;a<r.length&&u<c.length;){var l=r[a],m=c[u];if(l===m){if(s){var h=new e.ParallelComponent([new e.ComponentSequence(s),new e.ComponentSequence(p)]);o.push(h),s=null,p=null}a++,u++}else{s||(s=[],p=[]);var C=c.indexOf(l,u);if(C>=0)i(p,c.slice(u,C)),u=C;else{var f=r.indexOf(m,a);f>=0?(i(s,r.slice(a,f)),a=f):(s.push(l),p.push(m),a++,u++)}}}},n.prototype.findParallelComponents=function(n){var e=this,t=[];return n.forEach(function(o,i){for(var r=i+1;r<n.length;r++)e.findParallelComponentSequence(o,n[r],t)}),t},n.prototype.removeDuplicateParallelComponents=function(n){return n.filter(function(e,t){for(var o=0;o<t;o++)if(e.equals(n[o]))return!1;return!0})},n.prototype.findNextReplaceableParallelComponent=function(n){if(0===n.length)throw new Error("there are no parallelComponents");if(1===n.length)return n[0];var e=n.filter(function(e){for(var t=0,o=n;t<o.length;t++){var i=o[t];if(i!==e&&e.isSubParallelComponent(i))return!1}return!0});if(e.length>=0)return e[0];throw new Error("there are no smallestParallelComponents, while there are parallelComponents")},n.prototype.removeDuplicateComponentSequences=function(n){return n.filter(function(e,t){for(var o=0;o<t;o++)if(e.equals(n[o]))return!1;return!0})},n.prototype.placeParallelComponent=function(n,t){var o=n.map(function(n){var o=n;return t.parallelComponentSequences.forEach(function(n){var r=o.indexOfSubSequence(n);if(r>=0){var c=o.components.slice(0,r);c.push(t),i(c,o.components.slice(r+n.components.length)),o=new e.ComponentSequence(c)}}),o});return this.removeDuplicateComponentSequences(o)},n.prototype.simplifyComponentSequences=function(n){if(this.simplifyComponentSequenceNesting++,this.simplifyComponentSequenceNesting>s)return console.warn("Reached maxSimplifyComponentSequenceNesting, probably there is something wrong"),n;if(n.length<=1)return n;var e=this.findParallelComponents(n),t=this.removeDuplicateParallelComponents(e),o=this.findNextReplaceableParallelComponent(t),i=this.placeParallelComponent(n,o),r=this.simplifyComponentSequences(i);return this.simplifyComponentSequenceNesting--,r},n.prototype.flattenParallelComponent=function(n){var t=this,o=[];return n.parallelComponentSequences.forEach(function(n){var r=!1;if(1===n.components.length){var c=n.components[0];if(c instanceof e.ParallelComponent){var s=t.flattenParallelComponent(c);i(o,s.parallelComponentSequences),r=!0}}r||o.push(t.flattenNestedParallelComponentsInComponentSequence(n))}),new e.ParallelComponent(o)},n.prototype.flattenNestedParallelComponentsInComponentSequence=function(n){var t=this,o=[];return n.components.forEach(function(n){n instanceof e.ParallelComponent?o.push(t.flattenParallelComponent(n)):o.push(n)}),new e.ComponentSequence(o)},n.prototype.flattenNestedParallelComponents=function(n){var e=this;return n.map(function(n){return e.flattenNestedParallelComponentsInComponentSequence(n)})},n.prototype.replaceParallelBatteriesInComponentSequence=function(n){var t=this,o=function(n){if(n instanceof e.ComponentModel){var t=n;return t.isBattery()}return!1},r=function(n){if(n.isPowerSupply()){var e=t._directedGraphInformation.componentConnectionPointMap.get(n),o=e.in.getDirection(n);return n.getVoltage(o)}return 0},c=function(n,e){var t=function(n){if(1===n.components.length&&o(n.components[0])){var t=n.components[0];return r(t)===e}return!1},i=[],c=[];return n.parallelComponentSequences.forEach(function(n){t(n)?i.push(n):c.push(n)}),[i,c]},s=function(n){var o=function(n){if(n instanceof e.ParallelComponent){var o=n;s(o.parallelComponentSequences)}else{var i=n,r=t._directedGraphInformation.componentConnectionPointMap.get(i);t._directedGraphInformation.addComponentConnectionPoint(i,{in:r.out,out:r.in,allIn:r.allOut,allOut:r.allIn,inConnectionLink:r.outConnectionLink,outConnectionLink:r.inConnectionLink})}},i=function(n){n.components.forEach(function(n){o(n)})};n.forEach(function(n){i(n)})},p=n.components;if(3===p.length&&o(p[0])){var a=p[0],u=r(a);if(p[1]instanceof e.ParallelComponent){var l=p[1],m=c(l,-u),h=m[0],C=m[1];if(h.length>0){s(h);var f=new e.ComponentSequence([a]),d=new e.ParallelBatteries(h.concat(f),u),_=[];if(_.push(d),1===C.length)i(_,C[0].components);else if(C.length>1){var g=new e.ParallelComponent(C);_.push(g)}return _.push(d),new e.ComponentSequence(_)}}}return n},n.prototype.replaceParallelBatteries=function(n){var e=this;return n.map(function(n){return e.replaceParallelBatteriesInComponentSequence(n)})},n.prototype.findComponentConnectionPointsForComponentSequence=function(n){for(var e=this,t=function(n,t){var o=function(){var o=e._directedGraphInformation.componentSideConnectionPointsMap.get(n),i=null;i=n===e._startComponent?e._startOneComponentSideConnectionPoints:t===e._startComponent?o.getSideWithConnectionPoint(e._endConnectionPoint):o.getSideByComponent(t);var r=null;return r=o.side1===i?o.side2:o.side1,[r,i]},i=o(),r=i[0],c=i[1];e._directedGraphInformation.addComponentConnectionPoint(n,e._directedGraphInformation.createComponentConnectionPoint(r,c))},o=n.components,i=0;i<o.length-1;i++){var r=o[i];if(!this._directedGraphInformation.componentConnectionPointMap.containsKey(r)){var c=o[i+1];t(r,c)}}},n.prototype.findComponentConnectionPointsForComponentSequences=function(n){var e=this;n.forEach(function(n){e.findComponentConnectionPointsForComponentSequence(n)})},n.prototype.createComponentSequencesWithComponentConnections=function(n){var e=this;return n.map(function(n){return e._directedGraphInformation.createComponentSequenceWithComponentConnections(n)})},n}();e.CreateDirectedGraph3=l}(t=e.electricity||(e.electricity={}))}(e=n.simulations||(n.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=createDirectedGraph3.js.map
