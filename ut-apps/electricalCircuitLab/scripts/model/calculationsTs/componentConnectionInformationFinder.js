var __extends=this&&this.__extends||function(n,t){function e(){this.constructor=n}for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);n.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)},ut;!function(n){var t;!function(t){var e;!function(t){"use strict";function e(){f=0}var o=n.commons.tsutils.IdMap,i=n.commons.tsutils.IdSet,r=n.commons.tsutils.appendToArray,c=function(){function n(n,t,e){this._directedGraphInformation=n,this._connectionLink=t,this._outConnectionPoints=e,this._foundRoutes=new o,e.contains(t.fromNode)?this.foundRoute(t.fromNode,[]):this.walkConnectionLinks([t],new i,[]),this._foundRoutes.length!==e.length&&console.error("wrong number of found routes: "+this._foundRoutes.length+", expected: "+e.length)}return Object.defineProperty(n.prototype,"foundRoutes",{get:function(){return this._foundRoutes},enumerable:!0,configurable:!0}),n.prototype.foundRoute=function(n,t){if(this._foundRoutes.containsKey(n)){var e=this._foundRoutes.get(n);t.length<e.length&&this._foundRoutes.put(n,t)}else this._foundRoutes.put(n,t)},n.prototype.walkConnectionLinks=function(n,t,e){var o=this;n.forEach(function(n){var i=n.toNode;if(!t.contains(i))if(t.add(i),o._outConnectionPoints.contains(i))o.foundRoute(i,e);else if(n.component.isWire()){var r=o._directedGraphInformation.findNextConnectionLinks(n);if(r.length>0){var c=e.slice();c.push(i),o.walkConnectionLinks(r,t.clone(),c)}}})},n}(),u=function(){function n(){this._dependingConnectionPointIds=[]}return n.prototype.getNrOfDependencies=function(){return this._dependingConnectionPointIds.length},n.prototype.getDependencies=function(){return this._dependingConnectionPointIds},n.prototype.summedCurrent=function(n,t){var e=0;return n.forEach(function(n){e+=t.get(n).current}),e},n.prototype.summedAcCurrent=function(n,e){var o=t.Complex.zero;return n.forEach(function(n){o=o.add(e.get(n).acCurrent)}),o},n}();t.CurrentRecipe=u;var s=function(n){function e(){n.apply(this,arguments)}return __extends(e,n),e.prototype.getCurrent=function(n){return 0},e.prototype.getAcCurrent=function(n){return t.Complex.zero},e.prototype.toString=function(){return"ZeroCurrentRecipe()"},e}(u);t.ZeroCurrentRecipe=s,t.zeroCurrentRecipe=new s;var d=function(n){function e(t,e,o,i,r){n.call(this),this._previousConnectionPointId=t,this._nextConnectionPointId=e,this._inConnectionPointId=o,this._outConnectionPointId=i,this._outConnectionPointIds=r,this._dependingConnectionPointIds=r.slice(),this._dependingConnectionPointIds.push(o)}return __extends(e,n),e.prototype.getCurrent=function(n){var t=n.get(this._inConnectionPointId).current;if(0===t)return 0;var e=n.get(this._outConnectionPointId).current,o=0;return this._outConnectionPointIds.forEach(function(t){var e=n.get(t);o+=e.current}),e/o*t},e.prototype.getAcCurrent=function(n){var e=n.get(this._inConnectionPointId).acCurrent;if(e.isZero())return e;var o=n.get(this._outConnectionPointId).acCurrent,i=t.Complex.zero;return this._outConnectionPointIds.forEach(function(t){var e=n.get(t);i=i.add(e.acCurrent)}),o.divide(i).multiply(e)},Object.defineProperty(e.prototype,"previousConnectionPointId",{get:function(){return this._previousConnectionPointId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextConnectionPointId",{get:function(){return this._nextConnectionPointId},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return"PartConnectionPointCurrent("+this._previousConnectionPointId+", "+this._nextConnectionPointId+", "+(this._inConnectionPointId+", "+this._outConnectionPointId+", ["+this._outConnectionPointIds.join(", ")+"])")},e}(u);t.PartConnectionPointCurrentRecipe=d;var p=function(n){function e(t){n.call(this),this._currentRecipes=t;var e=new i;t.forEach(function(n){return e.addAll(n.getDependencies())}),this._dependingConnectionPointIds=e.toArray()}return __extends(e,n),e.prototype.getCurrent=function(n){var t=0,e=this._currentRecipes[0].previousConnectionPointId;return this._currentRecipes.forEach(function(o){o.previousConnectionPointId===e?t+=o.getCurrent(n):t-=o.getCurrent(n)}),t},e.prototype.getAcCurrent=function(n){var e=t.Complex.zero,o=this._currentRecipes[0].previousConnectionPointId;return this._currentRecipes.forEach(function(t){e=t.previousConnectionPointId===o?e.add(t.getAcCurrent(n)):e.subtract(t.getAcCurrent(n))}),e},e.prototype.toString=function(){return"SummedCurrentRecipes(["+this._currentRecipes.map(function(n){return n.toString()})+"])"},e}(u);t.SummedCurrentRecipes=p;var a=function(n){function e(t){n.call(this,t)}return __extends(e,n),e.prototype.getCurrent=function(n){var t=0,e=0,o=this._currentRecipes[0].previousConnectionPointId,i=this._currentRecipes[0].nextConnectionPointId;return this._currentRecipes.forEach(function(r){var c=r.getCurrent(n);r.previousConnectionPointId===o&&(t+=c),r.nextConnectionPointId===i&&(e+=c)}),Math.max(t,e)},e.prototype.getAcCurrent=function(n){var e=t.Complex.zero,o=t.Complex.zero,i=this._currentRecipes[0].previousConnectionPointId,r=this._currentRecipes[0].nextConnectionPointId;return this._currentRecipes.forEach(function(t){var c=t.getAcCurrent(n);t.previousConnectionPointId===i&&(e=e.add(c)),t.nextConnectionPointId===r&&(o=o.add(c))}),e.max(o)},e.prototype.toString=function(){return"SplitSummedCurrentRecipes(["+this._currentRecipes.map(function(n){return n.toString()})+"])"},e}(p);t.SplitSummedCurrentRecipes=a;var h=function(){function n(n,t){this._currentRecipe=n,this._connectionPointId=t,this._id="",this._id="CurrentRecipeForConnectionPoint("+this._currentRecipe+", "+this._connectionPointId+")"}return Object.defineProperty(n.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentRecipe",{get:function(){return this._currentRecipe},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connectionPointId",{get:function(){return this._connectionPointId},enumerable:!0,configurable:!0}),n.prototype.toString=function(){return this._id},n}();t.CurrentRecipeForConnectionPoint=h;var f=0;t.resetComponentConnectionInformationFinderNesting=e;var C=function(){function n(n,e,i){return this._directedGraphInformation=n,this._debug=t.debugModelCalculations,this._inConnectionPoints=[],this._outConnectionPoints=[],this._deadEndConnectionPoints=[],this._deadComponentConnectionPoints=[],this._internalConnectionPoints=[],this._inConnectionLinks=[],this._outConnectionLinks=[],this._deadEndConnectionLinks=[],this._deadEndComponentSequences=[],this._currentRecipeMap=new o,this._currentRecipeForConnectionPoints=[],this._componentConnection=null,++f,f>20?void console.error("to many nested calls of ComponentConnectionInformationFinder, probably something is wrong"):(this.collectConnectionPoints(e,i),this.findConnectionCurrentRecipeByTheShortestRoute(),this.createOrderedCurrentRecipes(),this._componentConnection=new t.ComponentConnection(this._inConnectionPoints,this._outConnectionPoints,this._internalConnectionPoints,this._currentRecipeForConnectionPoints,this._deadEndComponentSequences),void--f)}return Object.defineProperty(n.prototype,"componentConnection",{get:function(){return this._componentConnection},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"inConnectionPoints",{get:function(){return this._inConnectionPoints},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"outConnectionPoints",{get:function(){return this._outConnectionPoints},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"internalConnectionPoints",{get:function(){return this._internalConnectionPoints},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentRecipeForConnectionPoints",{get:function(){return this._currentRecipeForConnectionPoints},enumerable:!0,configurable:!0}),n.prototype.createDeadEndComponentSequence=function(n,e,o,r){var c=this,u=new i,s=function(n,t){var e=c._directedGraphInformation.componentSideConnectionPointsMap.get(n),o=e.getOtherSideBySide(t);c._directedGraphInformation.addComponentConnectionPoint(n,c._directedGraphInformation.createComponentConnectionPoint(o,t))},d=function(n,e){if(r.contains(n.connectionPoint))throw new Error("dead component sequence walked back into the component connection");u.addAll(n.connectedConnectionPoints);var i=n.connectedComponents;switch(i.length){case 0:e.push(new t.NonComponent(0,0));break;case 1:var p=i[0];e.push(p);var a=c._directedGraphInformation.componentSideConnectionPointsMap.get(p).getOtherSideByConnectionPoint(n.connectionPoint);s(p,a),o.contains(p)||d(a,e);break;default:var h=i.filter(function(n){return o.contains(n)});if(0===h.length){var f=i.map(function(e){var o=[e],i=c._directedGraphInformation.componentSideConnectionPointsMap.get(e).getOtherSideByConnectionPoint(n.connectionPoint);s(e,i),d(i,o);var r=new t.ComponentSequence(o);return r}),C=new t.ParallelComponent(f);e.push(C)}else e.push(h[0])}},p=[];p.push(n);var a=this._directedGraphInformation.componentSideConnectionPointsMap.get(n).getOtherSideByConnectionPoint(e);s(n,a),d(a,p);var h=p.filter(function(n){return!n.isNone()}).length;if(h>0){var f=new t.ComponentSequence(p);return f}return null},n.prototype.collectConnectionPoints=function(n,e){var o=this,c=function(){if(n.length!==e.length)return!1;for(var t=0;t<n.length;t++)if(n[t]!==e[t])return!1;return!0},u=new i;n.length>0&&(u.addAll(this._directedGraphInformation.componentConnectionPointMap.get(n[0]).allOut),n.forEach(function(n){var t=o._directedGraphInformation.componentConnectionPointMap.get(n);t&&(o._inConnectionPoints.push(t.out),t.outConnectionLink&&o._inConnectionLinks.push(t.outConnectionLink))})),c()||e.forEach(function(t){var e=o._directedGraphInformation.componentConnectionPointMap.get(t);e&&(e.inConnectionLink&&o._outConnectionLinks.push(e.inConnectionLink),o._outConnectionPoints.push(e.in),0===n.length&&u.addAll(e.allIn))});var s=n.concat(e),d=function(n){return!n.isWire()&&s.indexOf(n)<0},p=new i,a=(new i,new i);u.toArray().forEach(function(n){var t=o._directedGraphInformation.connectionLinks.getFromLinks(n);if(1===t.length)o._deadEndConnectionPoints.push(n),o._deadEndConnectionLinks.push(t[0]);else{var e=null;d(n.getComponent1())?e=n.getComponent1():d(n.getComponent2())&&(e=n.getComponent2()),e&&(a.contains(e)?a.remove(e):(o._deadEndConnectionPoints.push(n),a.add(e)))}});var h=[],f=new i;a.toArray().forEach(function(n,t){var e=o.createDeadEndComponentSequence(n,o._deadEndConnectionPoints[t],a,u);if(e){if(f.containsAll(e.realComponents))throw new Error("looped dead end not supported");h.push(e),f.addAll(e.realComponents)}}),this._deadEndComponentSequences=h.map(function(n){return o._directedGraphInformation.createComponentSequenceWithComponentConnections(n)}),r(this._deadComponentConnectionPoints,p.toArray()),u.removeAll(this._inConnectionPoints),u.removeAll(this._outConnectionPoints),this._internalConnectionPoints=u.toArray(),this._debug&&(console.log("_inConnectionPoints: "+t.Node.nodesToIdsString(this._inConnectionPoints)),console.log("_outConnectionPoints: "+t.Node.nodesToIdsString(this._outConnectionPoints)),console.log("_internalConnectionPoints: "+t.Node.nodesToIdsString(this._internalConnectionPoints)),console.log("_deadEndConnectionPoints: "+t.Node.nodesToIdsString(this._deadEndConnectionPoints)),console.log("_deadComponentConnectionPoints: "+t.Node.nodesToIdsString(this._deadComponentConnectionPoints)))},n.prototype.findConnectionCurrentRecipeByTheShortestRoute=function(){var n=this,e=new i;e.addAll(this._outConnectionPoints);var r=[],u=[];this._inConnectionLinks.forEach(function(o,i){var s=new c(n._directedGraphInformation,o,e);n._debug&&console.log("inConnectionPoint: "+n._inConnectionPoints[i].getId()),s.foundRoutes.keys().forEach(function(e){var o=s.foundRoutes.get(e);r.push({inConnectionPoint:n._inConnectionPoints[i],outConnectionPoint:e,routeConnectionPoints:o}),n._debug&&console.log("  "+e.getId()+": "+t.Node.nodesToIdsString(o))}),u.push(s.foundRoutes)});var s=r.sort(function(n,t){return n.routeConnectionPoints.length-t.routeConnectionPoints.length}),h=new o,f=this._outConnectionPoints.map(function(n){return n.getId()});s.forEach(function(n){var t=n.inConnectionPoint;n.routeConnectionPoints.forEach(function(e,o){var i=null;i=o+1<n.routeConnectionPoints.length?n.routeConnectionPoints[o+1]:n.outConnectionPoint;var r=new d(t.getId(),i.getId(),n.inConnectionPoint.getId(),n.outConnectionPoint.getId(),f);h.getOrElseUpdate(e,[]).push(r),t=e})}),h.keys().forEach(function(t){var e=h.get(t);1===e.length?n._currentRecipeMap.put(t,e[0]):t.isArtificial()?n._currentRecipeMap.put(t,new a(e)):n._currentRecipeMap.put(t,new p(e))}),this._internalConnectionPoints.filter(function(n){return!h.containsKey(n)}).forEach(function(e){return n._currentRecipeMap.put(e,t.zeroCurrentRecipe)})},n.prototype.createOrderedCurrentRecipes=function(){var n=this,t=this._currentRecipeMap.keys().map(function(t){return new h(n._currentRecipeMap.get(t),t.getId())}),e=new o;this._inConnectionPoints.forEach(function(n){e.put(n.getId(),null)}),this._outConnectionPoints.forEach(function(n){e.put(n.getId(),null)});var i=function(t){n._currentRecipeForConnectionPoints.push(t),e.put(t.connectionPointId,t)},r=[];t.forEach(function(n){0===n.currentRecipe.getNrOfDependencies()?i(n):r.push(n)});for(var c=function(n){for(var t=0,o=n;t<o.length;t++){var i=o[t];if(!e.containsKey(i))return!1}return!0},u=!0;r.length>=0&&u;){var s=r.length;r.slice().forEach(function(n){if(c(n.currentRecipe.getDependencies())){i(n);var t=r.indexOf(n);t>=0&&r.splice(t,1)}}),u=r.length<s}r.length>0&&(console.warn("failed to order all currentRecipeForConnectionPoints"),r.forEach(function(n,t){console.warn(" "+t+": "+n.connectionPointId+" -> "+n.currentRecipe)}))},n}();t.ComponentConnectionInformationFinder=C}(e=t.electricity||(t.electricity={}))}(t=n.simulations||(n.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=componentConnectionInformationFinder.js.map
