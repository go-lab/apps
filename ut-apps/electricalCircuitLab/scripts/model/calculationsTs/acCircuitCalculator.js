var ut;!function(e){var t;!function(t){var n;!function(t){"use strict";var n=e.commons.tsutils.IdMap,o=function(){function e(e,o,c){void 0===c&&(c=!1),this._circuitResult=e,this._powerModel=o,this._acMode=c,this._debug=t.debugModelCalculations,this._connectionPointStates=new n,this._frequency=0,this._omega=0,this.updatePowerValues()}return Object.defineProperty(e.prototype,"powerModel",{get:function(){return this._powerModel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"omega",{get:function(){return this._omega},enumerable:!0,configurable:!0}),e.prototype.setAcMode=function(e){return e!==this._acMode&&(this._acMode=e,!0)},e.prototype.updatePowerValues=function(){this._acMode&&this._powerModel?(this._frequency=this._powerModel.frequency.getValue().value,this._omega=2*Math.PI*this._frequency):(this._omega=0,this._frequency=0),this._debug&&console.log("AcCircuitCalculator: acMode: "+this._acMode+", "+("frequency: "+this._frequency.toPrecision(t.outputPrecision)+", omega: "+this._omega.toPrecision(t.outputPrecision)))},e.prototype.getComponentVoltage=function(e){if(e.isPowerSupply()){var t=this._circuitResult.componentConnectionPointMap.get(e.getId()),n=t.in.getDirection(e);return e.getVoltage(n,this._powerModel)}return 0},e.prototype.getComponentAcVoltage=function(e){var n=this.getComponentVoltage(e);return t.Complex.create(n)},e.prototype.calculateComponent=function(e,n){var o=this;if(e instanceof t.ParallelBatteries){var c=e,i={voltage:c.batteryVoltage,resistance:0,acVoltage:t.Complex.create(c.batteryVoltage),impedance:t.Complex.zero};return c.circuitProperties=i,i}if(e instanceof t.ParallelComponent){var a=e,r=0,u=t.Complex.zero;a.parallelComponentSequences.forEach(function(e){var c=o.calculateComponentSequence(e,n);if(!n&&!c.acVoltage.isZero())throw new Error("powerSupplyInBranch");if(c.impedance.isZero()){if(!n)throw new Error("lateShortCircuit")}else r+=1/c.resistance,u=u.add(t.Complex.one.divide(c.impedance))});var i={voltage:0,resistance:1/r,acVoltage:t.Complex.zero,impedance:t.Complex.one.divide(u)};return a.circuitProperties=i,i}var s=e;return{voltage:this.getComponentVoltage(s),resistance:s.getResistance(),acVoltage:this.getComponentAcVoltage(s),impedance:s.getImpedance(this._omega)}},e.prototype.calculateComponentSequence=function(e,n){var o=this,c=0,i=0,a=t.Complex.zero,r=t.Complex.zero;e.components.forEach(function(e){var t=o.calculateComponent(e,n);c+=t.voltage,i+=t.resistance,a=a.add(t.acVoltage),r=r.add(t.impedance)}),e.componentConnections&&e.componentConnections.forEach(function(e){e.deadEndComponentSequences&&e.deadEndComponentSequences.forEach(function(e){return o.calculateComponentSequence(e,!0)})});var u={voltage:c,resistance:i,acVoltage:a,impedance:r};return e.circuitProperties=u,u},e.prototype.calculateGraphProperties=function(e,t){var n=this.calculateComponentSequence(e,t);return this._circuitResult.circuitProperties=n,n},e.prototype.calculateTotalCurrent=function(e,n){var o=Date.now();this.updatePowerValues();var c=this.calculateGraphProperties(e,n);this._debug&&console.log("circuitProperties: acVoltage: "+c.acVoltage.toExtendedString(t.outputPrecision)+", impedance: "+c.impedance.toExtendedString(t.outputPrecision));var i=t.Complex.zero;if(!n&&!c.acVoltage.isZero())if(c.impedance.isZero()){if(1!==e.components.length)throw new Error("lateShortCircuit")}else i=c.acVoltage.divide(c.impedance);var a=Date.now()-o;return this._debug&&(console.log("calculateCircuit took "+a+" ms."),console.log("total current: "+i.toExtendedString(t.outputPrecision))),i},e.prototype.calculateComponentConnectionState=function(e,n,o){var c=this,i=t.Complex.zero;if(o instanceof t.ParallelBatteries){var a=o,r=e.divide(t.Complex.create(a.parallelComponentSequences.length));a.parallelComponentSequences.forEach(function(e){c.calculateComponentSequenceConnectionStates(r,n,e)}),i=n.add(t.Complex.create(a.batteryVoltage))}else if(o instanceof t.ParallelComponent){var u=o;u.parallelComponentSequences.forEach(function(o){var i=t.Complex.zero;e.isZero()||o.circuitProperties.impedance.isZero()||(i=u.circuitProperties.impedance.divide(o.circuitProperties.impedance).multiply(e)),c.calculateComponentSequenceConnectionStates(i,n,o)}),i=n.add(u.circuitProperties.acVoltage).subtract(u.circuitProperties.impedance.multiply(e))}else if(o instanceof t.NonComponent);else{var s=o,l=this._circuitResult.componentConnectionPointMap.get(s);i=n.subtract(e.multiply(s.getImpedance(this._omega))).add(this.getComponentAcVoltage(s)),this.setConnectionPointState(l.in,n,e),this.setConnectionPointState(l.out,i,e)}return i},e.prototype.calculateComponentSequenceConnectionStates=function(e,n,o){var c=this,i=n,a=o.components,r=o.componentConnections;return a.forEach(function(n,o){var a=i;if(i=c.calculateComponentConnectionState(e,a,n),r&&o<r.length){var u=r[o];u.deadEndComponentSequences.forEach(function(e){return c.calculateComponentSequenceConnectionStates(t.Complex.zero,i,e)})}}),i},e.prototype.calculateComponentConnectionCurrents=function(e){var n=this;if(e.currentRecipeForConnectionPoints.length>0){var o=t.Complex.zero;e.incomingConnectionPoints.length>0?o=this.getConnectionPointState(e.incomingConnectionPoints[0]).acVoltage:e.outgoingConnectionPoints.length>0&&(o=this.getConnectionPointState(e.outgoingConnectionPoints[0]).acVoltage),e.currentRecipeForConnectionPoints.forEach(function(e){n.setConnectionPointStateById(e.connectionPointId,o,e.currentRecipe.getAcCurrent(n._connectionPointStates))})}e.deadEndComponentSequences.forEach(function(e){return n.calculateComponentSequenceComponentConnectionCurrents(e)})},e.prototype.calculateComponentSequenceComponentConnectionCurrents=function(e){var n=this;e.componentConnections&&e.componentConnections.forEach(function(e){n.calculateComponentConnectionCurrents(e)}),e.components.forEach(function(e){if(e instanceof t.ParallelComponent){var o=e;o.parallelComponentSequences.forEach(function(e){n.calculateComponentSequenceComponentConnectionCurrents(e)})}})},e.prototype.calculateConnectionStates=function(e,n,o){void 0===o&&(o=0),this.calculateComponentSequenceConnectionStates(e,t.Complex.create(o),n),this.calculateComponentSequenceComponentConnectionCurrents(n)},e.prototype.getConnectionPointStateById=function(e){return this._connectionPointStates.containsKey(e)||this._connectionPointStates.put(e,{voltage:0,current:0,acVoltage:t.Complex.zero,acCurrent:t.Complex.zero}),this._connectionPointStates.get(e)},e.prototype.getConnectionPointState=function(e){return this.getConnectionPointStateById(e.getId())},e.prototype.setConnectionPointStateById=function(e,t,n){var o=this.getConnectionPointStateById(e);o.acVoltage=t,o.acCurrent=n},e.prototype.setConnectionPointState=function(e,t,n){this.setConnectionPointStateById(e.getId(),t,n)},e.prototype.setConnectionPointVoltage=function(e,t){this.getConnectionPointState(e).acVoltage=t},e.prototype.setConnectionPointCurrent=function(e,t){this.getConnectionPointState(e).acCurrent=t},e.prototype.setConnectionPointCurrentById=function(e,t){this.getConnectionPointStateById(e).acCurrent=t},e.prototype.addConnectionPointCurrent=function(e,t){var n=this.getConnectionPointState(e);n.acCurrent=n.acCurrent.add(t)},e.prototype.clearStates=function(){this._connectionPointStates.clear()},e.prototype.calculate=function(){switch(this.clearStates(),this._circuitResult.state){case"noPowerSupply":case"shortCircuit":case"toManyPowerSupplies":case"ohmMeterPowerSupplyCombination":case"internalError":break;case"lateShortCircuit":case"circuitFound":this._circuitResult.state="circuitFound",this._circuitResult.error=!1;var e=this._circuitResult.componentSequence,n=e.components;n.length>1&&n[0].getId()===n[n.length-1].getId()&&(e=new t.DeadEndComponentSequence(n.slice(0,n.length-1),this._circuitResult.componentSequence.componentConnections));var o=this.calculateTotalCurrent(e,!1),c=0;if(o.isZero()&&1===e.components.length){var i=e.components[0];if(i instanceof t.ParallelBatteries)c=i.circuitProperties.voltage;else{var a=i;c=a.getTheVoltage()}}this.calculateConnectionStates(o,this._circuitResult.componentSequence,-c);break;case"brokenCircuitFound":var r=(this.calculateTotalCurrent(this._circuitResult.componentSequence,!0),this._circuitResult.componentSequence.components[0]),u=r.getTheVoltage();this.calculateConnectionStates(t.Complex.zero,this._circuitResult.componentSequence,u);break;default:console.log("Can't calculate for state: "+this._circuitResult.state)}},e}();t.AcCircuitCalculator=o}(n=t.electricity||(t.electricity={}))}(t=e.simulations||(e.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=acCircuitCalculator.js.map
