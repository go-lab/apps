var ut;!function(t){var e;!function(e){var r;!function(e){"use strict";var r=t.commons.tsutils.IdMap,i=t.commons.tsutils.removeDuplicatesFromArray;t.simulations.electricity.circuitsimulator.factory("circuitLab",function(e){return new t.simulations.electricity.CircuitBoardModel(e,null,null)}),e.outputPrecision=4;var o=function(){function o(t,e,r){this._circuitModel=t,this._circuits=[],this._errorMessage="",this._acMode=!1,this._error=!1,this._dontSetDcVoltage=!1,this._testMode=!0,this._meters=[],this._connectionPoints=[],this._dontSetDcVoltage=e===!0,this._testMode=r===!0,this._testMode||this.circuitChanged()}return Object.defineProperty(o.prototype,"acMode",{get:function(){return this._acMode},set:function(t){this._acMode=t;var e=!1;this._circuits.forEach(function(r){r.circuitCalculator&&r.circuitCalculator.setAcMode(t)&&(e=!0)}),e&&this.circuitChanged()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"circuitModel",{get:function(){return this._circuitModel},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"connectionPoints",{get:function(){return this._connectionPoints},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"errorMessage",{get:function(){return this._errorMessage},enumerable:!0,configurable:!0}),o.prototype.setMeters=function(t){this._meters=t},o.prototype.getNrOfCircuits=function(){return this._circuits.length},o.prototype.getCircuits=function(){return this._circuits},o.prototype.countOmhMeterSources=function(){var t=0;return this._circuitModel.getComponents().forEach(function(e){e.isOmhMeterSource()&&++t}),t},o.prototype.powerChanged=function(t){if(!this._dontSetDcVoltage){var e=0;this._circuitModel.powerSource&&(e=this._circuitModel.powerSource.voltage.getValue().value),this._circuitModel.getComponents().forEach(function(t){t.isDcVoltageSource()&&t.setVoltage(e)})}t!==!0&&this.calculateCircuits()},o.prototype.circuitChanged=function(){var t=this,r=function(r){var i=e.splitBiDirectionalGraph(r.connectionPoints,r.connectionLinks,t._circuitModel.getComponents());t._circuits=[],t._errorMessage="",i.forEach(function(r){var i={bidirectionalGraph:r,graph:null,circuitResult:null};try{i.graph=new e.CreateGraph(r.connectionPoints,r.connectionLinks,r.components);var o=i.graph.circuitResult;i.circuitResult=o}catch(e){var c=e.message.indexOf(" ")>=0;if(c?t._errorMessage="internalError":t._errorMessage=e.message,i.circuitResult?(i.circuitResult.state=t._errorMessage,i.circuitResult.error=!0):i.circuitResult={state:t._errorMessage,error:!0,componentSequence:null,componentConnectionPointMap:null},c)throw e}t._circuits.push(i)}),t._error=t._errorMessage.length>0,t._circuitModel.setErrorMessage(t._errorMessage)},i=function(){t._circuits.forEach(function(r){var i=t._acMode&&0===r.circuitResult.nrOfBatteries&&!r.circuitResult.isOhmMeterCircuit;r.circuitCalculator=new e.AcCircuitCalculator(r.circuitResult,t._circuitModel.powerSource,i)})},o=new e.CreateBiDirectionalGraph(this._circuitModel.getComponents());this._connectionPoints=o.connectionPoints,r(o),this._error||(this.countOmhMeterSources()>1?(this._error=!0,this._errorMessage="toManyOhmMeterSources",this._circuitModel.setErrorMessage(this._errorMessage),this.updateMeterAndSensorStates()):(i(),this.powerChanged(!0),this.calculateCircuits()))},o.prototype.componentValueChanged=function(){var t=this._circuits.some(function(t){return t.circuitResult&&t.circuitResult.isOhmMeterCircuit}),e=this._circuits.some(function(t){return t.circuitResult&&"lateShortCircuit"===t.circuitResult.state});(!this._error||t||e)&&this.calculateCircuits()},o.prototype.sensorsChanged=function(){this.updateMeterAndSensorStates()},o.prototype.calculateCircuits=function(){var t=this,e=!1;if(this._errorMessage="",this._circuits.forEach(function(r){try{r.circuitCalculator.calculate(),r.circuitResult.isOhmMeterCircuit&&"shortCircuit"===r.circuitResult.state?e=!0:"shortCircuit"===r.circuitResult.state?(e=!0,t._errorMessage=r.circuitResult.state):r.circuitResult.error&&(t._errorMessage=r.circuitResult.state),r.circuitResult.error||e||!t.connectionPointStatesValidityCheck(r)||(t._testMode||(r.circuitResult.error=!0,r.circuitResult.state="invalidStateValues"),""===t._errorMessage&&(t._errorMessage="invalidStateValues"))}catch(o){var i=o.message.indexOf(" ")>=0;if(i?t._errorMessage="internalError":r.circuitResult.isOhmMeterCircuit&&"lateShortCircuit"===o.message||(t._errorMessage=o.message),r.circuitResult?r.circuitResult.isOhmMeterCircuit&&"lateShortCircuit"===o.message?(e=!0,r.circuitResult.state="circuitFound"):(r.circuitResult.state=t._errorMessage,r.circuitResult.error=!0):r.circuitResult={state:t._errorMessage,error:!0,componentSequence:null,componentConnectionPointMap:null},i)throw o}}),this._testMode&&"invalidStateValues"===this._errorMessage||(this._error=this._errorMessage.length>0),this._circuitModel.setErrorMessage(this._errorMessage),this.updateMeterAndSensorStates(),this._circuitModel.powerSource){var r=!1;(e||"lateShortCircuit"===this._errorMessage)&&(0!==this._circuitModel.powerSource.voltage.getValue().value?this._circuits.forEach(function(t){if(t.circuitResult){var e=t.circuitResult;"shortCircuit"!==e.state&&"lateShortCircuit"!==e.state||t.circuitResult.isOhmMeterCircuit||t.circuitResult.nrOfBatteries===t.circuitResult.nrOfPowerSupplies||(r=!0)}}):this._circuitModel.setErrorMessage("")),this._circuitModel.powerSource.setShortCircuit(r)}},o.prototype.updateMeterAndSensorStates=function(){this.updateMeterStates(),this.updateSensorStates()},o.prototype.getConnectionPointStateForComponentIds=function(t,e){return this.getConnectionPointState(this.getConnectionPointForComponentIds(t,e))},o.prototype.getConnectionPointForComponentIds=function(t,e){for(var r=0,i=this._circuits;r<i.length;r++)for(var o=i[r],c=0,n=o.bidirectionalGraph.connectionPoints;c<n.length;c++){var s=n[c];if(s.isValidForCmpIds(t,e))return s}return null},o.prototype.getConnectionPointState=function(t){var r={current:0,voltage:0,acVoltage:e.Complex.zero,acCurrent:e.Complex.zero};if(t)for(var i=0,o=this._circuits;i<o.length;i++)for(var c=o[i],n=0,s=c.bidirectionalGraph.connectionPoints;n<s.length;n++){var u=s[n];if(u.getId()===t.getId())return c.circuitCalculator?c.circuitCalculator.getConnectionPointState(t):r}return r},o.prototype.updateMeterStates=function(){this._meters.forEach(function(t){t.updateState()})},o.prototype.updateSensorStates=function(){var t=this,r=null;this._error&&(r={current:0,voltage:0,acVoltage:e.Complex.zero,acCurrent:e.Complex.zero}),this._circuitModel.getPlacedSensors().forEach(function(e){var i=null;e.isPlaced()&&(i=r?r:t.getConnectionPointStateForComponentIds(e.getPlace().cmpId1,e.getPlace().cmpId2)),e.setState(i)})},o.prototype.connectionPointStatesValidityCheck=function(o){var c=this,n=!1,s=new r,u=function(){var e=function(e,r){e instanceof t.simulations.electricity.NonComponent||(s.containsKey(e)||s.put(e,[]),s.get(e).push(r))};o.bidirectionalGraph.connectionLinkMapTyped.values().forEach(function(t){var r=t.getComponent();e(r,t.fromNode),e(r,t.toNode)}),s.keys().forEach(function(t){var e=s.get(t),r=i(e),o=r.filter(function(t){return!t.isArtificial()});s.put(t,o)})},a=function(t,e){return t.approximate(e)||t.approximate(e.rotate180())},l=function(t,r){var i=c.getConnectionPointState(r[0]),o=!1;r.forEach(function(r){var s=c.getConnectionPointState(r);i.acVoltage.approximate(s.acVoltage)||(n=!0,o||(console.log("Expected same voltage values for component "+t.getDisplayId()),o=!0),console.log("- different voltage for connectionPoint "+r.getId()+", "+("expected "+i.acVoltage.toExtendedString(e.outputPrecision)+", ")+("but is "+s.acVoltage.toExtendedString(e.outputPrecision))))})},p=function(t,r){var i=c.getConnectionPointState(r[0]),o=c.getConnectionPointState(r[1]);i.acCurrent.approximate(o.acCurrent)||(n=!0,console.log("Expected same current values for component "+t.getDisplayId()),console.log("- different current values "+i.acCurrent.toExtendedString(e.outputPrecision)+" != "+o.acCurrent.toExtendedString(e.outputPrecision)))},g=function(t,r){var i=r.map(function(t){return c.getConnectionPointState(t).acCurrent}),o=i[0].subtract(i[1]).subtract(i[2]),s=i[1].subtract(i[0]).subtract(i[2]),u=i[2].subtract(i[0]).subtract(i[1]);e.Complex.zero.approximate(o)||e.Complex.zero.approximate(s)||e.Complex.zero.approximate(u)||(n=!0,console.log("Expected summed current zero for component "+t.getDisplayId()))},h=function(t,e,r){var i=c.getConnectionPointState(e[0]),o=c.getConnectionPointState(e[1]),s=o.acVoltage.subtract(i.acVoltage);a(r,s)||(n=!0,console.log('"Expected delta voltage for component '+t.getDisplayId()),console.log("- real delta voltage "+s+", expected "+r))},d=function(t,r){var i=c.getConnectionPointState(r[0]),s=c.getConnectionPointState(r[1]),u=s.acVoltage.subtract(i.acVoltage),l=i.acCurrent.multiply(t.getImpedance(o.circuitCalculator.omega));a(l,u)||(n=!0,console.log("Expected voltage drop for component "+t.getDisplayId()+", Z="+t.getImpedance(o.circuitCalculator.omega).toExtendedString(e.outputPrecision)),console.log("- real delta voltage "+u.toExtendedString(e.outputPrecision)+", "+("expected "+l.toExtendedString(e.outputPrecision)+", I="+i.acCurrent.toExtendedString(e.outputPrecision))))};return u(),o.bidirectionalGraph.components.forEach(function(t){var r=s.get(t);t.isWire()&&!t.isSwitch()&&l(t,r),2===t.getDefinedNrOfConnections()&&p(t,r),3===t.getDefinedNrOfConnections()&&g(t,r),t.isPowerSupply()&&h(t,r,e.Complex.create(t.getTheVoltage(o.circuitCalculator.powerModel))),2!==t.getDefinedNrOfConnections()||t.isPowerSupply()||d(t,r)}),n},o}();e.CircuitSimulator=o}(r=e.electricity||(e.electricity={}))}(e=t.simulations||(t.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=circuitSimulator.js.map
