var ut;!function(t){var e;!function(e){var n;!function(e){"use strict";var n=t.commons.tsutils.IdMap,o=function(){function t(t){this._circuitResult=t,this._debug=!0,this._connectionPointStates=new n}return t.prototype.getComponentVoltage=function(t){if(t.isPowerSupply()){var e=this._circuitResult.componentConnectionPointMap.get(t.getId()),n=e.in.getDirection(t);return t.getVoltage(n)}return 0},t.prototype.calculateGraphProperties=function(t,n){var o=this,i=function(t,n){if(t instanceof e.ParallelBatteries){var i=t,r={voltage:i.batteryVoltage,resistance:0};return i.circuitProperties=r,r}if(t instanceof e.ParallelComponent){var a=t,s=0;a.parallelComponentSequences.forEach(function(t){var e=c(t,n);if(!n&&0!==e.voltage)throw new Error("powerSupplyInBranch");if(e.resistance>0)s+=1/e.resistance;else if(!n)throw new Error("lateShortCircuit")});var r={voltage:0,resistance:1/s};return a.circuitProperties=r,r}var u=t;return{voltage:o.getComponentVoltage(u),resistance:u.getResistance()}},c=function(t,e){var n=0,o=0;t.components.forEach(function(t){var c=i(t,e);n+=c.voltage,o+=c.resistance}),t.componentConnections&&t.componentConnections.forEach(function(t){t.deadEndComponentSequences&&t.deadEndComponentSequences.forEach(function(t){return c(t,!0)})});var r={voltage:n,resistance:o};return t.circuitProperties=r,r},r=c(t,n);return this._circuitResult.circuitProperties=r,r},t.prototype.calculateTotalCurrent=function(t,e){var n=Date.now(),o=this.calculateGraphProperties(t,e);this._debug&&console.log("circuitProperties: "+JSON.stringify(o));var i=0;if(!e&&0!==o.voltage)if(0===o.resistance){if(1!==t.components.length)throw new Error("lateShortCircuit");i=0}else i=o.voltage/o.resistance;var c=Date.now()-n;return this._debug&&(console.log("calculateCircuit took "+c+" ms."),console.log("total current: "+i)),i},t.prototype.calculateConnectionStates=function(t,n,o){var i=this;void 0===o&&(o=0);var c=function(t,n,o){var c=0;if(o instanceof e.ParallelBatteries){var a=o,s=t/a.parallelComponentSequences.length;a.parallelComponentSequences.forEach(function(t){r(s,n,t)}),c=n+a.batteryVoltage}else if(o instanceof e.ParallelComponent){var u=o;u.parallelComponentSequences.forEach(function(e){var o=0;0!==t&&e.circuitProperties.resistance>0&&(o=u.circuitProperties.resistance/e.circuitProperties.resistance*t),r(o,n,e)}),c=n+u.circuitProperties.voltage-u.circuitProperties.resistance*t}else if(o instanceof e.NonComponent);else{var l=o,p=i._circuitResult.componentConnectionPointMap.get(l);c=n-t*l.getResistance()+i.getComponentVoltage(l),i.setConnectionPointState(p.in,n,t),i.setConnectionPointState(p.out,c,t)}return c},r=function(t,e,n){var o=e,i=n.components,a=n.componentConnections;return i.forEach(function(e,n){var i=o;if(o=c(t,i,e),a&&n<a.length){var s=a[n];s.deadEndComponentSequences.forEach(function(t){return r(0,o,t)})}}),o},a=function(t){if(t.currentRecipeForConnectionPoints.length>0){var e=0;t.incomingConnectionPoints.length>0?e=i.getConnectionPointState(t.incomingConnectionPoints[0]).voltage:t.outgoingConnectionPoints.length>0&&(e=i.getConnectionPointState(t.outgoingConnectionPoints[0]).voltage),t.currentRecipeForConnectionPoints.forEach(function(t){i.setConnectionPointStateById(t.connectionPointId,e,t.currentRecipe.getCurrent(i._connectionPointStates))})}t.deadEndComponentSequences.forEach(function(t){return s(t)})},s=function(t){t.componentConnections&&t.componentConnections.forEach(function(t){a(t)}),t.components.forEach(function(t){if(t instanceof e.ParallelComponent){var n=t;n.parallelComponentSequences.forEach(function(t){s(t)})}})};r(t,o,n),s(n)},t.prototype.getConnectionPointStateById=function(t){return this._connectionPointStates.containsKey(t)||this._connectionPointStates.put(t,{voltage:0,current:0}),this._connectionPointStates.get(t)},t.prototype.getConnectionPointState=function(t){return this.getConnectionPointStateById(t.getId())},t.prototype.setConnectionPointStateById=function(t,e,n){var o=this.getConnectionPointStateById(t);o.voltage=e,o.current=n},t.prototype.setConnectionPointState=function(t,e,n){this.setConnectionPointStateById(t.getId(),e,n)},t.prototype.setConnectionPointVoltage=function(t,e){this.getConnectionPointState(t).voltage=e},t.prototype.setConnectionPointCurrent=function(t,e){this.getConnectionPointState(t).current=e},t.prototype.setConnectionPointCurrentById=function(t,e){this.getConnectionPointStateById(t).current=e},t.prototype.addConnectionPointCurrent=function(t,e){var n=this.getConnectionPointState(t);n.current+=e},t.prototype.clearStates=function(){this._connectionPointStates.clear()},t.prototype.calculate=function(){switch(this.clearStates(),this._circuitResult.state){case"noPowerSupply":case"shortCircuit":case"lateShortCircuit":case"toManyPowerSupplies":case"ohmMeterPowerSupplyCombination":case"internalError":break;case"circuitFound":var t=this._circuitResult.componentSequence,n=t.components;n.length>1&&n[0].getId()===n[n.length-1].getId()&&(t=new e.DeadEndComponentSequence(n.slice(0,n.length-1),this._circuitResult.componentSequence.componentConnections));var o=this.calculateTotalCurrent(t,!1),i=0;if(0===o&&1===t.components.length){var c=t.components[0];if(c instanceof e.ParallelBatteries)i=c.circuitProperties.voltage;else{var r=c;i=r.getTheVoltage()}}this.calculateConnectionStates(o,this._circuitResult.componentSequence,-i);break;case"brokenCircuitFound":var a=(this.calculateTotalCurrent(this._circuitResult.componentSequence,!0),this._circuitResult.componentSequence.components[0]),s=a.getTheVoltage();this.calculateConnectionStates(0,this._circuitResult.componentSequence,s);break;default:console.log("Can't calculate for state: "+this._circuitResult.state)}},t}();e.CircuitCalculator=o}(n=e.electricity||(e.electricity={}))}(e=t.simulations||(t.simulations={}))}(ut||(ut={}));
//# sourceMappingURL=circuitCalculator.js.map
