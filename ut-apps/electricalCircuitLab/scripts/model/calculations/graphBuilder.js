(function(){"use strict";var e,t=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1};window.ut=window.ut||{},ut.simulations=ut.simulations||{},ut.simulations.electricity=ut.simulations.electricity||{},e={graphNodes:null,baseGraphNodes:null,graphNodesStack:[],wiredGraphs:[],otherGraphBuilder:null,progress:!1,foundGraphs:[],foundSplits:[],connectionLink:null,myName:""},ut.simulations.electricity.GraphBuilder=function(){function e(e,t,r,n,i){this.connectionLinks=e,this.myName=null!=i?i:"graphBuilder",this.debug=ut.simulations.electricity.debugModelCalculations,this.graphNodes=new ut.simulations.electricity.NodeTracker,this.baseGraphNodes=this.graphNodes,this.graphNodesStack=[],this.init(),this.graphNodes.nodeVisited(t),this.graphNodes.nodeVisited(r),this.wiredGraphs=this.findWiredGraphs(r,r,n),this.wiredGraphs=this.applyGraphCreateGraphResults(this.wiredGraphs),this.debug&&this.printGraphResults("'"+this.myName+"': initial graph results",this.wiredGraphs),this.foundGraphs=[],this.progress=!1,this.foundSplits=[]}return e.prototype.setOtherGraphBuilder=function(e){return this.otherGraphBuilder=e},e.prototype.init=function(){return this.graphNodes=new ut.simulations.electricity.NodeTracker,this.graphNodesStack=[],this.baseGraphNodes=this.graphNodes},e.prototype.pushTryMode=function(){return this.graphNodesStack.push(this.graphNodes),this.graphNodes=new ut.simulations.electricity.NodeTracker(this.graphNodes)},e.prototype.popTryMode=function(){return this.graphNodes=this.graphNodesStack.pop()},e.prototype.getGraphNode=function(e){var t;if(!(e instanceof ut.simulations.electricity.ConnectionPoint))throw new Error("connectionPoint is of the wrong class");return t=this.graphNodes.getVisitedNode(e.getId()),null==t&&(t=new ut.simulations.electricity.GraphNode(e),this.graphNodes.nodeVisited(t)),t},e.prototype.applyGraphCreateGraphResult=function(e){var t,r,n,i,s,o,a;return a=this,t=!1,o=function(e){var r;return r=a.graphNodes.getVisitedNode(e.getId()),r!==e&&(t=!0,r=a.getGraphNode(e.getConnectionPoint())),r},s=function(e){var t;return t=[],e.forEach(function(e){var r,n,i,s;return n=e,i=o(e.fromNode),s=o(e.toNode),n instanceof ut.simulations.electricity.BranchedGraphLink?(r=a.applyGraphCreateGraphResults(n.branchGraphs),n=new ut.simulations.electricity.BranchedGraphLink(i,s,r)):i===e.fromNode&&s===e.toNode||(n=new ut.simulations.electricity.GraphLink(i,s,e.getConnectionLink())),n.fromNode!==e.fromNode&&n.fromNode.copyDeadEnds(e.fromNode),n.toNode!==e.toNode&&n.toNode.copyDeadEnds(e.toNode),t.push(n)}),t},n=o(e.endNode),i=s(e.graphLinks),r=e,t&&(r=new ut.simulations.electricity.CreateGraphResult(e.resultType,e.beginNode,n,i,e.nextGraphLinks)),r},e.prototype.applyGraphCreateGraphResults=function(e){var t,r,n,i;for(i=[],r=0,n=e.length;r<n;r++)t=e[r],i.push(this.applyGraphCreateGraphResult(t));return i},e.prototype.findWiredGraphs=function(e,t,r){var n,i,s;return n=this,i=function(e,t,r){var s,o,a,h;switch(a=function(s){var o,a,h;return o=n.getGraphNode(s.toNode),a=new ut.simulations.electricity.GraphLink(t,o,s),h=r.slice(),h.push(a),i(e,o,h)},n.pushTryMode(),o=n.connectionLinks.getFromLinks(t.getConnectionPoint()),o=function(){var e,t,r;for(r=[],e=0,t=o.length;e<t;e++)s=o[e],n.graphNodes.isNodeVisited(s.toNode)||r.push(s);return r}(),h=[],o.length){case 0:h=[new ut.simulations.electricity.CreateGraphResult("deadEnd",e,t,r,[])];break;case 1:h=o[0].component.isWire()?a(o[0]):[new ut.simulations.electricity.CreateGraphResult("nonWire",e,t,r,[o[0]])];break;default:o.forEach(function(e){return h=h.concat(a(e))})}return n.popTryMode(),n.applyGraphCreateGraphResults(h)},this.pushTryMode(),s=i(e,t,r),this.popTryMode(),s},e.prototype.findConnectingGraph=function(e,t){var r,n,i,s,o,a,h,u;return i=this,r=e.beginNode,u=new ut.simulations.electricity.NodeTracker,h=function(e,n){var s,o,a,p,d;if(p=function(t){var r,s,o;return r=i.getGraphNode(t.toNode),s=new ut.simulations.electricity.GraphLink(e,r,t),o=n.slice(),o.push(s),h(r,o)},a=[],d=t.some(function(t){return t.equals(e)}))a=[new ut.simulations.electricity.CreateGraphResult("endNode",r,e,n,[])];else{if(i.pushTryMode(),o=i.connectionLinks.getFromLinks(e.getConnectionPoint()),o=function(){var e,t,r;for(r=[],e=0,t=o.length;e<t;e++)s=o[e],u.isNodeVisited(s.toNode)||r.push(s);return r}(),0===o.length)a=[new ut.simulations.electricity.CreateGraphResult("deadEnd",r,e,n,[])];else switch(o=function(){var e,t,r;for(r=[],e=0,t=o.length;e<t;e++)s=o[e],i.graphNodes.isNodeVisited(s.toNode)||r.push(s);return r}(),o.length){case 0:a=[new ut.simulations.electricity.CreateGraphResult("deadEnd",r,e,n,[])];break;case 1:u.nodeVisited(o[0].fromNode),a=p(o[0]);break;default:a=[new ut.simulations.electricity.CreateGraphResult("split",r,e,n,o)]}i.popTryMode()}return a},u.nodeVisited(e.beginNode),s=e.nextGraphLinks[0],a=this.getGraphNode(s.toNode),o=new ut.simulations.electricity.GraphLink(e.endNode,a,s),n=e.graphLinks.slice(),n.push(o),u.nodeVisited(o.fromNode),h(a,n)},e.prototype.mergeParallelGraphResults=function(e){var t,r,n,i,s,o,a,h;if(a=function(e){var t,r,n,i;for(i=function(t){var r,n;for(n in e){if(r=e[n],t>=r.length)return!1;if(!r[t].equals(e[0][t]))return!1}return!0},t=0,n=[];i(t);)n.push(e[0][t]),t++;return r=null,n.length>0&&(r=n[n.length-1]),{mergedGraphLinks:n,leftOverGraphLinksArray:e.map(function(e){return e.slice(n.length)}),lastSameLink:r}},o=function(){var t,r,n,i,s,o,h,u,p;return h=e.map(function(e){return e.graphLinks}),o=a(h),h=o.leftOverGraphLinksArray.map(function(e){return e.reverse()}),t=a(h),u=o.mergedGraphLinks,s=t.leftOverGraphLinksArray.map(function(t){var r;return r=t.reverse(),new ut.simulations.electricity.CreateGraphResult(e[0].resultType,r[0].fromNode,t[0].fromNode,r,[])}),r=e[0].beginNode,o.lastSameLink&&(r=o.lastSameLink.toNode),n=e[0].endNode,t.lastSameLink&&(n=t.lastSameLink.fromNode),i=new ut.simulations.electricity.BranchedGraphLink(r,n,s),u.push(i),p=u.concat(t.mergedGraphLinks.reverse()),[new ut.simulations.electricity.CreateGraphResult(e[0].resultType,e[0].beginNode,e[0].endNode,p,[])]},e.length<=1)return e;if(h=e[0].resultType,t=e[0].beginNode,s=e[0].endNode,i=e.some(function(e){return e.resultType===!h}),r=e.some(function(e){return e.beginNode===!t}),n=e.some(function(e){return e.endNode===!s}),i||r||n)throw new Error("not yet implemented, differentResultTypes="+i+", differentBeginNodes="+r+", differentEndNodes="+n);return o()},e.prototype.getEndNodes=function(){var e,t,r,n,i;for(r=this.wiredGraphs,n=[],e=0,t=r.length;e<t;e++)i=r[e],n.push(i.endNode);return n},e.prototype.findGraphResultForEndNode=function(e){var t,r,n,i;for(n=this.wiredGraphs,t=0,r=n.length;t<r;t++)if(i=n[t],i.endNode.equals(e))return i;return null},e.prototype.handledGraphResult=function(e){var t;return t=this.wiredGraphs.indexOf(e),this.wiredGraphs.splice(t,1),this.progress=!0},e.prototype.addGraphResults=function(e){var t,r,n,i;for(i=[],r=0,n=e.length;r<n;r++)t=e[r],i.push(this.addGraphResult(t));return i},e.prototype.addGraphResult=function(e){return this.wiredGraphs.push(this.applyGraphCreateGraphResult(e)),this.progress=!0},e.prototype.handledFoundSplit=function(e){var t;return t=this.foundSplits.indexOf(e),this.foundSplits.splice(t,1)},e.prototype.rollUpDeadEnds=function(){var e,r,n,i,s,o,a,h,u,p;if(s=this,e=this.foundGraphs.concat(this.otherGraphBuilder.foundGraphs),o=function(e,t){var r,n,i,s;if(t.graphLinks[0].fromNode.equals(e))return!0;for(s=t.graphLinks,n=0,i=s.length;n<i;n++)if(r=s[n],r.toNode.equals(e))return!0;return!1},a=function(t){var r,n,i;for(n=0,i=e.length;n<i;n++)if(r=e[n],"deadEnd"!==e&&o(t,r))return!0;return!1},p=function(e){var t,r,n,i;for(t=e.graphLinks.length-1,r=null;t>=0&&null===r;)a(e.graphLinks[t].fromNode)?r=e.graphLinks[t].fromNode:--t;if(r)n=e.graphLinks.slice(t+0),i=new ut.simulations.electricity.CreateGraphResult(e.resultType,n[0].fromNode,e.endNode,n,e.nextGraphLinks);else{for(t=e.graphLinks.length-1;t>=0&&e.graphLinks[t].connectionLink.component.isWire();)--t;t<=0?i=e:(n=e.graphLinks.slice(t+1),i=new ut.simulations.electricity.CreateGraphResult(e.resultType,n[0].fromNode,e.endNode,n,e.nextGraphLinks)),r=s.getGraphNode(e.beginNode.getConnectionPoint())}return r.addDeadGraphResult(i),s.handledGraphResult(e)},e.length>0){for(h=this.wiredGraphs.slice(0),u=[],n=0,i=h.length;n<i;n++)r=h[n],t.call(this.wiredGraphs,r)>=0&&"deadEnd"===r.resultType&&u.push(p(r));return u}},e.prototype.tryFindConnection=function(e){var t,r,n;switch(t=function(e,t){var r;return r=e.graphLinks.slice(),t.graphLinks.reverse().forEach(function(e){var t;return t=new ut.simulations.electricity.GraphLink(e.toNode,e.fromNode,e.getConnectionLink()),r.push(t)}),new ut.simulations.electricity.CreateGraphResult(e.resultType,e.beginNode,t.beginNode,r,[])},r=this.findConnectingGraph(e,this.otherGraphBuilder.getEndNodes()),this.debug&&this.printGraphResults("connectingGraphResults",r),r.length){case 0:return null;case 1:switch(r[0].resultType){case"endNode":if(n=this.otherGraphBuilder.findGraphResultForEndNode(r[0].endNode))return this.foundGraphs.push(t(r[0],n)),this.handledGraphResult(e),this.otherGraphBuilder.handledGraphResult(n);throw new Error("internal error, failed to find found endPoint: "+r[0].endNode);case"split":return this.foundSplits.push({graphResult:e,splitResult:r[0]});case"deadEnd":return this.handledGraphResult(e),this.addGraphResult(r[0]);default:throw console.log("not yet implemented, for result type: "+r[0].resultType),new Error("unknownResultType")}break;default:throw new Error("internal error, to many found component graphs: "+r.length)}},e.prototype.tryFindWiredGraphs=function(e){var t;return t=this.findWiredGraphs(e.beginNode,e.endNode,e.graphLinks),this.handledGraphResult(e),this.addGraphResults(t)},e.prototype.applySplit=function(e){return this.handledGraphResult(e.graphResult),this.addGraphResult(e.splitResult),this.handledFoundSplit(e)},e.prototype.tryCombineSplits=function(){var e,t,r,n,i,s,o,a,h;if(t=this.foundSplits[0].splitResult.endNode,n=function(){var e,r,n,s;for(n=this.foundSplits,s=[],e=0,r=n.length;e<r;e++)i=n[e],t.equals(i.splitResult.endNode)&&s.push(i);return s}.call(this),n.length>1){for(h=n.map(function(e){return e.splitResult}),e=this.mergeParallelGraphResults(h),a=n.slice(0),s=0,o=a.length;s<o;s++)r=a[s],this.handledGraphResult(r.graphResult),this.handledFoundSplit(r);return this.addGraphResults(e)}},e.prototype.moveFoundSplitsToGraphResults=function(){var e,t,r,n,i;for(n=this.foundSplits.slice(0),i=[],t=0,r=n.length;t<r;t++)e=n[t],this.handledGraphResult(e.graphResult),this.addGraphResult(e.splitResult),i.push(this.handledFoundSplit(e));return i},e.prototype.doBuildStep=function(){var e,t,r,n;for(this.debug&&this.printGraphResults("'"+this.myName+"': begin doBuildStep",this.wiredGraphs),this.progress=!1,this.foundSplits=[],r=this.wiredGraphs.slice(0),e=0,t=r.length;e<t;e++)switch(n=r[e],n.resultType){case"nonWire":this.tryFindConnection(n);break;case"split":this.tryFindWiredGraphs(n);break;default:console.warn("unexpected wiredGraph.resultType: "+n.resultType)}switch(this.debug&&this.foundSplits.length>0&&console.log("nr of found splits: "+this.foundSplits.length),this.foundSplits.length){case 0:break;case 1:this.applySplit(this.foundSplits[0]);break;default:this.tryCombineSplits()}return this.foundSplits.length>0&&(this.moveFoundSplitsToGraphResults(),this.debug&&console.log("nr of found splits left: "+this.foundSplits.length)),this.progress||this.rollUpDeadEnds(),this.debug&&(this.printGraphResults("'"+this.myName+"': end doBuildStep: wiredGraphs",this.wiredGraphs),this.printGraphResults("'"+this.myName+"': end doBuildStep: foundGraphs",this.foundGraphs)),this.progress},e.prototype.getMergedGraph=function(){return this.mergeParallelGraphResults(this.foundGraphs)},e.prototype.printGraphResults=function(e,t){var r,n;return n=this,r=function(e){return n.graphNodesStack.length+","+n.graphNodes.isNodeTracked(e)+","+n.baseGraphNodes.isNodeTracked(e)},ut.simulations.electricity.printGraphResults(e,t,r)},e}()}).call(this);
//# sourceMappingURL=graphBuilder.js.map
