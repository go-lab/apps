(function(){"use strict";window.ut=window.ut||{},ut.simulations=ut.simulations||{},ut.simulations.electricity=ut.simulations.electricity||{},ut.simulations.electricity.circuitsimulator.factory("circuitLab",function(t){return new ut.simulations.electricity.CircuitBoardModel(t)}),ut.simulations.electricity.CircuitSimulator=function(){function t(t,e,i){this.circuitModel=t,this.jsonCircuit=null,this.circuits=[],this.errorMessage="",this.error=!1,this.dontSetDcVoltage=e===!0,this.testMode=i===!0,this.meters=[],this.circuitChanged()}return t.prototype.setMeters=function(t){return this.meters=t},t.prototype.getNrOfCircuits=function(){return this.circuits.length},t.prototype.getCircuits=function(){return this.circuits},t.prototype.countOmhMeterSources=function(){var t,e,i,r,o;for(r=0,o=this.circuitModel.getComponents(),e=0,i=o.length;e<i;e++)t=o[e],t.isOmhMeterSource()&&++r;return r},t.prototype.powerChanged=function(t){var e,i,r,o;if(!this.dontSetDcVoltage){i=0,this.circuitModel.dcVoltageSource&&(i=this.circuitModel.dcVoltageSource.getValue()),o=this.circuitModel.components;for(r in o)e=o[r],e.isDcVoltageSource()&&e.setVoltage(i)}if(t!==!0)return this.calculateCircuits()},t.prototype.circuitChanged=function(){var t,e;if(e=function(t){return function(e){var i,r,o,n,s,c,u,a;for(r=ut.simulations.electricity.splitBiDirectionalGraph(e.connectionPoints,e.connectionLinks,t.circuitModel.components),t.circuits=[],t.errorMessage="",c=0,u=r.length;c<u;c++){i=r[c],o={bidirectionalGraph:i},n={};try{o.graph=new ut.simulations.electricity.CreateGraph(i.connectionPoints,i.connectionLinks,i.components),n=o.graph.circuitResult,o.circuitResult=n}catch(e){if(s=e,a=s.message.indexOf(" ")>=0,t.errorMessage=a?"internalError":s.message,n.state=t.errorMessage,n.error=!0,a)throw s}t.circuits.push(o)}return t.error=t.errorMessage.length>0,t.circuitModel.setErrorMessage(t.errorMessage)}}(this),t=function(t){return function(){var e,i,r,o,n;for(o=t.circuits,n=[],i=0,r=o.length;i<r;i++)e=o[i],n.push(e.circuitCalculator=new ut.simulations.electricity.CircuitCalculator(e.circuitResult));return n}}(this),this.biDirectionalGraph=new ut.simulations.electricity.CreateBiDirectionalGraph(this.circuitModel.components),this.connectionPoints=this.biDirectionalGraph.connectionPoints,e(this.biDirectionalGraph),!this.error)return this.countOmhMeterSources()>1?(this.error=!0,this.errorMessage="toManyOhmMeterSources",this.circuitModel.setErrorMessage(this.errorMessage),this.updateMeterAndSensorStates()):(t(),this.powerChanged(!0),this.calculateCircuits())},t.prototype.componentValueChanged=function(){if(!this.error)return this.calculateCircuits()},t.prototype.sensorsChanged=function(){return this.updateMeterAndSensorStates()},t.prototype.calculateCircuits=function(){var t,e,i,r,o,n,s,c;for(s=!1,o=this.circuits,i=0,r=o.length;i<r;i++){t=o[i];try{t.circuitCalculator.calculate(),t.circuitResult.error?this.errorMessage=t.circuitResult.state:"shortCircuit"===t.circuitResult.state&&(s=!0,t.circuitResult.graph.isOhmMeterCircuit()||(this.errorMessage=t.circuitResult.state)),t.circuitResult.error||s||!this.connectionPointStatesValidityCheck(t)||(this.testMode||(t.circuitResult.error=!0,t.circuitResult.state="invalidStateValues"),""===this.errorMessage&&(this.errorMessage="invalidStateValues"))}catch(i){if(e=i,c=e.message.indexOf(" ")>=0,this.errorMessage=c?"internalError":e.message,t.circuitResult.state=this.errorMessage,t.circuitResult.error=!0,c)throw e}}return this.testMode&&"invalidStateValues"===this.errorMessage||(this.error=this.errorMessage.length>0),this.circuitModel.setErrorMessage(this.errorMessage),this.updateMeterAndSensorStates(),null!=(n=this.circuitModel.dcVoltageSource)?n.setShortCircuit(s):void 0},t.prototype.updateMeterAndSensorStates=function(){return this.updateMeterStates(),this.updateSensorStates()},t.prototype.getConnectionPointStateForComponentIds=function(t,e){return this.getConnectionPointState(this.getConnectionPointForComponentIds(t,e))},t.prototype.getConnectionPointForComponentIds=function(t,e){var i,r,o,n,s,c,u;for(c=this.circuits,o=0,s=c.length;o<s;o++){i=c[o],u=i.bidirectionalGraph.connectionPoints;for(n in u)if(r=u[n],r.isValidForCmpIds(t,e))return r}return null},t.prototype.getConnectionPointState=function(t){var e,i,r,o,n,s,c,u;for(u={current:0,voltage:0},s=this.circuits,r=0,n=s.length;r<n;r++){i=s[r],c=i.bidirectionalGraph.connectionPoints;for(o in c)if(e=c[o],e===t)return i.circuitCalculator?i.circuitCalculator.getConnectionPointState(t):u}return u},t.prototype.updateMeterStates=function(){var t,e,i,r,o;for(r=this.meters,o=[],t=0,e=r.length;t<e;t++)i=r[t],o.push(i.updateState());return o},t.prototype.updateSensorStates=function(){var t,e,i,r,o,n;t=null,this.error&&(t={current:0,voltage:0}),i=this.circuitModel.getPlacedSensors(),r=[];for(e in i)o=i[e],n=null,o.isPlaced()&&(n=t?t:this.getConnectionPointStateForComponentIds(o.cmpId1,o.cmpId2)),r.push(o.setState(n));return r},t.prototype.connectionPointStatesValidityCheck=function(t){var e,i,r,o,n,s,c,u,a,l,h,g;g=!1,c={},n=function(){var e,i,r,o,n,s;e=function(t,e){if(!(t instanceof ut.simulations.electricity.NonComponent))return"undefined"==typeof c[t.getId()]&&(c[t.getId()]=[]),c[t.getId()].push(e)},n=t.bidirectionalGraph.connectionLinkMap,s=[];for(o in n)r=n[o],i=r.getComponent(),e(i,r.fromNode),s.push(e(i,r.toNode));return s},a=function(t,e){var i;return i=Math.abs(t-e),i>1e-9},r=function(t){return function(e,i){var r,o,n,s,c,u,l;for(c=t.getConnectionPointState(i[0]),r=!1,u=[],n=0,s=i.length;n<s;n++)o=i[n],l=t.getConnectionPointState(o),a(l.voltage,c.voltage)?(g=!0,r||(console.log("Expected same voltage values for component "+e.getDisplayId()),r=!0),u.push(console.log("- different voltage for connectionPoint "+o.getId()+", expected "+c.voltage+", but is "+l.voltage))):u.push(void 0);return u}}(this),i=function(t){return function(e,i){var r,o;if(o=t.getConnectionPointState(i[0]),r=t.getConnectionPointState(i[1]),a(r.current,o.current))return g=!0,console.log("Expected same current values for component "+e.getDisplayId()),console.log("- different current values "+o.current+" != "+r.current)}}(this),e=function(t){return function(e,i,r){var o,n,s;if(n=t.getConnectionPointState(i[0]),s=t.getConnectionPointState(i[1]),o=s.voltage-n.voltage,a(Math.abs(r),Math.abs(o)))return g=!0,console.log("Expected delta voltage for component "+e.getDisplayId()),console.log("- real delta voltage "+o+", expected "+r)}}(this),o=function(t){return function(e,i){var r,o,n,s;if(n=t.getConnectionPointState(i[0]),s=t.getConnectionPointState(i[1]),o=s.voltage-n.voltage,r=n.current*e.getResistance(),a(Math.abs(r),Math.abs(o)))return g=!0,console.log("Expected voltage drop for component "+e.getDisplayId()+", R="+e.getResistance()),console.log("- real delta voltage "+o+", expected "+r+", I="+n.current)}}(this),n(),h=t.bidirectionalGraph.components;for(l in h)s=h[l],u=c[s.getId()],s.isWire()&&!s.isSwitch()&&r(s,u),2===s.getDefinedNrOfConnections()&&i(s,u),s.isPowerSupply()&&e(s,u,s.getTheVoltage()),2!==s.getDefinedNrOfConnections()||s.isPowerSupply()||o(s,u);return g},t}()}).call(this);
//# sourceMappingURL=circuitSimulator.js.map
