(function(){var e,r="graasp",t="preview",o="standalone_ils",a="standalone_html",n="unknown",c="graasp_student",d="graasp_viewer",s="graasp_editor",u={actor:{objectType:"person",id:null,displayName:null},generator:{objectType:"application",url:"undefined"!=typeof gadgets?gadgets.util.getUrlParameters().url:window.location.href,id:null,displayName:null},provider:{objectType:t,url:window.location.href,id:null,displayName:null,inquiryPhaseId:"undefined",inquiryPhaseName:"undefined",inquiryPhase:"undefined"},target:{},hasAngeLA:null,hasAngeLO:null,storageId:null,storageType:null},l=!1,p=0,g=0,f=0,y=0,m=0,v=0,h=0,b=0,T=0,I=0,x=0,N=0,S=0,A=0,w=0,j=0,C=0,P=0,V=0,O=0,q=0,U=0,B=0,R=0,F=0,M=0,J=0,L=0,D=0,z=0,E=0,k=0,G=0,H=0,K=0,Q=0,W=0;e={getCurrentUser:function(t){function a(e){var r;osapi.people.get({userId:"@viewer"}).execute(function(t){return t.id&&t.displayName?(r={id:t.id,displayName:t.displayName},e(r)):(i={error:"The username couldn't be obtained.",log:t.error},e(i))})}function n(e){var r;if(gadgets.util.getUrlParameters()["view-params"]&&JSON.parse(gadgets.util.getUrlParameters()["view-params"])){var t=JSON.parse(gadgets.util.getUrlParameters()["view-params"]);return r=t?t.reviewer:null,e(r)}}l&&(p++,console.log("counter_getCurrentUser "+p));var i={error:"The username couldn't be obtained."},d=e.identifyContext();a(function(e){return e.error?t(i):void n(function(a){return a&&a.id&&a.username?(u.actor.id=a.id,u.actor.displayName=a.username,u.actor.objectType=s,u.contextualActor={id:e.id,displayName:e.displayName,objectType:c},t(u.actor.displayName.toLowerCase())):d==r||d==o?(u.actor.id=e.id,u.actor.displayName=e.displayName,u.actor.objectType=d==o?c:"person",t(u.actor.displayName.toLowerCase())):t(i)})})},identifyContext:function(){return l&&(g++,console.log("counter_identifyContext "+g)),"undefined"==typeof osapi||null===osapi?a:document.referrer.indexOf("golabz.eu")>-1||""==document.referrer?t:document.referrer.indexOf("ils")>-1?o:document.referrer.indexOf("graasp.eu")>-1||document.referrer.indexOf("localhost")>-1?r:n},getParent:function(e){l&&(f++,console.log("counter_getParent "+f));var r={error:"The parent space couldn't be obtained."};osapi.context.get().execute(function(t){return t&&void 0!=t?t.error?(r={error:"The parent space couldn't be obtained.",log:t.error},e(r)):void osapi.spaces.get({contextId:t.contextId}).execute(function(o){return o.error?(r={error:"The parent space couldn't be obtained.",log:t.error},e(r)):e(o)}):e(r)})},getParentInquiryPhase:function(e){l&&(y++,console.log("counter_getParentInquiryPhase "+y));var r;this.getParent(function(t){return t.error?(r={error:"The parent inquiry phase couldn't be obtained.",log:t.error},e(r)):t.hasOwnProperty("metadata")&&t.metadata.hasOwnProperty("type")?e(t.metadata.type):(r={error:"The parent inquiry phase couldn't be obtained."},e(r))})},getIls:function(e){l&&(m++,console.log("counter_getIls "+m));var r;osapi.context.get().execute(function(t){return t.error?(r={error:"The id of the space where the app is located is not available.",log:t.error},e(r)):void osapi.spaces.get({contextId:t.contextId}).execute(function(t){return t.error||!t.id?(r={error:"The space where the app is located is not available.",log:t.error},e(r)):"ils"===t.spaceType?(u.provider.objectType=t.spaceType,u.provider.url=t.profileUrl,u.provider.id=t.id,u.provider.displayName=t.displayName,t.metadata&&t.metadata.ilsRef&&(u.provider.ilsRef=t.metadata.ilsRef),e(t,t)):void osapi.spaces.get({contextId:t.parentId}).execute(function(o){return o.error?(r={error:"The ils where the app is located is not available.",log:o.error},e(r)):"ils"===o.spaceType?(u.provider.objectType=o.spaceType,u.provider.url=o.profileUrl,u.provider.id=o.id,u.provider.displayName=o.displayName,u.provider.inquiryPhaseId=t.id,u.provider.inquiryPhaseName=t.displayName,t.metadata&&t.metadata.type&&(u.provider.inquiryPhase=t.metadata.type),o.metadata&&o.metadata.ilsRef&&(u.provider.ilsRef=o.metadata.ilsRef),e(o,t)):(r={error:"The app is not located in an ILS or in one of its phases."},e(r))})})})},getIlsId:function(r){l&&(v++,console.log("counter_getIlsId "+v));var t=u.provider.id;return t?r(t):void e.getIls(function(e){return r(e.id)})},getSpaceBySpaceId:function(e,r){l&&(h++,console.log("counter_getSpaceBySpaceId "+h)),osapi.spaces.get({contextId:e}).execute(function(e){return!e.error&&e.id?r(e):(error={error:"The space is not available.",log:e.error},r(error))})},getItemsBySpaceId:function(e,r){l&&(b++,console.log("counter_getItemsBySpaceId "+b));var t;osapi.spaces.get({contextId:e,contextType:"@space"}).execute(function(e){return!e.error&&e.list?r(e.list):(t={error:"The list of items could not be obtained.",log:e.error},r(t))})},getSubspacesBySpaceId:function(e,r){l&&(T++,console.log("counter_getSubspacesBySpaceId "+T));var t,o={};o._type="Space",osapi.spaces.get({contextId:e,contextType:"@space",filters:o}).execute(function(e){return!e.error&&e.list?r(e.list):(t={error:"The list of spaces could not be obtained.",log:e.error},r(t))})},getAppsBySpaceId:function(e,r){l&&(I++,console.log("counter_getAppsBySpaceId "+I));var t,o={};o._type="Application",osapi.spaces.get({contextId:e,contextType:"@space",filters:o}).execute(function(e){return!e.error&&e.list?r(e.list):(t={error:"The list of apps could not be obtained.",log:e.error},r(t))})},getVault:function(r){l&&(x++,console.log("counter_getVault "+x));var t={};e.getIls(function(o){return o.error?(t={error:"The space is not available.",log:o.error},r(t)):void e.getVaultByIlsId(o.id,function(e){return e&&e.id?r(e):(t={error:"There is no Vault available."},r(t))})})},getVaultByIlsId:function(e,r){l&&(N++,console.log("counter_getVaultByIlsId "+N));var t;if(!e||""==e)return t={error:"There ILS identifier cannot be empty. The Vault space could not be obtained"},r(t);var o={};o._type="Space",o["metadata.type"]="Vault",osapi.spaces.get({contextId:e,contextType:"@space",filters:o}).execute(function(e){if(!e.error&&e.list){if(1==e.list.length){var o=e.list[0];return u.storageId=o.id,u.storageType=o.spaceType,r(o)}return 0==e.list.length?(t={error:"There is no Vault available."},r(t)):(t={error:"There is more that one Vault available."},r(t))}return t={error:"The list of spaces could not be obtained.",log:e.error},r(t)})},getApp:function(r){l&&(S++,console.log("counter_getApp "+S));var t={initialize:!0};osapi.apps.get({contextId:"@self",params:t}).execute(function(t){if(!t.error&&t.id)return u.generator.url=t.appUrl,u.generator.id=t.id,u.generator.displayName=t.displayName,u.hasAngeLA=!!t.hasAngeLA&&t.hasAngeLA,u.hasAngeLO=!!t.hasAngeLO&&t.hasAngeLO,e.identifyContext()!=o&&("owner"===t.userMemberType||"contributor"===t.userMemberType?u.actor.objectType=s:u.actor.objectType=d),r(t);var a={error:"The app couldn't be obtained.",log:t.error};return r(a)})},getAppId:function(r){l&&(A++,console.log("counter_getAppId "+A)),e.getApp(function(t){return t.id?r(t.id):void e.getIls(function(e){if(e.id)return r(e.id);var t={error:"The appId couldn't be obtained. No Open Social App or metawidget was found."};return r(t)})})},getContextFromMetadata:function(r,t){return l&&(w++,console.log("counter_getContextFromMetadata "+w)),r.actor&&r.actor.objectType&&r.actor.id&&r.actor.displayName&&r.actor.id?u.actor=r.actor:e.getCurrentUser(function(e){}),r.generator&&r.generator.objectType&&r.generator.url&&r.generator.id&&r.generator.displayName?u.generator=r.generator:e.getApp(function(e){e&&e.id&&(u.generator.url=e.appUrl,u.generator.id=e.id,u.generator.displayName=e.displayName)}),r.provider&&r.provider.objectType&&r.provider.url&&r.provider.id&&r.provider.displayName&&r.provider.inquiryPhaseId&&r.provider.inquiryPhaseName&&r.provider.inquiryPhase?u.provider=r.provider:e.getIls(function(e,r){e&&e.id&&(u.provider.objectType=e.spaceType,u.provider.url=e.profileUrl,u.provider.id=e.id,u.provider.displayName=e.displayName,r&&r.id&&e.id!=r.id&&(u.provider.inquiryPhaseId=r.id,u.provider.inquiryPhaseName=r.displayName,r.metadata&&r.metadata.type&&(u.provider.inquiryPhase=r.metadata.type)))}),r.storageId&&r.storageType?(u.storageId=r.storageId,u.storageType=r.storageType):e.getVault(function(e){e&&e.id&&(u.storageId=e.id,u.storageType=e.spaceType)}),t()},getAppContextParameters:function(r){return l&&(j++,console.log("counter_getAppContextParameters "+j)),u.actor.id&&u.generator.id&&u.provider.id&&u.storageId?r(u):void e.getCurrentUser(function(t){e.getApp(function(t){e.getIls(function(t,o){e.getVaultByIlsId(t.id,function(e){return r(u)})})})})},deleteResource:function(r,t){l&&(C++,console.log("counter_deleteResource "+C));var o={};e.existResource(r,function(e){return e?void osapi.documents.delete({contextId:r}).execute(function(e){return e?e.error?(o={error:"The resource couldn't be removed.",log:e.error},t(o)):t(!0):(o={error:"The resource couldn't be removed."},t(o))}):(o={error:"The resource to be deleted is not available. The resource couldn't be removed."},t(o))})},existResource:function(e,r){l&&(P++,console.log("counter_existResource "+P));var t={};return e&&""!=e?void osapi.documents.get({contextId:e,size:"-1"}).execute(function(e){return r(e&&!e.error&&e.id?!0:!1)}):(t={error:"The resourceId cannot be empty. The resource couldn't be obtained."},r(t))},readResource:function(e,r){l&&(V++,console.log("counter_readResource "+V));var t={};return e&&""!=e?void osapi.documents.get({contextId:e,size:"-1"}).execute(function(e){return!e.error&&e.id?r(e):(t={error:"The resource is not available.",log:e.error},r(t))}):(t={error:"The resourceId cannot be empty. The resource couldn't be read."},r(t))},getMetadata:function(e,r){l&&(O++,console.log("counter_getMetadata "+O));var t={};return e&&""!=e?void osapi.documents.get({contextId:e,size:"-1"}).execute(function(e){return e.error?(t={error:"The resource is not available.",log:e.error},r(t)):e.metadata?r(JSON.parse(e.metadata)):(t={error:"The resource has no metadata."},r(t))}):(t={error:"The resourceId cannot be empty. The metadata couldn't be obtained."},r(t))},obtainMetadataFromAction:function(e,r,t){l&&(q++,console.log("counter_obtainMetadataFromAction "+q));var o="";return o=e?JSON.parse(e):{},r.actor&&(o.actor=r.actor),r.object&&(o.target={objectType:r.object.objectType,id:r.object.id,displayName:r.object.displayName}),r.generator&&(o.generator={objectType:r.generator.objectType,url:r.generator.url,id:r.generator.id,displayName:r.generator.displayName}),t&&(o.provider={url:t.profileUrl,id:t.id,displayName:t.displayName}),o},validateMetadata:function(e,r){if(!e)return r();var t={error:"The metadata is not valid. It cannot be parsed as a JSON object."};if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return r(t)}return"object"!=typeof e?r(t):r(null,e)},createResource:function(r,t,o,a){l&&(U++,console.log("counter_createResource "+U));var n={};return r?void e.getContextFromMetadata(o,function(){e.getUniqueName(r,function(r){e.validateMetadata(o,function(e,o){if(e)return a(e);var i={document:{parentType:u.storageType,parentSpaceId:u.storageId,mimeType:"txt",fileName:r,content:JSON.stringify(t),metadata:o}};osapi.documents.create(i).execute(function(e){return e&&!e.error&&e.id?a(e):(n={error:"The resource couldn't be created.",log:e.error},a(n))})})})}):(n={error:"The resourceName cannot be empty. The resource couldn't be created."},a(n))},getUniqueName:function(r,t){l&&(B++,console.log("counter_getUniqueName "+B)),e.getCurrentUser(function(e){var o=(new Date).getTime(),a=e+"_"+o+"_"+r;return t(a)})},getConfiguration:function(r){l&&(R++,console.log("counter_getConfiguration "+R));var t={};e.getApp(function(o){return o.metadata&&o.metadata.settings?void e.getIlsId(function(t){return r(e.getFixedConfiguration(o.id,o.displayName,o.appUrl,o.metadata.settings,u.provider.inquiryPhaseId,u.provider.inquiryPhase,u.provider.inquiryPhaseName))}):(t={error:"The configuration could not be obtained.",log:o.error||""},r(t))})},getAllConfigurations:function(r){l&&(F++,console.log("counter_getAllConfigurations "+F));var t=[];e.getIlsId(function(o){e.getAppsBySpaceId(o,function(a){a.error?(console.warn("retrieving the space's apps returned an error:"),console.warn(a.error)):_.each(a,function(r,o){if(r.metadata&&r.metadata.settings){var a=e.getFixedConfiguration(r.id,r.displayName,r.appUrl,r.metadata.settings,"undefined","undefined","undefined");a&&t.push(a)}}),e.getSubspacesBySpaceId(o,function(o){function a(r){var o=new $.Deferred;return e.getAppsBySpaceId(r.id,function(a){a.error?(console.warn("retrieving subspace apps for space "+r.id+" returned an error:"),console.warn(a.error)):_.each(a,function(o,a){if(o.metadata&&o.metadata.settings){var n=r.id,i=r.displayName,c="undefined";r.metadata&&r.metadata.type&&(c=r.metadata.type);var d=e.getFixedConfiguration(o.id,o.displayName,o.appUrl,o.metadata.settings,n,c,i);d&&t.push(d)}}),o.resolve()}),o.promise()}if(o.error)return console.warn("retrieving the subspaces returned an error:"),console.warn(o.error),r(t);var n=[];_.each(o,function(e,r){n.push(a(e))}),$.when.apply($,n).done(function(){return r(t)})})})})},getFixedConfiguration:function(e,r,t,o,a,n,i){try{var c,d="string"==typeof o?JSON.parse(o):o;try{c=JSON.parse(d.content)}catch(e){c=d.content}var s={metadata:{actor:d.actor||{},id:d.id||"",published:d.published||"",target:d.target||{}},content:c};return s.metadata.generator={displayName:r,id:e,objectType:"application",url:t},s.metadata.provider={displayName:u.provider.displayName,id:u.provider.id,inquiryPhase:n,inquiryPhaseId:a,inquiryPhaseName:i,objectType:u.provider.objectType,url:u.provider.url},s.metadata.storageId=u.storageId,s.metadata.storageType=u.storageType,s}catch(e){return console.warn("error during JSON-parsing of the following configuration:"),console.warn(o),void console.warn(e)}},setAppConfiguration:function(r,t,o){l&&(M++,console.log("counter_setAppConfiguration "+M));var a={};e.validateConfiguration(t,function(n){return!n||n.error?o(n.error):void e.getApp(function(e){if(!e||e.error)return o(e);var n={contextId:e.id,application:{metadata:e.metadata||{}}},i={actor:t.actor,id:t.id,published:t.published,target:t.target,content:"string"==typeof r?r:JSON.stringify(r)};n.application.metadata.settings=i,osapi.apps.update(n).execute(function(e){return e.error?(console.log("The app configuration couldn't saved: "),console.log(e),a={error:"The configuration couldn't be saved.",log:e.error},o(a)):(console.log("The app configuration has been saved: "),console.log(e),o(e))})})})},validateConfiguration:function(e,r){if(e&&e.actor&&e.id&&e.published&&e.target&&"object"==typeof e.actor&&"string"==typeof e.id&&"string"==typeof e.published&&"object"==typeof e.target)return r(!0);var t={error:"The metadata is not compliant."};return r(t)},updateResource:function(r,t,o,a){l&&(J++,console.log("counter_updateResource "+J));var n={};return r?void e.getContextFromMetadata(o,function(){var i=t?JSON.stringify(t):"";e.validateMetadata(o,function(e,t){if(e)return a(e);var o={contextId:r,document:{parentType:u.storageType,parentSpaceId:u.storageId,mimeType:"txt",fileName:t.target.displayName,content:i,metadata:t}};osapi.documents.update(o).execute(function(e){return e&&!e.error&&e.id?a(e):(n={error:"The resource couldn't be updated. Check if the resource exist and you have enough permits.",log:e.error},a(n))})})}):(n={error:"The resourceId cannot be null. The resource couldn't be updated."},a(n))},listFilesBySpaceId:function(e,r){l&&(L++,console.log("counter_listFilesBySpaceId "+L));var t={error:"The spaceId cannot be empty."};return e&&""!=e?void osapi.documents.get({contextId:e,contextType:"@space"}).execute(function(e){return r(e.list?e.list:t)}):r(t)},listVault:function(r){l&&(D++,console.log("counter_listVault "+D)),e.getVault(function(t){return t.error?r(t.error):void e.listFilesBySpaceId(t.id,function(e){return r(e)})})},listConfiguration:function(r){l&&(E++,console.log("counter_listConfiguration "+E)),e.getConfiguration(function(t){return t.error?r(t.error):void e.listFilesBySpaceId(t.id,function(e){return r(e)})})},listVaultNames:function(r){l&&(k++,console.log("counter_listVaultNames "+k));var t=[];e.listVault(function(e){if(e.error)return r(e.error);for(i=0;i<e.length;i++)t.push(e[i].displayName);return r(t)})},listConfigurationNames:function(r){l&&(G++,console.log("counter_listConfigurationNames "+G));var t=[];e.listConfiguration(function(e){if(e.error)return r(e.error);for(i=0;i<e.length;i++)t.push(e[i].displayName);return r(t)})},listVaultExtended:function(r){l&&(H++,console.log("counter_listVaultExtended "+H));var t={error:"No resource available in the Vault."};e.getVault(function(e){osapi.documents.get({contextId:e.id,contextType:"@space"}).execute(function(e){return r(e.list?e.list:t)})})},listVaultExtendedById:function(e,r){l&&(K++,console.log("counter_listVaultExtendedById "+K));var t={error:"No resource available in the Vault."};return e&&""!=e?void osapi.documents.get({contextId:e,contextType:"@space"}).execute(function(e){return r(e.list?e.list:t)}):(t={error:"The Vault identifier cannot be empty. The files could not be obtained"},r(t))},filterVault:function(e,r,t,o,a,n,i,c,d){l&&(z++,console.log("counter_filterVault "+z));var s={error:"No resource available in the Vault."};if(!e)return s={error:"The Vault identifier cannot be empty. The files could not be obtained"},d(s);var u={};r&&(u.creator=r),t&&(u["metadata.generator.id"]=t),o&&(u["metadata.target.objectType"]=o);var p={contextId:e,contextType:"@space"};return Object.keys(u).length>0&&(p.filters=u),a&&NaN!==Date.parse(a)&&(p.createdSince=a),n&&NaN!==Date.parse(n)&&(p.createdUntil=n),i&&NaN!==Date.parse(i)&&(p.modifiedSince=i),c&&NaN!==Date.parse(c)&&(p.modifiedUntil=c),p.filters||p.createdSince||p.createdUntil||p.modifiedSince||p.modifiedUntil?void osapi.documents.get(p).execute(function(e){return d(e.list?e.list:s)}):(s={error:"No filter has been provided"},d(s))},logAction:function(e,r,t,o,a,n,i){l&&(Q++,console.log("counter_logAction "+Q));var c={userId:"@viewer",groupId:"@self",published:(new Date).toISOString(),verb:n,activity:{}};c.activity.verb=n,c.activity.published=c.published,c.activity.object={id:e,objectType:r,displayName:t},c.activity.target={id:o,objectType:"Space",displayName:a},c.activity.generator=u.generator,c.activity.actor=u.actor,c.activity.provider=u.provider,osapi.activitystreams.create(c).execute(function(e){if(e.id&&!e.error)return i(e);var r={error:"The activity couldn't be logged.",log:e.error};return i(r)})},getAction:function(e,r,t){l&&(W++,console.log("counter_getAction "+W));var o,a={contextId:e,contextType:"@space",count:1,fields:"id,actor,verb,object,target,published,updated,generator",filterBy:"object.id",filterOp:"contains",filterValue:"assets/"+r.toString(),ext:!0};osapi.activitystreams.get(a).execute(function(e){return e.error?(o={error:"The activity couldn't be obtained.",log:e.error},t(o)):e.totalResults>0?t(e.list[0]):(o={error:"The activity couldn't be obtained."},t(o))})}},window.ils=e}).call(this);