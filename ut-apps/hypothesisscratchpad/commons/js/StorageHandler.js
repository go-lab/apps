(function(){"use strict";var e,t,r,o,n=function(e,t){return function(){return e.apply(t,arguments)}},a=function(e,t){function r(){this.constructor=e}for(var o in t)s.call(t,o)&&(e[o]=t[o]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},s={}.hasOwnProperty,i=[].slice;window.golab=window.golab||{},window.golab.ils=window.golab.ils||{},window.golab.ils.storage=window.golab.ils.storage||{},window.golab.ils.storage.memory=window.golab.ils.storage.memory||{},t={metadata:{},support:{}},window.golab.ils.storage.StorageHandler=function(){function e(e,t,r,o,a,s){var i;this._filterForResourceType=null==t||t,this._filterForUser=null==r||r,this._filterForProvider=null==o||o,this._customFilter=null!=a?a:null,this._filterForAppId=null==s||s,this.createResource=n(this.createResource,this),this.readLatestResource=n(this.readLatestResource,this),this.getResourceBundle=n(this.getResourceBundle,this),this.applyFilters=n(this.applyFilters,this),this.className="golab.ils.storage.StorageHandler",this._debug=!1,this._debug&&console.log("Initializing StorageHandler."),this._lastResourceId=void 0;try{e.getMetadata(),this.metadataHandler=e}catch(e){throw i=e,"StorageHandler needs a MetadataHandler at construction!"}this._isReadOnly=!1,this.checkWritePermission(),this._debug&&console.log("...StorageHandler is readOnly? -> "+this.isReadOnly())}return e.prototype.checkWritePermission=function(){this._isReadOnly=!1},e.prototype.isReadOnly=function(){return this._isReadOnly},e.prototype.setReadOnly=function(e){return this._isReadOnly=e},e.prototype.getDebugLabel=function(){return this.className+"("+this.metadataHandler.getTarget().objectType+")"},e.prototype.generateUUID=function(){return this.metadataHandler.generateUUID()},e.prototype.configureFilters=function(e,t,r,o){return null==o&&(o=!0),this._filterForResourceType=e,this._filterForUser=t,this._filterForProvider=r,this._filterForAppId=o},e.prototype.setForResourceTypeFilter=function(e){return this._filterForResourceType=e},e.prototype.getForResourceTypeFilter=function(){return this._filterForResourceType},e.prototype.setForUserFilter=function(e){return this._filterForUser=e},e.prototype.getForUserFilter=function(){return this._filterForUser},e.prototype.setForProviderFilter=function(e){return this._filterForProvider=e},e.prototype.getForProviderFilter=function(){return this._filterForProvider},e.prototype.setForAppIdFilter=function(e){return this._filterForAppId=e},e.prototype.getForAppIdFilter=function(){return this._filterForAppId},e.prototype.setCustomFilter=function(e){return this._customFilter=e},e.prototype.getCustomFilter=function(){return this._customFilter},e.prototype.getMetadataHandler=function(){return this.metadataHandler},e.prototype.storeImage=function(e,t){var r;try{return $.ajax({type:"POST",url:"http://localhost:8000/storeImage",data:e,contentType:"text/plain",crossDomain:!0,success:function(e,r,o){return t(void 0,e)},error:function(e,r,o){return console.warn("POST createResource failed, response:"),console.warn(e),t(e)}})}catch(e){return r=e,console.warn("Something went wrong when writing to Mongo:"),console.error(r),t(r)}},e.prototype.readImage=function(e,t){var r;try{return $.ajax({type:"GET",url:"http://localhost:8000/readimage/"+e,contentType:"text/plain",crossDomain:!0,success:function(e){return t(null,e)},error:function(e,r,o){return console.warn("GET readImage failed, response:"),console.warn(o),t(o)}})}catch(e){return r=e,console.warn("Something went wrong when retrieving the image:"),console.warn(r),cb(r)}},e.prototype.getResourceDescription=function(e){var t,r,o,n,a,s,i,l;return r=function(e){var t;return t="unknown, no "+e,{id:t,title:t,type:t,tool:t,author:t,modified:t}},e?e.metadata?(n=e.metadata,o=n.id?n.id:"",s=n.target&&n.target.displayName?n.target.displayName:"",l=n.target&&n.target.objectType?n.target.objectType:"",i=n.generator&&n.generator.displayName?n.generator.displayName:"",t=n.actor&&n.actor.displayName?n.actor.displayName:"",a=n.published?new Date(e.metadata.published):new Date,{id:o,title:s,type:l,tool:i,author:t,modified:a}):r("metadata"):r("resource")},e.prototype.applyFilters=function(e){return this._debug&&(console.log("StorageHandler.applyFilters:"),console.log("filter for type ("+this.metadataHandler.getTarget().objectType+"): "+this.getForResourceTypeFilter()+", user: "+this.getForUserFilter()+", appId: "+this.getForAppIdFilter()+", provider: "+this.getForProviderFilter()),console.log(e)),this.getForResourceTypeFilter()&&(e=e.filter(function(e){return function(t){return t.metadata.target.objectType===e.metadataHandler.getTarget().objectType}}(this))),this.getForProviderFilter()&&(e=e.filter(function(e){return function(t){return t.metadata.provider.id===e.metadataHandler.getProvider().id}}(this))),this.getForUserFilter()&&(e=null!=this.metadataHandler.getMetadata().contextualActor?e.filter(function(e){return function(t){return t.metadata.actor.displayName===e.metadataHandler.getMetadata().contextualActor.displayName}}(this)):e.filter(function(e){return function(t){return t.metadata.actor.displayName===e.metadataHandler.getActor().displayName}}(this))),this.getForAppIdFilter()&&(e=e.filter(function(e){return function(t){return t.metadata.generator.id===e.metadataHandler.getGenerator().id}}(this))),this.getCustomFilter()&&(e=e.filter(function(e){return function(t){return e.getCustomFilter()(t.metadata)}}(this))),this._debug&&(console.log("after: "),console.log(e)),e},e.prototype.getResourceBundle=function(e,t){var r,o;return null==t&&(t=this.generateUUID()),o=JSON.parse(JSON.stringify(e)),r=JSON.parse(JSON.stringify(this.metadataHandler.getMetadata())),null!=r.contextualActor&&(r.actor=r.contextualActor,r.contextualActor=void 0),r.published=(new Date).toISOString(),r.id=t,{metadata:r,content:o}},e.prototype._findLatestResourceId=function(e,t){var r,o,n,a,s,i;for(this._debug&&console.log("_findLatestResourceId("+e+", "+t.length+")"),a=new Date(1970,0,1),s=void 0,n=0,i=t.length;n<i;n++)o=t[n],null!=e&&e!==o.metadata.target.objectType||null!=o.metadata.published&&(r=new Date(o.metadata.published),r>a&&(a=r,s=o.metadata.id));return s},e.prototype.readLatestResource=function(e,t){return this._debug&&console.log("StorageHandler: searching for latest resource of type '"+e+"'"),this.listResourceMetaDatas(function(r){return function(o,n){var a,s,i,l,u,c;if(null!=o)return setTimeout(function(){return this._debug&&console.log("StorageHandler: an error occured: "+o),t(o,void 0)},0);for(r._debug&&(console.log("StorageHandler: found resources:"),console.log(n)),l=new Date(1970,0,1),u=void 0,i=0,c=n.length;i<c;i++)s=n[i],null!=e&&e!==s.metadata.target.objectType||null!=s.metadata.published&&(a=new Date(s.metadata.published),a>l&&(l=a,u=s.metadata.id));return null!=u?(r._debug&&console.log("StorageHandler: now reading "+u),r.readResource(u,t)):setTimeout(function(){return t(null,null)},0)}}(this))},e.prototype.readResource=function(e,t){throw"Abstract function readResource - implement in subclass."},e.prototype.resourceExists=function(e,t){throw"Abstract function resourceExists - implement in subclass."},e.prototype.createResource=function(e,t){throw"Abstract function createResource - implement in subclass."},e.prototype.updateResource=function(e,t,r){throw"Abstract function updateResource - implement in subclass."},e.prototype.deleteResource=function(e,t){throw"Abstract function deleteResource - implement in subclass."},e.prototype.listResourceIds=function(e){throw"Abstract function listResourceIds - implement in subclass."},e.prototype.listResourceMetaDatas=function(e){throw"Abstract function listResourceMetaDatas - implement in subclass."},e}(),window.golab.ils.storage.ObjectStorageHandler=function(e){function t(e,r){if(this.createResource=n(this.createResource,this),this.storeImage=n(this.storeImage,this),t.__super__.constructor.apply(this,arguments),"object"!=typeof r)throw"you must pass on an object to store the resources";this.storeObject=r,this.imageStoreObject={},this._debug&&console.log("Initializing ObjectStorageHandler.")}return a(t,e),t.prototype.readResource=function(e,t){var r;return this.storeObject[e]?(this._debug&&console.log("MemoryStorage: readResource "+e),setTimeout(function(r){return function(){return t(null,JSON.parse(JSON.stringify(r.storeObject[e])))}}(this),0)):(r=new Error("MemoryStorage: readResource "+e+" not found."),this._debug&&console.log(r),setTimeout(function(){return t(r)},0))},t.prototype.readImage=function(e,t){var r;return this.imageStoreObject[e]?(this._debug&&console.log("MemoryStorage: readImage "+e),setTimeout(function(e){return function(){return t(null,e.imageStoreObject[resourceId])}}(this),0)):(r=new Error("MemoryStorage: readImage "+e+" not found."),this._debug&&console.log(r),setTimeout(function(){return t(r)},0))},t.prototype.storeImage=function(e,t){var r,o;if(this.isReadOnly())return void setTimeout(function(e){return function(){return cb("StorageHandler is readOnly, cannot create image.")}}(this),0);try{return o=this.generateUUID(),this.imageStoreObject[o]=e,this._debug&&console.log("MemoryStorage: image created: "+o),setTimeout(function(e){return function(){return t(null,o)}}(this),0)}catch(e){return r=e,r=new Error("MemoryStorage: image NOT created: "+r),this._debug&&console.log(r),setTimeout(function(e){return function(){return t(r)}}(this),0)}},t.prototype.resourceExists=function(e,t){var r;return r=void 0!==this.storeObject[e],t(null,r)},t.prototype.createResource=function(e,t){var r,o;if(this.isReadOnly())return void setTimeout(function(e){return function(){return t("StorageHandler is readOnly, cannot create resource.")}}(this),0);try{return o=this.getResourceBundle(e),this.storeObject[o.metadata.id]?(r=new Error("MemoryStorage: resource already exists! "+o.metadata.id),this._debug&&console.log(r),setTimeout(function(e){return function(){return t(r)}}(this),0)):(this.storeObject[o.metadata.id]=o,this._debug&&console.log("MemoryStorage: resource created: "+o),this._debug&&console.log(o),setTimeout(function(e){return function(){return t(null,o)}}(this),0))}catch(e){return r=e,r=new Error("MemoryStorage: resource NOT created: "+r),this._debug&&console.log(r),setTimeout(function(e){return function(){return t(r)}}(this),0)}},t.prototype.updateResource=function(e,t,r){var o,n;return this.isReadOnly()?void setTimeout(function(){return r("StorageHandler is readOnly, cannot create resource.")},0):this.storeObject[e]?(n=this.getResourceBundle(t,e),this.storeObject[e]=n,this._debug&&console.log("MemoryStorage: updateResource "+e),setTimeout(function(e){return function(){return r(null,n)}}(this),0)):(o=new Error("MemoryStorage: updateResource failed, resource doesn't exist: "+e),console.log(o),setTimeout(function(e){return function(){return r(o)}}(this),0))},t.prototype.listResourceIds=function(e){var t,r,o;return r=function(){var e,r;e=this.storeObject,r=[];for(t in e)o=e[t],r.push(t);return r}.call(this),setTimeout(function(t){return function(){return e(null,r)}}(this),0)},t.prototype.listResourceMetaDatas=function(e){var t,r,o,n;r=[],o=this.storeObject;for(t in o)n=o[t],r.push({id:t,metadata:JSON.parse(JSON.stringify(n.metadata))});return r=this.applyFilters(r),setTimeout(function(t){return function(){return e(null,r)}}(this),0)},t.prototype.deleteResource=function(e,t){var r;return r=this.storeObject[e]?(delete this.storeObject[e],null):new Error("Can't delete resource (id: "+e+" - doesn't exist."),setTimeout(function(e){return function(){return t(r)}}(this),0)},t}(window.golab.ils.storage.StorageHandler),window.golab.ils.storage.MemoryStorageHandler=function(e){function t(e,o){null==o&&(o=null),null===o&&(o=r),t.__super__.constructor.call(this,e,o),this.className="golab.ils.storage.MemoryStorageHandler",this._debug&&console.log("Initializing MemoryStorageHandler, debug: "+this._debug+".")}var r;return a(t,e),r={},t}(window.golab.ils.storage.ObjectStorageHandler),o="_goLab_",r="_goLabImages_",window.golab.ils.storage.LocalStorageHandler=function(e){function t(e){this.listAllResourcesForCaching=n(this.listAllResourcesForCaching,this),this.listResourceMetaDatas=n(this.listResourceMetaDatas,this),this.storeImage=n(this.storeImage,this),this.createResource=n(this.createResource,this),t.__super__.constructor.apply(this,arguments),this.className="golab.ils.storage.LocalStorageHandler",this._debug&&console.log("Initializing LocalStorageHandler."),this.localStorage=window.localStorage}return a(t,e),t.prototype.readImage=function(e,t){var o;return this.localStorage[r+e]?(this._debug&&console.log("LocalStorageHandler: readImage "+e),setTimeout(function(o){return function(){return o._debug&&console.log(o.localStorage[r+e]),t(null,o.localStorage[r+e])}}(this),0)):(o=new Error("LocalStorageHandler: readImage "+e+" not found."),this._debug&&console.log(o),setTimeout(function(){return t(o)},0))},t.prototype.readResource=function(e,t){var r;return this.localStorage[o+e]?(this._debug&&console.log("LocalStorageHandler: readResource "+e),setTimeout(function(r){return function(){return r._debug&&console.log(r.localStorage[o+e]),t(null,JSON.parse(r.localStorage[o+e]))}}(this),0)):(r=new Error("LocalStorageHandler: readResource "+e+" not found."),this._debug&&console.log(r),setTimeout(function(){return t(r)},0))},t.prototype.resourceExists=function(e,t){var r;return r=void 0!==this.localStorage[o+e],setTimeout(function(){return t(null,r)},0)},t.prototype.deleteResource=function(e,t){return this.isReadOnly()?void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0):null!=this.localStorage[o+e]?(delete this.localStorage[o+e],setTimeout(function(){return t(null)},0)):setTimeout(function(){return t(new Error("Can't delete resource - doesn't exist."))},0)},t.prototype.createResource=function(e,t){var r,n,a;if(this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);try{return n=this.getResourceBundle(e),a=n.metadata.id,this.localStorage[o+a]?(r=new Error("LocalStorageHandler: resource already exists! "+a),this._debug&&console.log(r),setTimeout(function(){return t(r)},0)):(this.localStorage[o+a]=JSON.stringify(n),this._debug&&console.log("LocalStorageHandler: resource created:"),this._debug&&console.log(n),setTimeout(function(){return t(null,n)},0))}catch(e){return r=e,r=new Error("LocalStorageHandler: resource NOT created: "+r),this._debug&&console.log(r),setTimeout(function(){return t(r)},0)}},t.prototype.storeImage=function(e,t){var o,n;if(this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create image.")},0);try{return n=this.generateUUID(),this.localStorage[r+n]=e,this._debug&&console.log("LocalStorageHandler: image created with id "+n),setTimeout(function(){return t(null,n)},0)}catch(e){return o=e,o=new Error("LocalStorageHandler: image NOT created: "+o),this._debug&&console.log(o),setTimeout(function(){return t(o)},0)}},t.prototype.updateResource=function(e,t,r){var n,a;return this.isReadOnly()?void setTimeout(function(){return r("StorageHandler is readOnly, cannot create resource.")},0):this.localStorage[o+e]?(a=this.getResourceBundle(t,e),this.localStorage[o+e]=JSON.stringify(a),this._debug&&console.log("LocalStorageHandler: updateResource "+e),setTimeout(function(){return r(null,a)},0)):(n=new Error("LocalStorageHandler: updateResource failed, resource doesn't exist: "+e),console.log(n),setTimeout(function(){return r(n)},0))},t.prototype.isGoLabKey=function(e){return 0===e.indexOf(o)},t.prototype.listResourceIds=function(e){var t,r,n,a;return a=function(e){return e.substr(o.length)},r=function(){var e,r;e=this.localStorage,r=[];for(t in e)n=e[t],this.isGoLabKey(t)&&r.push(a(t));return r}.call(this),setTimeout(function(){return e(null,r)},0)},t.prototype.listResourceMetaDatas=function(e){var t,r,o,n,a;r=[],o=this.localStorage;for(t in o)a=o[t],this.isGoLabKey(t)&&(n=JSON.parse(a),r.push({id:n.metadata.id,metadata:n.metadata}));return r=this.applyFilters(r),setTimeout(function(){return e(null,r)},0)},t.prototype.listAllResourcesForCaching=function(e){var t,r,o,n,a;r=[],o=this.localStorage;for(t in o)a=o[t],this.isGoLabKey(t)&&(n=JSON.parse(a),r.push({id:n.metadata.id,metadata:n.metadata}));return setTimeout(function(){return e(null,r)},0)},t}(window.golab.ils.storage.StorageHandler),window.golab.ils.storage.VaultStorageHandler=function(e){function t(e){if(this._listResourceMetaDatas=n(this._listResourceMetaDatas,this),this.createResource=n(this.createResource,this),this.setConfiguration=n(this.setConfiguration,this),t.__super__.constructor.apply(this,arguments),this.className="golab.ils.storage.VaultStorageHandler",this._debug&&console.log("Initializing VaultStorageHandler."),"undefined"==typeof ils||null===ils)throw"The ILS library needs to be present for the VaultStorageHandler";return this.configureFilters(!0,!0,!1),this}return a(t,e),t.prototype.getForUserFilter=function(){return"configuration"!==this.metadataHandler.getMetadata().target.objectType&&t.__super__.getForUserFilter.call(this)},t.prototype.readResource=function(e,t){var r;try{return"configuration"===this.metadataHandler.getMetadata().target.objectType?ils.getApp(function(r){return function(o){var n,a,s;return null!=o.metadata&&null!=o.metadata.settings?(n=ils.getFixedConfiguration(o.id,o.displayName,o.appUrl,o.metadata.settings,"undefined","undefined","undefined"),a=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(n),n=r.fixConfiguration(a,!0),t(null,n)):(s=new Error("VaultStorageHandler: readResource "+e+" not found."),t(s,void 0))}}(this)):ils.readResource(e,function(r){return function(o){var n,a;if(null!=o.error)return t(o.error);if(r._debug&&console.log("ils.readResource returns:"),r._debug&&console.log(o),a={},"object"==typeof o.metadata)a.metadata=o.metadata;else try{a.metadata=JSON.parse(o.metadata)}catch(e){return n=e,console.warn("Could not parse metadata when reading a resource:"),console.warn(o.metadata),void t(n)}if(a.metadata.id=e,"object"==typeof o.content)a.content=o.content;else try{a.content=JSON.parse(o.content)}catch(e){return n=e,console.warn("Could not parse content when reading a resource:"),console.warn(o.content),void t(n)}return r.metadataHandler.setId(a.metadata.id),r.metadataHandler.setTarget(a.metadata.target),a.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(a.content),t(null,a)}}(this))}catch(o){return r=o,console.warn("Something went wrong when trying to load resource "+e+" from the vault:"),console.warn(r),t(r)}},t.prototype.resourceExists=function(e,t){var r;try{return ils.existResource(e,function(e){return function(e){return null!=e.error?t(e.error):t(null,e)}}(this))}catch(e){return r=e,console.warn("Something went wrong when trying to call 'resourceExists' from the vault:"),console.warn(r),t(r)}},t.prototype.setConfiguration=function(e,t){var r;if(this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot set configuration.")},0);try{return r=this.getResourceBundle(e),r.metadata.id=r.metadata.generator.id+"_configuration",this.metadataHandler.setId(r.metadata.id),this._debug&&console.log("Setting configuration resource in Vault:"),this._debug&&console.log(r),ils.setAppConfiguration(r.content,r.metadata,function(e){return function(o){return e._debug&&console.log("ils.createConfigurationFile returns:"),null!=o.error?(e._debug&&console.log(o.error),t(o.error)):(e._debug&&console.log(o),r.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(r.content),t(null,r))}}(this))}catch(e){return console.warn("Something went wrong when trying to create a configuration in the vault:"),console.warn(error),t(error)}},t.prototype.createResource=function(e,t){var r,o,n,a;if(r=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(e),this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);if(this._debug&&console.log("VaultStorageHandler.createResource called."),this._debug&&console.log("... for type: "+this.metadataHandler.getMetadata().target.objectType),"configuration"===this.metadataHandler.getMetadata().target.objectType)return this.setConfiguration(r,t);try{return this._debug&&console.log("Creating a new standard resource in Vault."),n=this.getResourceBundle(r),a=n.metadata.target.displayName,n.metadata.id=void 0,ils.createResource(a,n.content,n.metadata,function(e){return function(r){var o,a;if(e._debug&&console.log("ils.createResource returns:"),e._debug&&console.log(r),null!=r.error)return t(r.error);if(a={},a.content=n.content,"object"==typeof r.metadata)a.metadata=r.metadata;else try{a.metadata=JSON.parse(r.metadata)}catch(e){return o=e,console.warn("Something went wrong when trying to parse the returned resource's metadata:"),console.warn(n.metadata),void t(o)}return a.metadata.id=r.id,e.metadataHandler.setId(a.id),a.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(a.content),t(null,a)}}(this))}catch(e){return o=e,console.warn("Something went wrong when trying to create a resource in the vault:"),console.warn(o),t(o)}},t.prototype.updateResource=function(e,t,r){var o,n,a,s,i;if(o=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(t),this.isReadOnly())return void setTimeout(function(){return r("StorageHandler is readOnly, cannot create resource.")},0);if(this._debug&&console.log("VaultStorageHandler.updateResource called."),this._debug&&console.log("... for type: "+this.metadataHandler.getMetadata().target.objectType),"configuration"===this.metadataHandler.getMetadata().target.objectType)return this.setConfiguration(o,r);try{return a=this.getResourceBundle(o),s=a.content,i=a.metadata,i.id=e,ils.updateResource(e,s,i,function(e){return function(t){var o,n;if(e._debug&&console.log("ils.updateResource returns:"),e._debug&&console.log(t),null!=t.error)return console.error("error for updating"),console.error(JSON.stringify(t)),r(t.error);if(n={},n.content=s,"object"==typeof t.metadata)n.metadata=t.metadata;else try{n.metadata=JSON.parse(t.metadata)}catch(e){o=e,console.error("Something went wrong when trying to parse the returned resource's metadata:"),console.error(t.metadata),r(o)}return e.metadataHandler.setId(n.metadata.id),n.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(n.content),r(null,n)}}(this))}catch(t){return n=t,console.warn("Something went wrong when trying to update resource "+e+" in the vault:"),console.warn(n),r(n)}},t.prototype.deleteResource=function(e,t){return this.isReadOnly()?void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0):void t("delete of vault resources is not yet implemented")},t.prototype.listResourceIds=function(e){return this.listResourceMetaDatas(function(t){return function(t,r){var o;return null!=t?e(t,null):(o=r.map(function(e){return e.id}),e(null,o))}}(this))},t.prototype.listConfigurationMetaDatas=function(e,t){var r;return r=[],this._filterForResourceType&&this.metadataHandler.getMetadata().target.objectType===!1?t(null,r):this._filterForAppId&&!e?ils.getApp(function(o){return function(n){var a;return null!=n.metadata&&null!=n.metadata.settings?(a=ils.getFixedConfiguration(n.id,n.displayName,n.appUrl,n.metadata.settings,"undefined","undefined","undefined"),a.id=a.metadata.id,a.content&&(a.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(a.content)),r.push(o.fixConfiguration(a,e))):(console.warn("Couldn't read the configuration, maybe this app doesn't have any (yet). This is what I got back from ils.getApp(...):"),console.warn(n)),t(null,r)}}(this)):ils.getAllConfigurations(function(o){return function(n){var a,s,i;if(null!=n.error)return console.warn("Couldn't read the configurations of all apps, this is what I got back from ils.getAllConfigurations(...):"),console.warn(n),t(null,r);for(o._debug&&(console.log("ils.getAllConfigurations(...) returned:"),console.log(n)),s=0,i=n.length;s<i;s++)a=n[s],a.content&&(a.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(a.content)),a.id=a.metadata.id,r.push(o.fixConfiguration(a,e));return t(null,r)}}(this))},t.prototype.fixConfiguration=function(e,t){return null==t&&(t=!1),null!=e.metadata?e.metadata.id=e.metadata.generator.id+"_configuration":(console.warn("Couldn't find any metadata in this configuration:"),console.warn(e)),t||(null!=e.content?delete e.content:(console.warn("Couldn't find any content in this configuration:"),console.warn(e))),e},t.prototype._listResourceMetaDatas=function(e,t){var r;return r=[],this.listConfigurationMetaDatas(e,function(o){return function(n,a){var s,i,l,u;for(l=0,u=a.length;l<u;l++)s=a[l],r.push(s);try{return i={},i.vaultId=o.metadataHandler.getMetadata().storageId,o._filterForUser?null!=o.metadataHandler.getMetadata().contextualActor?i.userId=o.metadataHandler.getMetadata().contextualActor.id:i.userId=o.metadataHandler.getMetadata().actor.id:i.userId="",o._filterForAppId&&!e?i.appId=o.metadataHandler.getMetadata().generator.id:i.appId="",o._filterForResourceType&&!e?i.objectType=o.metadataHandler.getMetadata().target.objectType:i.objectType="",i.creationDateFrom="197380800",i.creationDateTo="",i.lastModificationDateFrom="",i.lastModificationDateTo="",ils.filterVault(i.vaultId,i.userId,i.appId,i.objectType,i.creationDateFrom,i.creationDateTo,i.lastModificationDateFrom,i.lastModificationDateTo,function(a){var s,i,l,u;if(o._debug&&console.log("ils.filterVault returns:"),o._debug&&console.log(a),null!=a.error)return"No resource available in the Vault."===a.error?t(null,[]):t(a.error);for(i=0,l=a.length;i<l;i++){u=a[i];try{s={},u.metadata&&(s.id=u.id,"object"==typeof u.metadata?s.metadata=u.metadata:s.metadata=JSON.parse(u.metadata),null!=s.metadata&&null!=s.metadata.target&&(s.metadata.id=u.id,e&&u.content&&(s.content=JSON.parse(u.content)),r.push(s)))}catch(e){n=e,console.warn("Caught an error when parsing metadata from Vault:"),console.warn(n)}}return e||(r=o.applyFilters(r)),t(null,r)})}catch(e){return n=e,console.warn("Something went wrong when trying to list the resources in the vault:"),console.warn(n),t(n)}}}(this))},t.prototype.listResourceMetaDatas=function(e){return this._listResourceMetaDatas(!1,e)},t.prototype.listAllResourcesForCaching=function(e){return this._listResourceMetaDatas(!0,e)},t}(window.golab.ils.storage.StorageHandler),window.golab.ils.storage.MongoStorageHandler=function(e){function t(e,r){this.urlPrefix=r,this.listResourceMetaDatas=n(this.listResourceMetaDatas,this),this.createResource=n(this.createResource,this),t.__super__.constructor.call(this,e,!0,!0,!0),this.className="golab.ils.storage.MongoStorageHandler",null!=this.urlPrefix?this._debug&&console.log("Initializing MongoStorageHandler."):console.error("I need an urlPrefix as second parameter.")}return a(t,e),t.prototype.readResource=function(e,t){var r;try{return $.ajax({type:"GET",url:this.urlPrefix+"/readResource/"+e,contentType:"text/plain",crossDomain:!0,success:function(e){return this._debug&&(console.log("GET readResource success, response:"),console.log(e)),e.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(e.content),t(null,e)},error:function(e,r,o){return console.warn("GET readResource failed, response:"),console.warn(o),t(o)}})}catch(e){return r=e,console.warn("Something went wrong when retrieving the resource:"),console.warn(r),t(r)}},t.prototype.deleteResource=function(e,t){var r;if(this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);try{return $.ajax({type:"POST",url:this.urlPrefix+"/deleteResource/"+e,crossDomain:!0,success:function(e){return this._debug&&(console.log("POST deleteResource success, response:"),console.log(e)),t(null)},error:function(e,r,o){return console.warn("POST deleteResource failed, response:"),console.warn(o),t(o)}})}catch(e){return r=e,console.warn("Something went wrong when deleting the resource:"),console.warn(r),t(r)}},t.prototype.resourceExists=function(e,t){var r;try{return $.ajax({type:"GET",url:this.urlPrefix+"/resourceExists/"+e,crossDomain:!0,contentType:"text/plain",success:function(e){return this._debug&&(console.log("GET resourceExists success, response:"),console.log(e)),t(void 0,!0)},error:function(e,r,o){return console.warn("GET resourceExists failed, response:"),console.warn(e),500===e.status?t(o):410===e.status?t(void 0,!1):void 0}})}catch(e){return r=e,console.warn("Something went wrong when retrieving the resource:"),console.warn(r),t(r)}},t.prototype.createResource=function(e,t){var r,o,n;if(r=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(e),this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);try{return n=this.getResourceBundle(r),n._id=n.metadata.id,$.ajax({type:"POST",url:this.urlPrefix+"/storeResource",data:JSON.stringify(n),contentType:"text/plain",crossDomain:!0,success:function(e,r,o){return this._debug&&(console.log("POST createResource success, response:"),console.log(e)),delete n._id,n.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(n.content),t(void 0,n)},error:function(e,r,o){return console.warn("POST createResource failed, response:"),console.warn(e),t(e)}})}catch(e){return o=e,console.log("Something went wrong when writing to Mongo:"),console.error(o),t(o)}},t.prototype.updateResource=function(e,t,r){var o,n,a;if(o=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(t),this.isReadOnly())return void setTimeout(function(){return r("StorageHandler is readOnly, cannot create resource.")},0);try{return a=this.getResourceBundle(o,e),a._id=a.metadata.id,$.ajax({type:"POST",url:this.urlPrefix+"/updateResource",data:JSON.stringify(a),contentType:"text/plain",crossDomain:!0,success:function(e,t,o){return this._debug&&(console.log("POST updateResource success, response:"),console.log(e)),delete a._id,a.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(a.content),r(null,a)},error:function(e,t,o){return console.warn("POST updateResource failed, response:"),console.warn(e),r(e)}})}catch(e){return n=e,console.log("Something went wrong when updating to Mongo:"),console.error(n),r(n)}},t.prototype.listResourceIds=function(e){return this.listResourceMetaDatas(function(t){return function(t,r){var o;return null!=t?e(t,null):(o=r.map(function(e){return e.id}),e(null,o))}}(this))},t.prototype.listResourceMetaDatas=function(e){var t;try{return $.support.cors=!0,$.ajax({type:"GET",crossDomain:!0,contentType:"text/plain",url:this.urlPrefix+"/listResourceMetaDatas",success:function(t){return function(r){return t._debug&&(console.log("GET listResourceMetaDatas success, response (before filters):"),console.log(r)),r=t.applyFilters(r),e(void 0,r)}}(this),error:function(t,r,o){return console.warn("GET listResourceMetaDatas failed, response:"),console.warn(JSON.stringify(t)),e(t)}})}catch(r){return t=r,console.warn("Something went wrong when retrieving the metedatas:"),console.warn(t),e(t)}},t.prototype.listResourceIds=function(e){throw"Not yet implemented."},t}(window.golab.ils.storage.StorageHandler),window.golab.ils.storage.MongoIISStorageHandler=function(e){function t(e,r){this.urlPrefix=r,this.listAllResourcesForCaching=n(this.listAllResourcesForCaching,this),this.listResourceMetaDatas=n(this.listResourceMetaDatas,this),this._listResourceMetaDatas=n(this._listResourceMetaDatas,this),this.createResource=n(this.createResource,this),t.__super__.constructor.call(this,e,!0,!0,!0),this.className="golab.ils.storage.MongoIISStorageHandler",null!=this.urlPrefix?this._debug&&console.log("Initializing MongoIISStorageHandler."):console.error("I need an urlPrefix as second parameter.")}return a(t,e),t.prototype.createResource=function(e,t){var r,o,n;if(r=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(e),this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);try{
return n=this.getResourceBundle(r),n._id=n.metadata.id,$.ajax({type:"POST",url:this.urlPrefix+"/storeResource.js",contentType:"text/plain",data:JSON.stringify(n),crossDomain:!0,success:function(e,r,o){return this._debug&&(console.log("POST createResource success, response:"),console.log(e)),delete n._id,n.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(n.content),t(void 0,n)},error:function(e,r,o){return console.warn("POST createResource failed, response:"),console.warn(e),t(e)}})}catch(e){return o=e,console.log("Something went wrong when writing to Mongo:"),console.error(o),t(o)}},t.prototype.updateResource=function(e,t,r,o){var n,a,s;if(null==o&&(o=!0),n=window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson(t),this.isReadOnly())return void setTimeout(function(){return r("StorageHandler is readOnly, cannot create resource.")},0);try{return s=this.getResourceBundle(n,e),s._id=s.metadata.id,$.ajax({async:o,type:"POST",url:this.urlPrefix+"/updateResource.js",data:JSON.stringify(s),crossDomain:!0,success:function(e,t,o){return this._debug&&(console.log("POST updateResource success, response:"),console.log(e),console.log(t),console.log(o)),delete s._id,s.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(s.content),r(null,s)},error:function(e,t,o){return console.warn("POST updateResource failed, response:"),console.warn(e),r(e)}})}catch(e){return a=e,console.log("Something went wrong when updating to Mongo:"),console.error(a),r(a)}},t.prototype.listResourceIds=function(e){return this.listResourceMetaDatas(function(t){return function(t,r){var o;return null!=t?e(t,null):(o=r.map(function(e){return e.id}),e(null,o))}}(this))},t.prototype._listResourceMetaDatas=function(e,t,r){var o,n;try{return n="/listMetadatas.js",null!=e&&(n=n+"?"+e),$.ajax({type:"GET",crossDomain:!0,contentType:"text/plain",url:this.urlPrefix+n,success:function(e){return function(o){var n;return e._debug&&(console.log("GET listResourceMetaDatas success, response (before filters):"),console.log(o)),n=t?e.applyFilters(o):o,r(void 0,n)}}(this),error:function(e,t,o){return console.warn("GET listResourceMetaDatas failed, response:"),console.warn(JSON.stringify(e)),r(e)}})}catch(e){return o=e,console.warn("Something went wrong when retrieving the metedatas:"),console.warn(o),r(o)}},t.prototype.listResourceMetaDatas=function(e){var t;return t="",this._filterForProvider&&(t="providerId="+this.metadataHandler.getProvider().id),this._filterForUser&&(null!=t&&(t+="&"),t+="actorId="+this.metadataHandler.getActor().id),this._listResourceMetaDatas(t,!0,e)},t.prototype.listAllResourcesForCaching=function(e){var t;return t="",this._filterForProvider&&(t="providerId="+this.metadataHandler.getProvider().id),this._listResourceMetaDatas(t,!1,e)},t.prototype.readResource=function(e,t){var r;try{return $.ajax({type:"GET",url:this.urlPrefix+"/readResource.js?id="+e,crossDomain:!0,success:function(e){return this._debug&&(console.log("GET readResource success, response:"),console.log(e)),delete e._id,e.content=window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson(e.content),t(null,e)},error:function(e,r,o){return console.warn("GET readResource failed, response:"),console.warn(o),t(o)}})}catch(e){return r=e,console.warn("Something went wrong when retrieving the resource:"),console.warn(r),t(r)}},t.prototype.deleteResource=function(e,t){var r;if(this.isReadOnly())return void setTimeout(function(){return t("StorageHandler is readOnly, cannot create resource.")},0);try{return $.ajax({type:"POST",url:this.urlPrefix+"/deleteResource.js?id="+e,crossDomain:!0,success:function(e){return this._debug&&(console.log("POST deleteResource success, response:"),console.log(e)),t(null)},error:function(e,r,o){return console.warn("POST deleteResource failed, response:"),console.warn(o),t(o)}})}catch(e){return r=e,console.warn("Something went wrong when deleting the resource:"),console.warn(r),t(r)}},t.prototype.resourceExists=function(e,t){var r;try{return $.ajax({type:"GET",url:this.urlPrefix+"/resourceExists.js?id="+e,crossDomain:!0,success:function(e){return this._debug&&(console.log("GET resourceExists success, response:"),console.log(e)),t(void 0,!0)},error:function(e,r,o){return console.warn("GET resourceExists failed, response:"),console.warn(e),500===e.status?t(o):410===e.status?t(void 0,!1):void 0}})}catch(e){return r=e,console.warn("Something went wrong when retrieving the resource:"),console.warn(r),t(r)}},t}(window.golab.ils.storage.StorageHandler),window.golab.ils.storage.utils=window.golab.ils.storage.utils||{},e=function(){function e(e,t,r){this.errors=e,this.languageHandler=t,this.logError=r}return e.prototype.reportError=function(e,t){return t||(t=e),this.logError&&console.error(t),this.errors.push({display:e,message:t})},e.prototype.reportErrorKey=function(){var e,t,r,o;return t=arguments[0],r=2<=arguments.length?i.call(arguments,1):[],e=this.languageHandler?(o=this.languageHandler).getMessage.apply(o,[t].concat(i.call(r))):t,this.reportError(e)},e}(),window.golab.ils.storage.utils.validateResourceJson=function(t,r,o,n){var a;return null==r&&(r=null),null==o&&(o=!0),null==n&&(n=[]),a=new e(n,r,o),"object"!=typeof t&&a.reportErrorKey("resourceJson.failure.noObject"),t.metadata||a.reportErrorKey("resourceJson.failure.noMetadata"),t.content||a.reportErrorKey("resourceJson.failure.noContent"),n},window.golab.ils.storage.utils.validateResourceJsonArray=function(t,r,o,n){var a,s,i,l;if(null==r&&(r=null),null==o&&(o=!0),null==n&&(n=[]),a=new e(n,r,o),Array.isArray(t))for(s=0,i=t.length;s<i;s++)l=t[s],window.golab.ils.storage.utils.validateResourceJson(l,r,o,n);else a.reportErrorKey("resourceJson.failure.noArray");return n},window.golab.ils.storage.utils.importResourceJson=function(e,t,r,o){var n,a,s;a=JSON.stringify(e.getMetadataHandler().getMetadata()),s="",t&&t.metadata.target&&t.metadata.target.displayName&&(s=t.metadata.target.displayName),e.getMetadataHandler().setMetadata(t.metadata);try{return e.createResource(t.content,function(t,n){var i;try{return e.getMetadataHandler().setMetadata(JSON.parse(a)),t?o({display:r.getMessage("resourceImport.failure.createResource",s,t),message:"Failed to create resource (name="+s+"): "+JSON.stringify(t)}):o(null,n.metadata.id)}catch(e){return i=e,o({display:r.getMessage("resourceImport.failure.createResource.inCallback.unexpected",s,i),message:"Unexpected error in callback of create resource (name="+s+"): "+JSON.stringify(i)})}})}catch(t){return n=t,e.getMetadataHandler().setMetadata(JSON.parse(a)),o({display:r.getMessage("resourceImport.failure.createResource.unexpected",s,n),message:"Unexpected error during resource import (name="+s+"): "+JSON.stringify(n)})}},window.golab.ils.storage.utils.importResourceJsonArray=function(e,t,r,o,n){var a,s,i,l,u,c,d,g,p,h,f,m;l=[],f=[],a={},g=function(e){return e.metadata.target&&e.metadata.target.id?e.metadata.target.id:null},m=function(e){var t,r,o,n,s;for(n=[],t=0,r=e.length;t<r;t++)o=e[t],s=g(o),s?n.push(a[s]=o):n.push(void 0);return n},d=function(e){var t;return t=g(e),t?a[t]:null},h=t,c=function(){return n(l,f)},p=function(){var t,n,a;return h.length?(a=h.pop(),t=d(a),!t||r?(n=function(){return window.golab.ils.storage.utils.importResourceJson(e,a,o,function(e,t){return e?l.push(e):f.push(t),p()})},t?e.deleteResource(t.metadata.id,function(e){var t;return e?(t="",a&&a.metadata.target&&a.metadata.target.displayName&&(t=a.metadata.target.displayName),l.push({display:o.getMessage("resourceImport.failure.deleteResource",t,e),message:"Failed to delete resource (name="+t+"): "+JSON.stringify(e)}),p()):n()}):n()):p()):c()},i=e.getForResourceTypeFilter(),s=e.getForProviderFilter(),e.setForResourceTypeFilter(!1),e.setForProviderFilter(!1);try{return e.listResourceMetaDatas(function(t,r){return e.setForResourceTypeFilter(i),e.setForProviderFilter(s),t?(l.push({display:o.getMessage("resourceImport.failure.listResourceMetaDatas",t),message:"Failed to load list of resource metadatas: "+JSON.stringify(t)}),c()):(m(r),p())})}catch(t){return u=t,e.setForResourceTypeFilter(i),l.push({display:o.getMessage("resourceImport.failure.listResourceMetaDatas.unexpected",u),message:"Unexpected error during load list of resource metadatas: "+JSON.stringify(u)}),c()}},window.golab.ils.storage.utils.importFromUrl=function(e,t,r,o,n){var a;try{return $.ajax({async:!0,type:"GET",url:t,crossDomain:!0,success:function(t,a,s){var i,l;return i=t,l=window.golab.ils.storage.utils.validateResourceJsonArray(i,o),0===l.length?window.golab.ils.storage.utils.importResourceJsonArray(e,i,r,o,n):n(l,[])},error:function(e,r,a){return n([{display:o.getMessage("resourceImport.failure.loadJson",t,a),message:"Failed to load json from "+t+": "+JSON.stringify(a)}])}})}catch(e){return a=e,n([{display:o.getMessage("resourceImport.failure.loadJson.unexpected",t,a),message:"Unexpected error during load json from "+t+": "+JSON.stringify(a)}])}},window.golab.ils.storage.utils.simpleImportFromUrl=function(e,t,r,o,n){return window.golab.ils.storage.utils.importFromUrl(e,t,r,o,function(e,t){var r,o,a;for(o=0,a=e.length;o<a;o++)r=e[o],console.error(r.message);return t&&console.log("loaded "+t.length+" resources"),n()})},window.golab.ils.storage.utils.loadPreviewResources=function(e,t,r,o,n,a){return null==a&&(a=!0),a&&e.getContext()===window.golab.ils.context.preview?window.golab.ils.storage.utils.simpleImportFromUrl(t,o,!1,r,n):n()},window.golab.ils.storage.utils.specialChars=[{char:".",encodeRegExp:/\./g,decodeRegExp:/\\u002E/g,encodedChar:"\\u002E"},{char:"$",encodeRegExp:/\$/g,decodeRegExp:/\\u0024/g,encodedChar:"\\u0024"}],window.golab.ils.storage.utils.encodeSpecialJsonKeyChars=function(e){var t,r,o,n,a;for(t=e,a=window.golab.ils.storage.utils.specialChars,o=0,n=a.length;o<n;o++)r=a[o],t=t.replace(r.encodeRegExp,r.encodedChar);return t},window.golab.ils.storage.utils.decodeSpecialJsonKeyChars=function(e){var t,r,o,n,a;for(t=e,a=window.golab.ils.storage.utils.specialChars,o=0,n=a.length;o<n;o++)r=a[o],t=t.replace(r.decodeRegExp,r.char);return t},window.golab.ils.storage.utils.codeSpecialKeyCharsInJson=function(e,t){var r,o,n;if(r=e,null!==e&&void 0!==e&&"object"==typeof e){r=Array.isArray(e)?[]:{};for(o in e)n="string"==typeof o?t(o):o,r[n]=window.golab.ils.storage.utils.codeSpecialKeyCharsInJson(e[o],t)}return r},window.golab.ils.storage.utils.encodeSpecialKeyCharsInJson=function(e){return window.golab.ils.storage.utils.codeSpecialKeyCharsInJson(e,window.golab.ils.storage.utils.encodeSpecialJsonKeyChars)},window.golab.ils.storage.utils.decodeSpecialKeyCharsInJson=function(e){return window.golab.ils.storage.utils.codeSpecialKeyCharsInJson(e,window.golab.ils.storage.utils.decodeSpecialJsonKeyChars)}}).call(this);
//# sourceMappingURL=StorageHandler.js.map
