(function(){"use strict";var o,e=function(o,e){return function(){return o.apply(e,arguments)}},t=[].slice;null==window.ut&&(window.ut={}),null==(o=window.ut).commons&&(o.commons={}),window.ut.commons.actionlogging=window.ut.commons.actionlogging||{},window.ut.commons.actionlogging.LoggingModelVerifier=function(){function o(){var o,n,r,i;r=arguments[0],n=2<=arguments.length?t.call(arguments,1):[],this.logAction=e(this.logAction,this),this.showVerifyError=e(this.showVerifyError,this),o=r.getActionLogger(),i=r.createNewModel(),i.isVerifyModel=!0,this._errorHandler=null,this._mainModel=r,this._verifyModel=i,this._syncVerifyModel=!0,this._showJsonString=!0,this._lastMainModelJson="",this._collaborationInProgress=!1,!o instanceof window.ut.commons.actionlogging.ActionLogger&&console.error("actionLogger must be instance of window.ut.commons.actionlogging.ActionLogger"),!r instanceof window.ut.commons.ResourceEventEmitterModel&&console.error("mainModel must be instance of window.ut.commons.ResourceEventEmitterModel"),!i instanceof window.ut.commons.ResourceEventEmitterModel&&console.error("verifyModel must be instance of window.ut.commons.ResourceEventEmitterModel"),this._registerToActionLogger(o,!0),n&&n.map(function(o){return function(e){return o._registerToActionLogger(e,!0)}}(this)),this.areModelsEqual()?console.log("successful created LoggingModelVerifier for "+r.getDebugLabel()):(console.warn("problems with creating LoggingModelVerifier for "+r.getDebugLabel()),this.showVerifyError())}return o.prototype._registerToActionLogger=function(o,e){var t;return t=o instanceof window.ut.commons.actionlogging.ActionLoggerWrapper?o.actionLogger:o,t.addLogListener({logAction:function(o){return function(t){return o.logAction(t,e)}}(this)})},o.prototype.getVerifyModel=function(){return this._verifyModel},o.prototype.setErrorHandler=function(o){return this._errorHandler=o},o.prototype.setSyncVerifyModel=function(o){return this._syncVerifyModel=o},o.prototype.getSyncVerifyModel=function(){return this._syncVerifyModel},o.prototype.setShowJsonString=function(o){return this._showJsonString=o},o.prototype.getShowJsonString=function(){return this._showJsonString},o.prototype.areModelsEqual=function(){return this._mainModel.equals(this._verifyModel)},o.prototype.showVerifyError=function(o){var e,t,n,r,i,s,c,l,a,g,u;if(c=this._mainModel.getResource(),u=this._verifyModel.getResource(),s=JSON.stringify(c),g=JSON.stringify(u),l=JSON.stringify(c.metadata)!==JSON.stringify(u.metadata),e=JSON.stringify(c.content)!==JSON.stringify(u.content),a=function(o){return function(t,n){var r,i,s;if(i="",s=n,r="",l&&e||(l&&!e?(i="metadata",s=n.metadata):!l&&e&&(i="content",s=n.content)),o._showJsonString&&(r=JSON.stringify(s)),console.log(t+" model resource: "+i),console.log(s),r)return console.log(r)}}(this),t="The verify model is different from the main model after applying log action: ",t+=this._mainModel.getActionLogger().getShortActionLogDescription(o)+"!\n",t+="Parts that are different:",n="",l&&(n+=" metadata"),e&&(n+=" content"),console.warn(t+n),console.log("activity stream object:"),o?console.log(o):console.log("no activityStreamObject"),a("main",c,s),a("verify",u,g),this._showJsonString&&console.log("You can copy and compare the two resource strings on: http://nv.github.io/objectDiff.js/"),this._errorHandler)return r="Error syncing from log action:<br/>"+o.verb+" of "+o.object.objectType+"."+("<br/>There are differences in the"+n+"."),i={activityStreamObject:o,mainModelResource:c,verifyModelResource:u},this._errorHandler.reportError(r,r,i)},o.prototype.logAction=function(o,e){var t,n;if(null==e&&(e=!0),t=function(){switch(o.verb){case"access":case"start":case"cancel":case"send":case"receive":return!0;default:return!1}},n=function(o){return function(){return o._lastMainModelJson=JSON.stringify(o._mainModel.getResource())}}(this),!this._collaborationInProgress){if(!t())return e?(this._syncVerifyModel&&this._lastMainModelJson&&this._verifyModel.loadFromResource(JSON.parse(this._lastMainModelJson)),this._verifyModel.applyLogAction(o,function(e){return function(t){return t?(console.error("failed to apply activity stream object:"),console.log(o)):(n(),e.areModelsEqual()?console.log("Correctly updated the sync model for log action: "+e._mainModel.getActionLogger().getShortActionLogDescription(o)+"!"):e.showVerifyError(o))}}(this))):n();if("start"===o.verb&&o.object&&"collaboration"===o.object.objectType)return this._collaborationInProgress=!0}},o}()}).call(this);
//# sourceMappingURL=loggingModelVerifier.js.map
