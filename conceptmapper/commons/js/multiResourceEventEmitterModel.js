(function(){"use strict";var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function o(){this.constructor=e}for(var s in t)r.call(t,s)&&(e[s]=t[s]);return o.prototype=t.prototype,e.prototype=new o,e.__super__=t.prototype,e},r={}.hasOwnProperty,o=[].indexOf||function(e){for(var t=0,r=this.length;t<r;t++)if(t in this&&this[t]===e)return t;return-1};window.ut=window.ut||{},ut.commons=ut.commons||{},window.ut.commons.MultiResourceEventEmitterModel=function(r){function s(t,r,u){var n,i;if(this.singleResourceCreator=u,this.setIlsStructure=e(this.setIlsStructure,this),this.filterLatestMatadatas=e(this.filterLatestMatadatas,this),s.__super__.constructor.call(this,t,r[0]),"function"!=typeof this.singleResourceCreator)throw Error("singleResourceCreator must be a function");switch(this.storageHandler.setForAppIdFilter(!1),this._resourceTypesLabel=this.getResourceType(),r.length>1&&(i=function(e){var t;return t=e.target.objectType,o.call(r,t)>=0},this.storageHandler.setForResourceTypeFilter(!1),this.storageHandler.setCustomFilter(i),this._resourceTypesLabel="["+r.join(",")+"]"),this._resourceTypes=r,this._resources=[],this._orderedResources=[],this._ilsStructure=null,this._ilsStructureLoaded=!0,this._appsMap=null,n=this.storageHandler.getMetadataHandler(),n.getContext()){case window.golab.ils.context.graasp:case window.golab.ils.context.ils:this._ilsStructureLoaded=!1,n.getILSStructure(function(e){return function(t,r){return e._ilsStructureLoaded=!0,t?(console.warn("problems getting ILS structure: "+JSON.stringify(t)),e.emitEvent("ilsStructureChanged",r)):(e._debug&&(console.log("ILS structure:"),console.log(r)),e.setIlsStructure(r))}}(this))}}return t(s,r),s.prototype.createNewModel=function(){return new window.ut.commons.MultiResourceEventEmitterModel(this.environmentHandlers,this._resourceTypes,this.singleResourceCreator)},s.prototype.applyLogLoad=function(e,t,r){switch(t){case"resources":return this.reloadResources(e.object.content),r();default:return s.__super__.applyLogLoad.call(this,e,t,r)}},s.prototype.reloadResources=function(e){var t,r,o,s,u;for(t=0,r=e.length;t<r;t++)s=e[t],u=this.getResourceById(s.metadata.id),o=null!==u,null===u&&(u=this.singleResourceCreator(s.metadata),this._resources.push(u)),u.loadFromResource(s);return this.emitModelLoaded()},s.prototype.getDebugLabel=function(){return this._resourceTypesLabel+":"+this.getDisplayName()},s.prototype.createResource=function(e){throw Error("MultiResourceEventEmitterModel does not support writing")},s.prototype.updateResource=function(e){throw Error("MultiResourceEventEmitterModel does not support writing")},s.prototype.deleteResource=function(e){throw Error("MultiResourceEventEmitterModel does not support writing")},s.prototype.loadFromResourceContent=function(e){var t,r,o,u,n,i;if(s.__super__.loadFromResourceContent.call(this,e),n=[],e.resources)for(o=e.resources,t=0,r=o.length;t<r;t++)u=o[t],this.appExists(u.metadata)&&(i=this.singleResourceCreator(u.metadata),i.loadFromResource(u),n.push(i));return this._resources=n},s.prototype.filterLatestMatadatas=function(e){return e},s.prototype.loadLatestResource=function(e){var t;return t=function(t){return function(){return t.storageHandler.listResourceMetaDatas(function(r,o){var s,u,n,i,c,a,l,p;return r?void e(r,null):(u=function(){var e,t,r,s,u,n,i,c,a;for(s={},r=0,n=o.length;r<n;r++)e=o[r],i=e.metadata,t=i.generator.id,s[t]?(c=new Date(i.published),u=new Date(s[t].published),c>u&&(s[t]=i)):s[t]=i;a=[];for(t in s)i=s[t],a.push(i);return a},s=function(e){var r,o,s,u;for(u=[],r=0,o=e.length;r<o;r++)s=e[r],t.appExists(s)&&u.push(s);return u},l=[],a=[],n=function(e){var r,o,s;return r=t.getResourceById(e.id),r&&(s=new Date(e.published),o=new Date(r.getMetadata().published),s.getTime()<=o.getTime())?r:null},c=function(o){var s,u,i;return 0===o.length?(t._resources=l.slice(),p(),t.emitModelLoaded(),t.clearChanged(),e(r,l,a)):(s=o[0],i=n(s),i?(l.push(i),c(o.slice(1))):(u=s.id,i=t.singleResourceCreator(o[0]),i.loadFromResourceId(u,function(t){return t?e(t,null):(l.push(i),a.push(i),c(o.slice(1)))})))},p=function(){var e,r,o,s,u,n,i;if(s=t.getIlsStructure(),r=function(e){var r,o,s,u;for(s=t._resources,r=0,o=s.length;r<o;r++)if(u=s[r],u.getAppId()===e)return u;return null},e=function(e,o){var s,u,n,i,c;for(i=[],u=0,n=o.length;u<n;u++)s=o[u],c=r(s.id),c&&i.push(c);if(i.length)return t._orderedResources.push({phaseTitle:e,orderedResources:i})},t._orderedResources.length=0,null===s)t._orderedResources.push({phaseTitle:"",orderedResources:t._resources});else for(e("__tools__",s.apps),i=s.phases,o=0,u=i.length;o<u;o++)n=i[o],e(n.displayName,n.apps);if(t._debug)return console.log("@_orderedResources"),console.log(t._orderedResources)},i=u(),null!==t.getIlsStructure()&&(i=s(i)),i=t.filterLatestMatadatas(i),c(i))})}}(this),this._ilsStructureLoaded?t():this.addListener("ilsStructureChanged",function(e){return function(){return t()}}(this))},s.prototype.getResources=function(){return this._resources},s.prototype.getOrderedResources=function(){return this._orderedResources},s.prototype.getResourceById=function(e){var t,r,o,s;for(o=this._resources,t=0,r=o.length;t<r;t++)if(s=o[t],s.getId()===e)return s;return null},s.prototype.getResourceContent=function(){var e,t;return e=s.__super__.getResourceContent.call(this),e.resources=function(){var e,r,o,s;for(o=this._resources,s=[],e=0,r=o.length;e<r;e++)t=o[e],s.push(t.getResource());return s}.call(this),e},s.prototype.clearContent=function(){return this._resources.splice(0,this._resources.length),s.__super__.clearContent.call(this)},s.prototype.getIlsStructure=function(){return this._ilsStructure},s.prototype.setIlsStructure=function(e){var t;if(t=function(e){var t,r,o,s,u,n,i,c,a,l,p,d;for(r={},l=e.apps,o=0,n=l.length;o<n;o++)t=l[o],r[t.id]=t;for(p=e.phases,s=0,i=p.length;s<i;s++)for(a=p[s],d=a.apps,u=0,c=d.length;u<c;u++)t=d[u],r[t.id]=t;return r},this._ilsStructure!==e)try{return this._appsMap=t(e),this._ilsStructure=e}finally{this.emitEvent("ilsStructureChanged",e)}},s.prototype.isIlsStructureLoaded=function(){return this._ilsStructureLoaded},s.prototype.appExists=function(e){return null===this._appsMap||!!this._appsMap[e.generator.id]},s}(window.ut.commons.ResourceEventEmitterModel)}).call(this);
//# sourceMappingURL=multiResourceEventEmitterModel.js.map
